String.prototype.parseColor=function(){var color='#';if(this.slice(0,4)=='rgb('){var cols=this.slice(4,this.length-1).split(',');var i=0;do{color+=parseInt(cols[i]).toColorPart()}while(++i<3);}else{if(this.slice(0,1)=='#'){if(this.length==4)for(var i=1;i<4;i++)color+=(this.charAt(i)+this.charAt(i)).toLowerCase();if(this.length==7)color=this.toLowerCase();}}
return(color.length==7?color:(arguments[0]||this));};Element.collectTextNodes=function(element){return $A($(element).childNodes).collect(function(node){return(node.nodeType==3?node.nodeValue:(node.hasChildNodes()?Element.collectTextNodes(node):''));}).flatten().join('');};Element.collectTextNodesIgnoreClass=function(element,className){return $A($(element).childNodes).collect(function(node){return(node.nodeType==3?node.nodeValue:((node.hasChildNodes()&&!Element.hasClassName(node,className))?Element.collectTextNodesIgnoreClass(node,className):''));}).flatten().join('');};Element.setContentZoom=function(element,percent){element=$(element);element.setStyle({fontSize:(percent/100)+'em'});if(Prototype.Browser.WebKit)window.scrollBy(0,0);return element;};Element.getInlineOpacity=function(element){return $(element).style.opacity||'';};Element.forceRerendering=function(element){try{element=$(element);var n=document.createTextNode(' ');element.appendChild(n);element.removeChild(n);}catch(e){}};var Effect={_elementDoesNotExistError:{name:'ElementDoesNotExistError',message:'The specified DOM element does not exist, but is required for this effect to operate'},Transitions:{linear:Prototype.K,sinoidal:function(pos){return(-Math.cos(pos*Math.PI)/2)+.5;},reverse:function(pos){return 1-pos;},flicker:function(pos){var pos=((-Math.cos(pos*Math.PI)/4)+.75)+Math.random()/4;return pos>1?1:pos;},wobble:function(pos){return(-Math.cos(pos*Math.PI*(9*pos))/2)+.5;},pulse:function(pos,pulses){return(-Math.cos((pos*((pulses||5)-.5)*2)*Math.PI)/2)+.5;},spring:function(pos){return 1-(Math.cos(pos*4.5*Math.PI)*Math.exp(-pos*6));},none:function(pos){return 0;},full:function(pos){return 1;}},DefaultOptions:{duration:1.0,fps:100,sync:false,from:0.0,to:1.0,delay:0.0,queue:'parallel'},tagifyText:function(element){var tagifyStyle='position:relative';if(Prototype.Browser.IE)tagifyStyle+=';zoom:1';element=$(element);$A(element.childNodes).each(function(child){if(child.nodeType==3){child.nodeValue.toArray().each(function(character){element.insertBefore(new Element('span',{style:tagifyStyle}).update(character==' '?String.fromCharCode(160):character),child);});Element.remove(child);}});},multiple:function(element,effect){var elements;if(((typeof element=='object')||Object.isFunction(element))&&(element.length))
elements=element;else
elements=$(element).childNodes;var options=Object.extend({speed:0.1,delay:0.0},arguments[2]||{});var masterDelay=options.delay;$A(elements).each(function(element,index){new effect(element,Object.extend(options,{delay:index*options.speed+masterDelay}));});},PAIRS:{'slide':['SlideDown','SlideUp'],'blind':['BlindDown','BlindUp'],'appear':['Appear','Fade']},toggle:function(element,effect){element=$(element);effect=(effect||'appear').toLowerCase();var options=Object.extend({queue:{position:'end',scope:(element.id||'global'),limit:1}},arguments[2]||{});Effect[element.visible()?Effect.PAIRS[effect][1]:Effect.PAIRS[effect][0]](element,options);}};Effect.DefaultOptions.transition=Effect.Transitions.sinoidal;Effect.ScopedQueue=Class.create(Enumerable,{initialize:function(){this.effects=[];this.interval=null;},_each:function(iterator){this.effects._each(iterator);},add:function(effect){var timestamp=new Date().getTime();var position=Object.isString(effect.options.queue)?effect.options.queue:effect.options.queue.position;switch(position){case'front':this.effects.findAll(function(e){return e.state=='idle'}).each(function(e){e.startOn+=effect.finishOn;e.finishOn+=effect.finishOn;});break;case'with-last':timestamp=this.effects.pluck('startOn').max()||timestamp;break;case'end':timestamp=this.effects.pluck('finishOn').max()||timestamp;break;}
effect.startOn+=timestamp;effect.finishOn+=timestamp;if(!effect.options.queue.limit||(this.effects.length<effect.options.queue.limit))
this.effects.push(effect);if(!this.interval)
this.interval=setInterval(this.loop.bind(this),15);},remove:function(effect){this.effects=this.effects.reject(function(e){return e==effect});if(this.effects.length==0){clearInterval(this.interval);this.interval=null;}},loop:function(){var timePos=new Date().getTime();for(var i=0,len=this.effects.length;i<len;i++)
this.effects[i]&&this.effects[i].loop(timePos);}});Effect.Queues={instances:$H(),get:function(queueName){if(!Object.isString(queueName))return queueName;return this.instances.get(queueName)||this.instances.set(queueName,new Effect.ScopedQueue());}};Effect.Queue=Effect.Queues.get('global');Effect.Base=Class.create({position:null,start:function(options){function codeForEvent(options,eventName){return((options[eventName+'Internal']?'this.options.'+eventName+'Internal(this);':'')+
(options[eventName]?'this.options.'+eventName+'(this);':''));}
if(options&&options.transition===false)options.transition=Effect.Transitions.linear;this.options=Object.extend(Object.extend({},Effect.DefaultOptions),options||{});this.currentFrame=0;this.state='idle';this.startOn=this.options.delay*1000;this.finishOn=this.startOn+(this.options.duration*1000);this.fromToDelta=this.options.to-this.options.from;this.totalTime=this.finishOn-this.startOn;this.totalFrames=this.options.fps*this.options.duration;this.render=(function(){function dispatch(effect,eventName){if(effect.options[eventName+'Internal'])
effect.options[eventName+'Internal'](effect);if(effect.options[eventName])
effect.options[eventName](effect);}
return function(pos){if(this.state==="idle"){this.state="running";dispatch(this,'beforeSetup');if(this.setup)this.setup();dispatch(this,'afterSetup');}
if(this.state==="running"){pos=(this.options.transition(pos)*this.fromToDelta)+this.options.from;this.position=pos;dispatch(this,'beforeUpdate');if(this.update)this.update(pos);dispatch(this,'afterUpdate');}};})();this.event('beforeStart');if(!this.options.sync)
Effect.Queues.get(Object.isString(this.options.queue)?'global':this.options.queue.scope).add(this);},loop:function(timePos){if(timePos>=this.startOn){if(timePos>=this.finishOn){this.render(1.0);this.cancel();this.event('beforeFinish');if(this.finish)this.finish();this.event('afterFinish');return;}
var pos=(timePos-this.startOn)/this.totalTime,frame=(pos*this.totalFrames).round();if(frame>this.currentFrame){this.render(pos);this.currentFrame=frame;}}},cancel:function(){if(!this.options.sync)
Effect.Queues.get(Object.isString(this.options.queue)?'global':this.options.queue.scope).remove(this);this.state='finished';},event:function(eventName){if(this.options[eventName+'Internal'])this.options[eventName+'Internal'](this);if(this.options[eventName])this.options[eventName](this);},inspect:function(){var data=$H();for(property in this)
if(!Object.isFunction(this[property]))data.set(property,this[property]);return'#<Effect:'+data.inspect()+',options:'+$H(this.options).inspect()+'>';}});Effect.Parallel=Class.create(Effect.Base,{initialize:function(effects){this.effects=effects||[];this.start(arguments[1]);},update:function(position){this.effects.invoke('render',position);},finish:function(position){this.effects.each(function(effect){effect.render(1.0);effect.cancel();effect.event('beforeFinish');if(effect.finish)effect.finish(position);effect.event('afterFinish');});}});Effect.Tween=Class.create(Effect.Base,{initialize:function(object,from,to){object=Object.isString(object)?$(object):object;var args=$A(arguments),method=args.last(),options=args.length==5?args[3]:null;this.method=Object.isFunction(method)?method.bind(object):Object.isFunction(object[method])?object[method].bind(object):function(value){object[method]=value};this.start(Object.extend({from:from,to:to},options||{}));},update:function(position){this.method(position);}});Effect.Event=Class.create(Effect.Base,{initialize:function(){this.start(Object.extend({duration:0},arguments[0]||{}));},update:Prototype.emptyFunction});Effect.Opacity=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element)throw(Effect._elementDoesNotExistError);if(Prototype.Browser.IE&&(!this.element.currentStyle.hasLayout))
this.element.setStyle({zoom:1});var options=Object.extend({from:this.element.getOpacity()||0.0,to:1.0},arguments[1]||{});this.start(options);},update:function(position){this.element.setOpacity(position);}});Effect.Move=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element)throw(Effect._elementDoesNotExistError);var options=Object.extend({x:0,y:0,mode:'relative'},arguments[1]||{});this.start(options);},setup:function(){this.element.makePositioned();this.originalLeft=parseFloat(this.element.getStyle('left')||'0');this.originalTop=parseFloat(this.element.getStyle('top')||'0');if(this.options.mode=='absolute'){this.options.x=this.options.x-this.originalLeft;this.options.y=this.options.y-this.originalTop;}},update:function(position){this.element.setStyle({left:(this.options.x*position+this.originalLeft).round()+'px',top:(this.options.y*position+this.originalTop).round()+'px'});}});Effect.MoveBy=function(element,toTop,toLeft){return new Effect.Move(element,Object.extend({x:toLeft,y:toTop},arguments[3]||{}));};Effect.Scale=Class.create(Effect.Base,{initialize:function(element,percent){this.element=$(element);if(!this.element)throw(Effect._elementDoesNotExistError);var options=Object.extend({scaleX:true,scaleY:true,scaleContent:true,scaleFromCenter:false,scaleMode:'box',scaleFrom:100.0,scaleTo:percent},arguments[2]||{});this.start(options);},setup:function(){this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle('position');this.originalStyle={};['top','left','width','height','fontSize'].each(function(k){this.originalStyle[k]=this.element.style[k];}.bind(this));this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;var fontSize=this.element.getStyle('font-size')||'100%';['em','px','%','pt'].each(function(fontSizeType){if(fontSize.indexOf(fontSizeType)>0){this.fontSize=parseFloat(fontSize);this.fontSizeType=fontSizeType;}}.bind(this));this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;this.dims=null;if(this.options.scaleMode=='box')
this.dims=[this.element.offsetHeight,this.element.offsetWidth];if(/^content/.test(this.options.scaleMode))
this.dims=[this.element.scrollHeight,this.element.scrollWidth];if(!this.dims)
this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth];},update:function(position){var currentScale=(this.options.scaleFrom/100.0)+(this.factor*position);if(this.options.scaleContent&&this.fontSize)
this.element.setStyle({fontSize:this.fontSize*currentScale+this.fontSizeType});this.setDimensions(this.dims[0]*currentScale,this.dims[1]*currentScale);},finish:function(position){if(this.restoreAfterFinish)this.element.setStyle(this.originalStyle);},setDimensions:function(height,width){var d={};if(this.options.scaleX)d.width=width.round()+'px';if(this.options.scaleY)d.height=height.round()+'px';if(this.options.scaleFromCenter){var topd=(height-this.dims[0])/2;var leftd=(width-this.dims[1])/2;if(this.elementPositioning=='absolute'){if(this.options.scaleY)d.top=this.originalTop-topd+'px';if(this.options.scaleX)d.left=this.originalLeft-leftd+'px';}else{if(this.options.scaleY)d.top=-topd+'px';if(this.options.scaleX)d.left=-leftd+'px';}}
this.element.setStyle(d);}});Effect.Highlight=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element)throw(Effect._elementDoesNotExistError);var options=Object.extend({startcolor:'#ffff99'},arguments[1]||{});this.start(options);},setup:function(){if(this.element.getStyle('display')=='none'){this.cancel();return;}
this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle('background-image');this.element.setStyle({backgroundImage:'none'});}
if(!this.options.endcolor)
this.options.endcolor=this.element.getStyle('background-color').parseColor('#ffffff');if(!this.options.restorecolor)
this.options.restorecolor=this.element.getStyle('background-color');this._base=$R(0,2).map(function(i){return parseInt(this.options.startcolor.slice(i*2+1,i*2+3),16)}.bind(this));this._delta=$R(0,2).map(function(i){return parseInt(this.options.endcolor.slice(i*2+1,i*2+3),16)-this._base[i]}.bind(this));},update:function(position){this.element.setStyle({backgroundColor:$R(0,2).inject('#',function(m,v,i){return m+((this._base[i]+(this._delta[i]*position)).round().toColorPart());}.bind(this))});},finish:function(){this.element.setStyle(Object.extend(this.oldStyle,{backgroundColor:this.options.restorecolor}));}});Effect.ScrollTo=function(element){var options=arguments[1]||{},scrollOffsets=document.viewport.getScrollOffsets(),elementOffsets=$(element).cumulativeOffset();if(options.offset)elementOffsets[1]+=options.offset;return new Effect.Tween(null,scrollOffsets.top,elementOffsets[1],options,function(p){scrollTo(scrollOffsets.left,p.round());});};Effect.Fade=function(element){element=$(element);var oldOpacity=element.getInlineOpacity();var options=Object.extend({from:element.getOpacity()||1.0,to:0.0,afterFinishInternal:function(effect){if(effect.options.to!=0)return;effect.element.hide().setStyle({opacity:oldOpacity});}},arguments[1]||{});return new Effect.Opacity(element,options);};Effect.Appear=function(element){element=$(element);var options=Object.extend({from:(element.getStyle('display')=='none'?0.0:element.getOpacity()||0.0),to:1.0,afterFinishInternal:function(effect){effect.element.forceRerendering();},beforeSetup:function(effect){effect.element.setOpacity(effect.options.from).show();}},arguments[1]||{});return new Effect.Opacity(element,options);};Effect.Puff=function(element){element=$(element);var oldStyle={opacity:element.getInlineOpacity(),position:element.getStyle('position'),top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height};return new Effect.Parallel([new Effect.Scale(element,200,{sync:true,scaleFromCenter:true,scaleContent:true,restoreAfterFinish:true}),new Effect.Opacity(element,{sync:true,to:0.0})],Object.extend({duration:1.0,beforeSetupInternal:function(effect){Position.absolutize(effect.effects[0].element);},afterFinishInternal:function(effect){effect.effects[0].element.hide().setStyle(oldStyle);}},arguments[1]||{}));};Effect.BlindUp=function(element){element=$(element);element.makeClipping();return new Effect.Scale(element,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(effect){effect.element.hide().undoClipping();}},arguments[1]||{}));};Effect.BlindDown=function(element){element=$(element);var elementDimensions=element.getDimensions();return new Effect.Scale(element,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:true,afterSetup:function(effect){effect.element.makeClipping().setStyle({height:'0px'}).show();},afterFinishInternal:function(effect){effect.element.undoClipping();}},arguments[1]||{}));};Effect.SwitchOff=function(element){element=$(element);var oldOpacity=element.getInlineOpacity();return new Effect.Appear(element,Object.extend({duration:0.4,from:0,transition:Effect.Transitions.flicker,afterFinishInternal:function(effect){new Effect.Scale(effect.element,1,{duration:0.3,scaleFromCenter:true,scaleX:false,scaleContent:false,restoreAfterFinish:true,beforeSetup:function(effect){effect.element.makePositioned().makeClipping();},afterFinishInternal:function(effect){effect.element.hide().undoClipping().undoPositioned().setStyle({opacity:oldOpacity});}});}},arguments[1]||{}));};Effect.DropOut=function(element){element=$(element);var oldStyle={top:element.getStyle('top'),left:element.getStyle('left'),opacity:element.getInlineOpacity()};return new Effect.Parallel([new Effect.Move(element,{x:0,y:100,sync:true}),new Effect.Opacity(element,{sync:true,to:0.0})],Object.extend({duration:0.5,beforeSetup:function(effect){effect.effects[0].element.makePositioned();},afterFinishInternal:function(effect){effect.effects[0].element.hide().undoPositioned().setStyle(oldStyle);}},arguments[1]||{}));};Effect.Shake=function(element){element=$(element);var options=Object.extend({distance:20,duration:0.5},arguments[1]||{});var distance=parseFloat(options.distance);var split=parseFloat(options.duration)/10.0;var oldStyle={top:element.getStyle('top'),left:element.getStyle('left')};return new Effect.Move(element,{x:distance,y:0,duration:split,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:-distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:-distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:-distance,y:0,duration:split,afterFinishInternal:function(effect){effect.element.undoPositioned().setStyle(oldStyle);}});}});}});}});}});}});};Effect.SlideDown=function(element){element=$(element).cleanWhitespace();var oldInnerBottom=element.down().getStyle('bottom');var elementDimensions=element.getDimensions();return new Effect.Scale(element,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:window.opera?0:1,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:true,afterSetup:function(effect){effect.element.makePositioned();effect.element.down().makePositioned();if(window.opera)effect.element.setStyle({top:''});effect.element.makeClipping().setStyle({height:'0px'}).show();},afterUpdateInternal:function(effect){effect.element.down().setStyle({bottom:(effect.dims[0]-effect.element.clientHeight)+'px'});},afterFinishInternal:function(effect){effect.element.undoClipping().undoPositioned();effect.element.down().undoPositioned().setStyle({bottom:oldInnerBottom});}},arguments[1]||{}));};Effect.SlideUp=function(element){element=$(element).cleanWhitespace();var oldInnerBottom=element.down().getStyle('bottom');var elementDimensions=element.getDimensions();return new Effect.Scale(element,window.opera?0:1,Object.extend({scaleContent:false,scaleX:false,scaleMode:'box',scaleFrom:100,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:true,afterSetup:function(effect){effect.element.makePositioned();effect.element.down().makePositioned();if(window.opera)effect.element.setStyle({top:''});effect.element.makeClipping().show();},afterUpdateInternal:function(effect){effect.element.down().setStyle({bottom:(effect.dims[0]-effect.element.clientHeight)+'px'});},afterFinishInternal:function(effect){effect.element.hide().undoClipping().undoPositioned();effect.element.down().undoPositioned().setStyle({bottom:oldInnerBottom});}},arguments[1]||{}));};Effect.Squish=function(element){return new Effect.Scale(element,window.opera?1:0,{restoreAfterFinish:true,beforeSetup:function(effect){effect.element.makeClipping();},afterFinishInternal:function(effect){effect.element.hide().undoClipping();}});};Effect.Grow=function(element){element=$(element);var options=Object.extend({direction:'center',moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.full},arguments[1]||{});var oldStyle={top:element.style.top,left:element.style.left,height:element.style.height,width:element.style.width,opacity:element.getInlineOpacity()};var dims=element.getDimensions();var initialMoveX,initialMoveY;var moveX,moveY;switch(options.direction){case'top-left':initialMoveX=initialMoveY=moveX=moveY=0;break;case'top-right':initialMoveX=dims.width;initialMoveY=moveY=0;moveX=-dims.width;break;case'bottom-left':initialMoveX=moveX=0;initialMoveY=dims.height;moveY=-dims.height;break;case'bottom-right':initialMoveX=dims.width;initialMoveY=dims.height;moveX=-dims.width;moveY=-dims.height;break;case'center':initialMoveX=dims.width/2;initialMoveY=dims.height/2;moveX=-dims.width/2;moveY=-dims.height/2;break;}
return new Effect.Move(element,{x:initialMoveX,y:initialMoveY,duration:0.01,beforeSetup:function(effect){effect.element.hide().makeClipping().makePositioned();},afterFinishInternal:function(effect){new Effect.Parallel([new Effect.Opacity(effect.element,{sync:true,to:1.0,from:0.0,transition:options.opacityTransition}),new Effect.Move(effect.element,{x:moveX,y:moveY,sync:true,transition:options.moveTransition}),new Effect.Scale(effect.element,100,{scaleMode:{originalHeight:dims.height,originalWidth:dims.width},sync:true,scaleFrom:window.opera?1:0,transition:options.scaleTransition,restoreAfterFinish:true})],Object.extend({beforeSetup:function(effect){effect.effects[0].element.setStyle({height:'0px'}).show();},afterFinishInternal:function(effect){effect.effects[0].element.undoClipping().undoPositioned().setStyle(oldStyle);}},options));}});};Effect.Shrink=function(element){element=$(element);var options=Object.extend({direction:'center',moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.none},arguments[1]||{});var oldStyle={top:element.style.top,left:element.style.left,height:element.style.height,width:element.style.width,opacity:element.getInlineOpacity()};var dims=element.getDimensions();var moveX,moveY;switch(options.direction){case'top-left':moveX=moveY=0;break;case'top-right':moveX=dims.width;moveY=0;break;case'bottom-left':moveX=0;moveY=dims.height;break;case'bottom-right':moveX=dims.width;moveY=dims.height;break;case'center':moveX=dims.width/2;moveY=dims.height/2;break;}
return new Effect.Parallel([new Effect.Opacity(element,{sync:true,to:0.0,from:1.0,transition:options.opacityTransition}),new Effect.Scale(element,window.opera?1:0,{sync:true,transition:options.scaleTransition,restoreAfterFinish:true}),new Effect.Move(element,{x:moveX,y:moveY,sync:true,transition:options.moveTransition})],Object.extend({beforeStartInternal:function(effect){effect.effects[0].element.makePositioned().makeClipping();},afterFinishInternal:function(effect){effect.effects[0].element.hide().undoClipping().undoPositioned().setStyle(oldStyle);}},options));};Effect.Pulsate=function(element){element=$(element);var options=arguments[1]||{},oldOpacity=element.getInlineOpacity(),transition=options.transition||Effect.Transitions.linear,reverser=function(pos){return 1-transition((-Math.cos((pos*(options.pulses||5)*2)*Math.PI)/2)+.5);};return new Effect.Opacity(element,Object.extend(Object.extend({duration:2.0,from:0,afterFinishInternal:function(effect){effect.element.setStyle({opacity:oldOpacity});}},options),{transition:reverser}));};Effect.Fold=function(element){element=$(element);var oldStyle={top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height};element.makeClipping();return new Effect.Scale(element,5,Object.extend({scaleContent:false,scaleX:false,afterFinishInternal:function(effect){new Effect.Scale(element,1,{scaleContent:false,scaleY:false,afterFinishInternal:function(effect){effect.element.hide().undoClipping().setStyle(oldStyle);}});}},arguments[1]||{}));};Effect.Morph=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element)throw(Effect._elementDoesNotExistError);var options=Object.extend({style:{}},arguments[1]||{});if(!Object.isString(options.style))this.style=$H(options.style);else{if(options.style.include(':'))
this.style=options.style.parseStyle();else{this.element.addClassName(options.style);this.style=$H(this.element.getStyles());this.element.removeClassName(options.style);var css=this.element.getStyles();this.style=this.style.reject(function(style){return style.value==css[style.key];});options.afterFinishInternal=function(effect){effect.element.addClassName(effect.options.style);effect.transforms.each(function(transform){effect.element.style[transform.style]='';});};}}
this.start(options);},setup:function(){function parseColor(color){if(!color||['rgba(0, 0, 0, 0)','transparent'].include(color))color='#ffffff';color=color.parseColor();return $R(0,2).map(function(i){return parseInt(color.slice(i*2+1,i*2+3),16);});}
this.transforms=this.style.map(function(pair){var property=pair[0],value=pair[1],unit=null;if(value.parseColor('#zzzzzz')!='#zzzzzz'){value=value.parseColor();unit='color';}else if(property=='opacity'){value=parseFloat(value);if(Prototype.Browser.IE&&(!this.element.currentStyle.hasLayout))
this.element.setStyle({zoom:1});}else if(Element.CSS_LENGTH.test(value)){var components=value.match(/^([\+\-]?[0-9\.]+)(.*)$/);value=parseFloat(components[1]);unit=(components.length==3)?components[2]:null;}
var originalValue=this.element.getStyle(property);return{style:property.camelize(),originalValue:unit=='color'?parseColor(originalValue):parseFloat(originalValue||0),targetValue:unit=='color'?parseColor(value):value,unit:unit};}.bind(this)).reject(function(transform){return((transform.originalValue==transform.targetValue)||(transform.unit!='color'&&(isNaN(transform.originalValue)||isNaN(transform.targetValue))));});},update:function(position){var style={},transform,i=this.transforms.length;while(i--)
style[(transform=this.transforms[i]).style]=transform.unit=='color'?'#'+
(Math.round(transform.originalValue[0]+
(transform.targetValue[0]-transform.originalValue[0])*position)).toColorPart()+
(Math.round(transform.originalValue[1]+
(transform.targetValue[1]-transform.originalValue[1])*position)).toColorPart()+
(Math.round(transform.originalValue[2]+
(transform.targetValue[2]-transform.originalValue[2])*position)).toColorPart():(transform.originalValue+
(transform.targetValue-transform.originalValue)*position).toFixed(3)+
(transform.unit===null?'':transform.unit);this.element.setStyle(style,true);}});Effect.Transform=Class.create({initialize:function(tracks){this.tracks=[];this.options=arguments[1]||{};this.addTracks(tracks);},addTracks:function(tracks){tracks.each(function(track){track=$H(track);var data=track.values().first();this.tracks.push($H({ids:track.keys().first(),effect:Effect.Morph,options:{style:data}}));}.bind(this));return this;},play:function(){return new Effect.Parallel(this.tracks.map(function(track){var ids=track.get('ids'),effect=track.get('effect'),options=track.get('options');var elements=[$(ids)||$$(ids)].flatten();return elements.map(function(e){return new effect(e,Object.extend({sync:true},options))});}).flatten(),this.options);}});Element.CSS_PROPERTIES=$w('backgroundColor backgroundPosition borderBottomColor borderBottomStyle '+'borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth '+'borderRightColor borderRightStyle borderRightWidth borderSpacing '+'borderTopColor borderTopStyle borderTopWidth bottom clip color '+'fontSize fontWeight height left letterSpacing lineHeight '+'marginBottom marginLeft marginRight marginTop markerOffset maxHeight '+'maxWidth minHeight minWidth opacity outlineColor outlineOffset '+'outlineWidth paddingBottom paddingLeft paddingRight paddingTop '+'right textIndent top width wordSpacing zIndex');Element.CSS_LENGTH=/^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/;String.__parseStyleElement=document.createElement('div');String.prototype.parseStyle=function(){var style,styleRules=$H();if(Prototype.Browser.WebKit)
style=new Element('div',{style:this}).style;else{String.__parseStyleElement.innerHTML='<div style="'+this+'"></div>';style=String.__parseStyleElement.childNodes[0].style;}
Element.CSS_PROPERTIES.each(function(property){if(style[property])styleRules.set(property,style[property]);});if(Prototype.Browser.IE&&this.include('opacity'))
styleRules.set('opacity',this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1]);return styleRules;};if(document.defaultView&&document.defaultView.getComputedStyle){Element.getStyles=function(element){var css=document.defaultView.getComputedStyle($(element),null);return Element.CSS_PROPERTIES.inject({},function(styles,property){styles[property]=css[property];return styles;});};}else{Element.getStyles=function(element){element=$(element);var css=element.currentStyle,styles;styles=Element.CSS_PROPERTIES.inject({},function(results,property){results[property]=css[property];return results;});if(!styles.opacity)styles.opacity=element.getOpacity();return styles;};}
Effect.Methods={morph:function(element,style){element=$(element);new Effect.Morph(element,Object.extend({style:style},arguments[2]||{}));return element;},visualEffect:function(element,effect,options){element=$(element);var s=effect.dasherize().camelize(),klass=s.charAt(0).toUpperCase()+s.substring(1);new Effect[klass](element,options);return element;},highlight:function(element,options){element=$(element);new Effect.Highlight(element,options);return element;}};$w('fade appear grow shrink fold blindUp blindDown slideUp slideDown '+'pulsate shake puff squish switchOff dropOut').each(function(effect){Effect.Methods[effect]=function(element,options){element=$(element);Effect[effect.charAt(0).toUpperCase()+effect.substring(1)](element,options);return element;};});$w('getInlineOpacity forceRerendering setContentZoom collectTextNodes collectTextNodesIgnoreClass getStyles').each(function(f){Effect.Methods[f]=Element[f];});Element.addMethods(Effect.Methods);if(Object.isUndefined(Effect))
throw("dragdrop.js requires including script.aculo.us' effects.js library");var Droppables={drops:[],remove:function(element){this.drops=this.drops.reject(function(d){return d.element==$(element)});},add:function(element){element=$(element);var options=Object.extend({greedy:true,hoverclass:null,tree:false},arguments[1]||{});if(options.containment){options._containers=[];var containment=options.containment;if(Object.isArray(containment)){containment.each(function(c){options._containers.push($(c))});}else{options._containers.push($(containment));}}
if(options.accept)options.accept=[options.accept].flatten();Element.makePositioned(element);options.element=element;this.drops.push(options);},findDeepestChild:function(drops){deepest=drops[0];for(i=1;i<drops.length;++i)
if(Element.isParent(drops[i].element,deepest.element))
deepest=drops[i];return deepest;},isContained:function(element,drop){var containmentNode;if(drop.tree){containmentNode=element.treeNode;}else{containmentNode=element.parentNode;}
return drop._containers.detect(function(c){return containmentNode==c});},isAffected:function(point,element,drop){return((drop.element!=element)&&((!drop._containers)||this.isContained(element,drop))&&((!drop.accept)||(Element.classNames(element).detect(function(v){return drop.accept.include(v)})))&&Position.within(drop.element,point[0],point[1]));},deactivate:function(drop){if(drop.hoverclass)
Element.removeClassName(drop.element,drop.hoverclass);this.last_active=null;},activate:function(drop){if(drop.hoverclass)
Element.addClassName(drop.element,drop.hoverclass);this.last_active=drop;},show:function(point,element){if(!this.drops.length)return;var drop,affected=[];this.drops.each(function(drop){if(Droppables.isAffected(point,element,drop))
affected.push(drop);});if(affected.length>0)
drop=Droppables.findDeepestChild(affected);if(this.last_active&&this.last_active!=drop)this.deactivate(this.last_active);if(drop){Position.within(drop.element,point[0],point[1]);if(drop.onHover)
drop.onHover(element,drop.element,Position.overlap(drop.overlap,drop.element));if(drop!=this.last_active)Droppables.activate(drop);}},fire:function(event,element){if(!this.last_active)return;Position.prepare();if(this.isAffected([Event.pointerX(event),Event.pointerY(event)],element,this.last_active))
if(this.last_active.onDrop){this.last_active.onDrop(element,this.last_active.element,event);return true;}},reset:function(){if(this.last_active)
this.deactivate(this.last_active);}};var Draggables={drags:[],observers:[],register:function(draggable){if(this.drags.length==0){this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.updateDrag.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress);}
this.drags.push(draggable);},unregister:function(draggable){this.drags=this.drags.reject(function(d){return d==draggable});if(this.drags.length==0){Event.stopObserving(document,"mouseup",this.eventMouseUp);Event.stopObserving(document,"mousemove",this.eventMouseMove);Event.stopObserving(document,"keypress",this.eventKeypress);}},activate:function(draggable){if(draggable.options.delay){this._timeout=setTimeout(function(){Draggables._timeout=null;window.focus();Draggables.activeDraggable=draggable;}.bind(this),draggable.options.delay);}else{window.focus();this.activeDraggable=draggable;}},deactivate:function(){this.activeDraggable=null;},updateDrag:function(event){if(!this.activeDraggable)return;var pointer=[Event.pointerX(event),Event.pointerY(event)];if(this._lastPointer&&(this._lastPointer.inspect()==pointer.inspect()))return;this._lastPointer=pointer;this.activeDraggable.updateDrag(event,pointer);},endDrag:function(event){if(this._timeout){clearTimeout(this._timeout);this._timeout=null;}
if(!this.activeDraggable)return;this._lastPointer=null;this.activeDraggable.endDrag(event);this.activeDraggable=null;},keyPress:function(event){if(this.activeDraggable)
this.activeDraggable.keyPress(event);},addObserver:function(observer){this.observers.push(observer);this._cacheObserverCallbacks();},removeObserver:function(element){this.observers=this.observers.reject(function(o){return o.element==element});this._cacheObserverCallbacks();},notify:function(eventName,draggable,event){if(this[eventName+'Count']>0)
this.observers.each(function(o){if(o[eventName])o[eventName](eventName,draggable,event);});if(draggable.options[eventName])draggable.options[eventName](draggable,event);},_cacheObserverCallbacks:function(){['onStart','onEnd','onDrag'].each(function(eventName){Draggables[eventName+'Count']=Draggables.observers.select(function(o){return o[eventName];}).length;});}};var Draggable=Class.create({initialize:function(element){var defaults={handle:false,reverteffect:function(element,top_offset,left_offset){var dur=Math.sqrt(Math.abs(top_offset^2)+Math.abs(left_offset^2))*0.02;new Effect.Move(element,{x:-left_offset,y:-top_offset,duration:dur,queue:{scope:'_draggable',position:'end'}});},endeffect:function(element){var toOpacity=Object.isNumber(element._opacity)?element._opacity:1.0;new Effect.Opacity(element,{duration:0.2,from:0.7,to:toOpacity,queue:{scope:'_draggable',position:'end'},afterFinish:function(){Draggable._dragging[element]=false}});},zindex:1000,revert:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,snap:false,delay:0};if(!arguments[1]||Object.isUndefined(arguments[1].endeffect))
Object.extend(defaults,{starteffect:function(element){element._opacity=Element.getOpacity(element);Draggable._dragging[element]=true;new Effect.Opacity(element,{duration:0.2,from:element._opacity,to:0.7});}});var options=Object.extend(defaults,arguments[1]||{});this.element=$(element);if(options.handle&&Object.isString(options.handle))
this.handle=this.element.down('.'+options.handle,0);if(!this.handle)this.handle=$(options.handle);if(!this.handle)this.handle=this.element;if(options.scroll&&!options.scroll.scrollTo&&!options.scroll.outerHTML){options.scroll=$(options.scroll);this._isScrollChild=Element.childOf(this.element,options.scroll);}
Element.makePositioned(this.element);this.options=options;this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this);},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);Draggables.unregister(this);},currentDelta:function(){return([parseInt(Element.getStyle(this.element,'left')||'0'),parseInt(Element.getStyle(this.element,'top')||'0')]);},initDrag:function(event){if(!Object.isUndefined(Draggable._dragging[this.element])&&Draggable._dragging[this.element])return;if(Event.isLeftClick(event)){var src=Event.element(event);if((tag_name=src.tagName.toUpperCase())&&(tag_name=='INPUT'||tag_name=='SELECT'||tag_name=='OPTION'||tag_name=='BUTTON'||tag_name=='TEXTAREA'))return;var pointer=[Event.pointerX(event),Event.pointerY(event)];var pos=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(i){return(pointer[i]-pos[i])});Draggables.activate(this);Event.stop(event);}},startDrag:function(event){this.dragging=true;if(!this.delta)
this.delta=this.currentDelta();if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,'z-index')||0);this.element.style.zIndex=this.options.zindex;}
if(this.options.ghosting){this._clone=this.element.cloneNode(true);this._originallyAbsolute=(this.element.getStyle('position')=='absolute');if(!this._originallyAbsolute)
Position.absolutize(this.element);this.element.parentNode.insertBefore(this._clone,this.element);}
if(this.options.scroll){if(this.options.scroll==window){var where=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=where.left;this.originalScrollTop=where.top;}else{this.originalScrollLeft=this.options.scroll.scrollLeft;this.originalScrollTop=this.options.scroll.scrollTop;}}
Draggables.notify('onStart',this,event);if(this.options.starteffect)this.options.starteffect(this.element);},updateDrag:function(event,pointer){if(!this.dragging)this.startDrag(event);if(!this.options.quiet){Position.prepare();Droppables.show(pointer,this.element);}
Draggables.notify('onDrag',this,event);this.draw(pointer);if(this.options.change)this.options.change(this);if(this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){p=[left,top,left+width,top+height];}}else{p=Position.page(this.options.scroll);p[0]+=this.options.scroll.scrollLeft+Position.deltaX;p[1]+=this.options.scroll.scrollTop+Position.deltaY;p.push(p[0]+this.options.scroll.offsetWidth);p.push(p[1]+this.options.scroll.offsetHeight);}
var speed=[0,0];if(pointer[0]<(p[0]+this.options.scrollSensitivity))speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity);if(pointer[1]<(p[1]+this.options.scrollSensitivity))speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity);if(pointer[0]>(p[2]-this.options.scrollSensitivity))speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity);if(pointer[1]>(p[3]-this.options.scrollSensitivity))speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity);this.startScrolling(speed);}
if(Prototype.Browser.WebKit)window.scrollBy(0,0);Event.stop(event);},finishDrag:function(event,success){this.dragging=false;if(this.options.quiet){Position.prepare();var pointer=[Event.pointerX(event),Event.pointerY(event)];Droppables.show(pointer,this.element);}
if(this.options.ghosting){if(!this._originallyAbsolute)
Position.relativize(this.element);delete this._originallyAbsolute;Element.remove(this._clone);this._clone=null;}
var dropped=false;if(success){dropped=Droppables.fire(event,this.element);if(!dropped)dropped=false;}
if(dropped&&this.options.onDropped)this.options.onDropped(this.element);Draggables.notify('onEnd',this,event);var revert=this.options.revert;if(revert&&Object.isFunction(revert))revert=revert(this.element);var d=this.currentDelta();if(revert&&this.options.reverteffect){if(dropped==0||revert!='failure')
this.options.reverteffect(this.element,d[1]-this.delta[1],d[0]-this.delta[0]);}else{this.delta=d;}
if(this.options.zindex)
this.element.style.zIndex=this.originalZ;if(this.options.endeffect)
this.options.endeffect(this.element);Draggables.deactivate(this);Droppables.reset();},keyPress:function(event){if(event.keyCode!=Event.KEY_ESC)return;this.finishDrag(event,false);Event.stop(event);},endDrag:function(event){if(!this.dragging)return;this.stopScrolling();this.finishDrag(event,true);Event.stop(event);},draw:function(point){var pos=Position.cumulativeOffset(this.element);if(this.options.ghosting){var r=Position.realOffset(this.element);pos[0]+=r[0]-Position.deltaX;pos[1]+=r[1]-Position.deltaY;}
var d=this.currentDelta();pos[0]-=d[0];pos[1]-=d[1];if(this.options.scroll&&(this.options.scroll!=window&&this._isScrollChild)){pos[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft;pos[1]-=this.options.scroll.scrollTop-this.originalScrollTop;}
var p=[0,1].map(function(i){return(point[i]-pos[i]-this.offset[i])}.bind(this));if(this.options.snap){if(Object.isFunction(this.options.snap)){p=this.options.snap(p[0],p[1],this);}else{if(Object.isArray(this.options.snap)){p=p.map(function(v,i){return(v/this.options.snap[i]).round()*this.options.snap[i]}.bind(this));}else{p=p.map(function(v){return(v/this.options.snap).round()*this.options.snap}.bind(this));}}}
var style=this.element.style;if((!this.options.constraint)||(this.options.constraint=='horizontal'))
style.left=p[0]+"px";if((!this.options.constraint)||(this.options.constraint=='vertical'))
style.top=p[1]+"px";if(style.visibility=="hidden")style.visibility="";},stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null;Draggables._lastScrollPointer=null;}},startScrolling:function(speed){if(!(speed[0]||speed[1]))return;this.scrollSpeed=[speed[0]*this.options.scrollSpeed,speed[1]*this.options.scrollSpeed];this.lastScrolled=new Date();this.scrollInterval=setInterval(this.scroll.bind(this),10);},scroll:function(){var current=new Date();var delta=current-this.lastScrolled;this.lastScrolled=current;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1000;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1]);}}}else{this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1000;this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1000;}
Position.prepare();Droppables.show(Draggables._lastPointer,this.element);Draggables.notify('onDrag',this);if(this._isScrollChild){Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer);Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1000;Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1000;if(Draggables._lastScrollPointer[0]<0)
Draggables._lastScrollPointer[0]=0;if(Draggables._lastScrollPointer[1]<0)
Draggables._lastScrollPointer[1]=0;this.draw(Draggables._lastScrollPointer);}
if(this.options.change)this.options.change(this);},_getWindowScroll:function(w){var T,L,W,H;with(w.document){if(w.document.documentElement&&documentElement.scrollTop){T=documentElement.scrollTop;L=documentElement.scrollLeft;}else if(w.document.body){T=body.scrollTop;L=body.scrollLeft;}
if(w.innerWidth){W=w.innerWidth;H=w.innerHeight;}else if(w.document.documentElement&&documentElement.clientWidth){W=documentElement.clientWidth;H=documentElement.clientHeight;}else{W=body.offsetWidth;H=body.offsetHeight;}}
return{top:T,left:L,width:W,height:H};}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(element,observer){this.element=$(element);this.observer=observer;this.lastValue=Sortable.serialize(this.element);},onStart:function(){this.lastValue=Sortable.serialize(this.element);},onEnd:function(){Sortable.unmark();if(this.lastValue!=Sortable.serialize(this.element))
this.observer(this.element)}});var Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(element){while(element.tagName.toUpperCase()!="BODY"){if(element.id&&Sortable.sortables[element.id])return element;element=element.parentNode;}},options:function(element){element=Sortable._findRootElement($(element));if(!element)return;return Sortable.sortables[element.id];},destroy:function(element){element=$(element);var s=Sortable.sortables[element.id];if(s){Draggables.removeObserver(s.element);s.droppables.each(function(d){Droppables.remove(d)});s.draggables.invoke('destroy');delete Sortable.sortables[s.element.id];}},create:function(element){element=$(element);var options=Object.extend({element:element,tag:'li',dropOnEmpty:false,tree:false,treeTag:'ul',overlap:'vertical',constraint:'vertical',containment:element,handle:false,only:false,delay:0,hoverclass:null,ghosting:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:false,handles:false,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(element);var options_for_draggable={revert:true,quiet:options.quiet,scroll:options.scroll,scrollSpeed:options.scrollSpeed,scrollSensitivity:options.scrollSensitivity,delay:options.delay,ghosting:options.ghosting,constraint:options.constraint,handle:options.handle};if(options.starteffect)
options_for_draggable.starteffect=options.starteffect;if(options.reverteffect)
options_for_draggable.reverteffect=options.reverteffect;else
if(options.ghosting)options_for_draggable.reverteffect=function(element){element.style.top=0;element.style.left=0;};if(options.endeffect)
options_for_draggable.endeffect=options.endeffect;if(options.zindex)
options_for_draggable.zindex=options.zindex;var options_for_droppable={overlap:options.overlap,containment:options.containment,tree:options.tree,hoverclass:options.hoverclass,onHover:Sortable.onHover};var options_for_tree={onHover:Sortable.onEmptyHover,overlap:options.overlap,containment:options.containment,hoverclass:options.hoverclass};Element.cleanWhitespace(element);options.draggables=[];options.droppables=[];if(options.dropOnEmpty||options.tree){Droppables.add(element,options_for_tree);options.droppables.push(element);}
(options.elements||this.findElements(element,options)||[]).each(function(e,i){var handle=options.handles?$(options.handles[i]):(options.handle?$(e).select('.'+options.handle)[0]:e);options.draggables.push(new Draggable(e,Object.extend(options_for_draggable,{handle:handle})));Droppables.add(e,options_for_droppable);if(options.tree)e.treeNode=element;options.droppables.push(e);});if(options.tree){(Sortable.findTreeElements(element,options)||[]).each(function(e){Droppables.add(e,options_for_tree);e.treeNode=element;options.droppables.push(e);});}
this.sortables[element.id]=options;Draggables.addObserver(new SortableObserver(element,options.onUpdate));},findElements:function(element,options){return Element.findChildren(element,options.only,options.tree?true:false,options.tag);},findTreeElements:function(element,options){return Element.findChildren(element,options.only,options.tree?true:false,options.treeTag);},onHover:function(element,dropon,overlap){if(Element.isParent(dropon,element))return;if(overlap>.33&&overlap<.66&&Sortable.options(dropon).tree){return;}else if(overlap>0.5){Sortable.mark(dropon,'before');if(dropon.previousSibling!=element){var oldParentNode=element.parentNode;element.style.visibility="hidden";dropon.parentNode.insertBefore(element,dropon);if(dropon.parentNode!=oldParentNode)
Sortable.options(oldParentNode).onChange(element);Sortable.options(dropon.parentNode).onChange(element);}}else{Sortable.mark(dropon,'after');var nextElement=dropon.nextSibling||null;if(nextElement!=element){var oldParentNode=element.parentNode;element.style.visibility="hidden";dropon.parentNode.insertBefore(element,nextElement);if(dropon.parentNode!=oldParentNode)
Sortable.options(oldParentNode).onChange(element);Sortable.options(dropon.parentNode).onChange(element);}}},onEmptyHover:function(element,dropon,overlap){var oldParentNode=element.parentNode;var droponOptions=Sortable.options(dropon);if(!Element.isParent(dropon,element)){var index;var children=Sortable.findElements(dropon,{tag:droponOptions.tag,only:droponOptions.only});var child=null;if(children){var offset=Element.offsetSize(dropon,droponOptions.overlap)*(1.0-overlap);for(index=0;index<children.length;index+=1){if(offset-Element.offsetSize(children[index],droponOptions.overlap)>=0){offset-=Element.offsetSize(children[index],droponOptions.overlap);}else if(offset-(Element.offsetSize(children[index],droponOptions.overlap)/2)>=0){child=index+1<children.length?children[index+1]:null;break;}else{child=children[index];break;}}}
dropon.insertBefore(element,child);Sortable.options(oldParentNode).onChange(element);droponOptions.onChange(element);}},unmark:function(){if(Sortable._marker)Sortable._marker.hide();},mark:function(dropon,position){var sortable=Sortable.options(dropon.parentNode);if(sortable&&!sortable.ghosting)return;if(!Sortable._marker){Sortable._marker=($('dropmarker')||Element.extend(document.createElement('DIV'))).hide().addClassName('dropmarker').setStyle({position:'absolute'});document.getElementsByTagName("body").item(0).appendChild(Sortable._marker);}
var offsets=Position.cumulativeOffset(dropon);Sortable._marker.setStyle({left:offsets[0]+'px',top:offsets[1]+'px'});if(position=='after')
if(sortable.overlap=='horizontal')
Sortable._marker.setStyle({left:(offsets[0]+dropon.clientWidth)+'px'});else
Sortable._marker.setStyle({top:(offsets[1]+dropon.clientHeight)+'px'});Sortable._marker.show();},_tree:function(element,options,parent){var children=Sortable.findElements(element,options)||[];for(var i=0;i<children.length;++i){var match=children[i].id.match(options.format);if(!match)continue;var child={id:encodeURIComponent(match?match[1]:null),element:element,parent:parent,children:[],position:parent.children.length,container:$(children[i]).down(options.treeTag)};if(child.container)
this._tree(child.container,options,child);parent.children.push(child);}
return parent;},tree:function(element){element=$(element);var sortableOptions=this.options(element);var options=Object.extend({tag:sortableOptions.tag,treeTag:sortableOptions.treeTag,only:sortableOptions.only,name:element.id,format:sortableOptions.format},arguments[1]||{});var root={id:null,parent:null,children:[],container:element,position:0};return Sortable._tree(element,options,root);},_constructIndex:function(node){var index='';do{if(node.id)index='['+node.position+']'+index;}while((node=node.parent)!=null);return index;},sequence:function(element){element=$(element);var options=Object.extend(this.options(element),arguments[1]||{});return $(this.findElements(element,options)||[]).map(function(item){return item.id.match(options.format)?item.id.match(options.format)[1]:'';});},setSequence:function(element,new_sequence){element=$(element);var options=Object.extend(this.options(element),arguments[2]||{});var nodeMap={};this.findElements(element,options).each(function(n){if(n.id.match(options.format))
nodeMap[n.id.match(options.format)[1]]=[n,n.parentNode];n.parentNode.removeChild(n);});new_sequence.each(function(ident){var n=nodeMap[ident];if(n){n[1].appendChild(n[0]);delete nodeMap[ident];}});},serialize:function(element){element=$(element);var options=Object.extend(Sortable.options(element),arguments[1]||{});var name=encodeURIComponent((arguments[1]&&arguments[1].name)?arguments[1].name:element.id);if(options.tree){return Sortable.tree(element,arguments[1]).children.map(function(item){return[name+Sortable._constructIndex(item)+"[id]="+
encodeURIComponent(item.id)].concat(item.children.map(arguments.callee));}).flatten().join('&');}else{return Sortable.sequence(element,arguments[1]).map(function(item){return name+"[]="+encodeURIComponent(item);}).join('&');}}};Element.isParent=function(child,element){if(!child.parentNode||child==element)return false;if(child.parentNode==element)return true;return Element.isParent(child.parentNode,element);};Element.findChildren=function(element,only,recursive,tagName){if(!element.hasChildNodes())return null;tagName=tagName.toUpperCase();if(only)only=[only].flatten();var elements=[];$A(element.childNodes).each(function(e){if(e.tagName&&e.tagName.toUpperCase()==tagName&&(!only||(Element.classNames(e).detect(function(v){return only.include(v)}))))
elements.push(e);if(recursive){var grandchildren=Element.findChildren(e,only,recursive,tagName);if(grandchildren)elements.push(grandchildren);}});return(elements.length>0?elements.flatten():[]);};Element.offsetSize=function(element,type){return element['offset'+((type=='vertical'||type=='height')?'Height':'Width')];};if(typeof Effect=='undefined')
throw("controls.js requires including script.aculo.us' effects.js library");var Autocompleter={};Autocompleter.Base=Class.create({baseInitialize:function(element,update,options){element=$(element);this.element=element;this.update=$(update);this.hasFocus=false;this.changed=false;this.active=false;this.index=0;this.entryCount=0;this.oldElementValue=this.element.value;if(this.setOptions)
this.setOptions(options);else
this.options=options||{};this.options.paramName=this.options.paramName||this.element.name;this.options.tokens=this.options.tokens||[];this.options.frequency=this.options.frequency||0.4;this.options.minChars=this.options.minChars||1;this.options.onShow=this.options.onShow||function(element,update){if(!update.style.position||update.style.position=='absolute'){update.style.position='absolute';Position.clone(element,update,{setHeight:false,offsetTop:element.offsetHeight});}
Effect.Appear(update,{duration:0.15});};this.options.onHide=this.options.onHide||function(element,update){new Effect.Fade(update,{duration:0.15})};if(typeof(this.options.tokens)=='string')
this.options.tokens=new Array(this.options.tokens);if(!this.options.tokens.include('\n'))
this.options.tokens.push('\n');this.observer=null;this.element.setAttribute('autocomplete','off');Element.hide(this.update);Event.observe(this.element,'blur',this.onBlur.bindAsEventListener(this));Event.observe(this.element,'keydown',this.onKeyPress.bindAsEventListener(this));},show:function(){if(Element.getStyle(this.update,'display')=='none')this.options.onShow(this.element,this.update);if(!this.iefix&&(Prototype.Browser.IE)&&(Element.getStyle(this.update,'position')=='absolute')){new Insertion.After(this.update,'<iframe id="'+this.update.id+'_iefix" '+'style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" '+'src="javascript:false;" frameborder="0" scrolling="no"></iframe>');this.iefix=$(this.update.id+'_iefix');}
if(this.iefix)setTimeout(this.fixIEOverlapping.bind(this),50);},fixIEOverlapping:function(){Position.clone(this.update,this.iefix,{setTop:(!this.update.style.height)});this.iefix.style.zIndex=1;this.update.style.zIndex=2;Element.show(this.iefix);},hide:function(){this.stopIndicator();if(Element.getStyle(this.update,'display')!='none')this.options.onHide(this.element,this.update);if(this.iefix)Element.hide(this.iefix);},startIndicator:function(){if(this.options.indicator)Element.show(this.options.indicator);},stopIndicator:function(){if(this.options.indicator)Element.hide(this.options.indicator);},onKeyPress:function(event){if(this.active)
switch(event.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry();Event.stop(event);case Event.KEY_ESC:this.hide();this.active=false;Event.stop(event);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(event);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(event);return;}
else
if(event.keyCode==Event.KEY_TAB||event.keyCode==Event.KEY_RETURN||(Prototype.Browser.WebKit>0&&event.keyCode==0))return;this.changed=true;this.hasFocus=true;if(this.observer)clearTimeout(this.observer);this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000);},activate:function(){this.changed=false;this.hasFocus=true;this.getUpdatedChoices();},onHover:function(event){var element=Event.findElement(event,'LI');if(this.index!=element.autocompleteIndex)
{this.index=element.autocompleteIndex;this.render();}
Event.stop(event);},onClick:function(event){var element=Event.findElement(event,'LI');this.index=element.autocompleteIndex;this.selectEntry();this.hide();},onBlur:function(event){setTimeout(this.hide.bind(this),250);this.hasFocus=false;this.active=false;},render:function(){if(this.entryCount>0){for(var i=0;i<this.entryCount;i++)
this.index==i?Element.addClassName(this.getEntry(i),"selected"):Element.removeClassName(this.getEntry(i),"selected");if(this.hasFocus){this.show();this.active=true;}}else{this.active=false;this.hide();}},markPrevious:function(){if(this.index>0)this.index--;else this.index=this.entryCount-1;this.getEntry(this.index).scrollIntoView(true);},markNext:function(){if(this.index<this.entryCount-1)this.index++;else this.index=0;this.getEntry(this.index).scrollIntoView(false);},getEntry:function(index){return this.update.firstChild.childNodes[index];},getCurrentEntry:function(){return this.getEntry(this.index);},selectEntry:function(){this.active=false;this.updateElement(this.getCurrentEntry());},updateElement:function(selectedElement){if(this.options.updateElement){this.options.updateElement(selectedElement);return;}
var value='';if(this.options.select){var nodes=$(selectedElement).select('.'+this.options.select)||[];if(nodes.length>0)value=Element.collectTextNodes(nodes[0],this.options.select);}else
value=Element.collectTextNodesIgnoreClass(selectedElement,'informal');var bounds=this.getTokenBounds();if(bounds[0]!=-1){var newValue=this.element.value.substr(0,bounds[0]);var whitespace=this.element.value.substr(bounds[0]).match(/^\s+/);if(whitespace)
newValue+=whitespace[0];this.element.value=newValue+value+this.element.value.substr(bounds[1]);}else{this.element.value=value;}
this.oldElementValue=this.element.value;this.element.focus();if(this.options.afterUpdateElement)
this.options.afterUpdateElement(this.element,selectedElement);},updateChoices:function(choices){if(!this.changed&&this.hasFocus){this.update.innerHTML=choices;Element.cleanWhitespace(this.update);Element.cleanWhitespace(this.update.down());if(this.update.firstChild&&this.update.down().childNodes){this.entryCount=this.update.down().childNodes.length;for(var i=0;i<this.entryCount;i++){var entry=this.getEntry(i);entry.autocompleteIndex=i;this.addObservers(entry);}}else{this.entryCount=0;}
this.stopIndicator();this.index=0;if(this.entryCount==1&&this.options.autoSelect){this.selectEntry();this.hide();}else{this.render();}}},addObservers:function(element){Event.observe(element,"mouseover",this.onHover.bindAsEventListener(this));Event.observe(element,"click",this.onClick.bindAsEventListener(this));},onObserverEvent:function(){this.changed=false;this.tokenBounds=null;if(this.getToken().length>=this.options.minChars){this.getUpdatedChoices();}else{this.active=false;this.hide();}
this.oldElementValue=this.element.value;},getToken:function(){var bounds=this.getTokenBounds();return this.element.value.substring(bounds[0],bounds[1]).strip();},getTokenBounds:function(){if(null!=this.tokenBounds)return this.tokenBounds;var value=this.element.value;if(value.strip().empty())return[-1,0];var diff=arguments.callee.getFirstDifferencePos(value,this.oldElementValue);var offset=(diff==this.oldElementValue.length?1:0);var prevTokenPos=-1,nextTokenPos=value.length;var tp;for(var index=0,l=this.options.tokens.length;index<l;++index){tp=value.lastIndexOf(this.options.tokens[index],diff+offset-1);if(tp>prevTokenPos)prevTokenPos=tp;tp=value.indexOf(this.options.tokens[index],diff+offset);if(-1!=tp&&tp<nextTokenPos)nextTokenPos=tp;}
return(this.tokenBounds=[prevTokenPos+1,nextTokenPos]);}});Autocompleter.Base.prototype.getTokenBounds.getFirstDifferencePos=function(newS,oldS){var boundary=Math.min(newS.length,oldS.length);for(var index=0;index<boundary;++index)
if(newS[index]!=oldS[index])
return index;return boundary;};Ajax.Autocompleter=Class.create(Autocompleter.Base,{initialize:function(element,update,url,options){this.baseInitialize(element,update,options);this.options.asynchronous=true;this.options.onComplete=this.onComplete.bind(this);this.options.defaultParams=this.options.parameters||null;this.url=url;},getUpdatedChoices:function(){this.startIndicator();var entry=encodeURIComponent(this.options.paramName)+'='+
encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,entry):entry;if(this.options.defaultParams)
this.options.parameters+='&'+this.options.defaultParams;new Ajax.Request(this.url,this.options);},onComplete:function(request){this.updateChoices(request.responseText);}});Autocompleter.Local=Class.create(Autocompleter.Base,{initialize:function(element,update,array,options){this.baseInitialize(element,update,options);this.options.array=array;},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this));},setOptions:function(options){this.options=Object.extend({choices:10,partialSearch:true,partialChars:2,ignoreCase:true,fullSearch:false,selector:function(instance){var ret=[];var partial=[];var entry=instance.getToken();var count=0;for(var i=0;i<instance.options.array.length&&ret.length<instance.options.choices;i++){var elem=instance.options.array[i];var foundPos=instance.options.ignoreCase?elem.toLowerCase().indexOf(entry.toLowerCase()):elem.indexOf(entry);while(foundPos!=-1){if(foundPos==0&&elem.length!=entry.length){ret.push("<li><strong>"+elem.substr(0,entry.length)+"</strong>"+
elem.substr(entry.length)+"</li>");break;}else if(entry.length>=instance.options.partialChars&&instance.options.partialSearch&&foundPos!=-1){if(instance.options.fullSearch||/\s/.test(elem.substr(foundPos-1,1))){partial.push("<li>"+elem.substr(0,foundPos)+"<strong>"+
elem.substr(foundPos,entry.length)+"</strong>"+elem.substr(foundPos+entry.length)+"</li>");break;}}
foundPos=instance.options.ignoreCase?elem.toLowerCase().indexOf(entry.toLowerCase(),foundPos+1):elem.indexOf(entry,foundPos+1);}}
if(partial.length)
ret=ret.concat(partial.slice(0,instance.options.choices-ret.length));return"<ul>"+ret.join('')+"</ul>";}},options||{});}});Field.scrollFreeActivate=function(field){setTimeout(function(){Field.activate(field);},1);};Ajax.InPlaceEditor=Class.create({initialize:function(element,url,options){this.url=url;this.element=element=$(element);this.prepareOptions();this._controls={};arguments.callee.dealWithDeprecatedOptions(options);Object.extend(this.options,options||{});if(!this.options.formId&&this.element.id){this.options.formId=this.element.id+'-inplaceeditor';if($(this.options.formId))
this.options.formId='';}
if(this.options.externalControl)
this.options.externalControl=$(this.options.externalControl);if(!this.options.externalControl)
this.options.externalControlOnly=false;this._originalBackground=this.element.getStyle('background-color')||'transparent';this.element.title=this.options.clickToEditText;this._boundCancelHandler=this.handleFormCancellation.bind(this);this._boundComplete=(this.options.onComplete||Prototype.emptyFunction).bind(this);this._boundFailureHandler=this.handleAJAXFailure.bind(this);this._boundSubmitHandler=this.handleFormSubmission.bind(this);this._boundWrapperHandler=this.wrapUp.bind(this);this.registerListeners();},checkForEscapeOrReturn:function(e){if(!this._editing||e.ctrlKey||e.altKey||e.shiftKey)return;if(Event.KEY_ESC==e.keyCode)
this.handleFormCancellation(e);else if(Event.KEY_RETURN==e.keyCode)
this.handleFormSubmission(e);},createControl:function(mode,handler,extraClasses){var control=this.options[mode+'Control'];var text=this.options[mode+'Text'];if('button'==control){var btn=document.createElement('input');btn.type='submit';btn.value=text;btn.className='editor_'+mode+'_button';if('cancel'==mode)
btn.onclick=this._boundCancelHandler;this._form.appendChild(btn);this._controls[mode]=btn;}else if('link'==control){var link=document.createElement('a');link.href='#';link.appendChild(document.createTextNode(text));link.onclick='cancel'==mode?this._boundCancelHandler:this._boundSubmitHandler;link.className='editor_'+mode+'_link';if(extraClasses)
link.className+=' '+extraClasses;this._form.appendChild(link);this._controls[mode]=link;}},createEditField:function(){var text=(this.options.loadTextURL?this.options.loadingText:this.getText());var fld;if(1>=this.options.rows&&!/\r|\n/.test(this.getText())){fld=document.createElement('input');fld.type='text';var size=this.options.size||this.options.cols||0;if(0<size)fld.size=size;}else{fld=document.createElement('textarea');fld.rows=(1>=this.options.rows?this.options.autoRows:this.options.rows);fld.cols=this.options.cols||40;}
fld.name=this.options.paramName;fld.value=text;fld.className='editor_field';if(this.options.submitOnBlur)
fld.onblur=this._boundSubmitHandler;this._controls.editor=fld;if(this.options.loadTextURL)
this.loadExternalText();this._form.appendChild(this._controls.editor);},createForm:function(){var ipe=this;function addText(mode,condition){var text=ipe.options['text'+mode+'Controls'];if(!text||condition===false)return;ipe._form.appendChild(document.createTextNode(text));};this._form=$(document.createElement('form'));this._form.id=this.options.formId;this._form.addClassName(this.options.formClassName);this._form.onsubmit=this._boundSubmitHandler;this.createEditField();if('textarea'==this._controls.editor.tagName.toLowerCase())
this._form.appendChild(document.createElement('br'));if(this.options.onFormCustomization)
this.options.onFormCustomization(this,this._form);addText('Before',this.options.okControl||this.options.cancelControl);this.createControl('ok',this._boundSubmitHandler);addText('Between',this.options.okControl&&this.options.cancelControl);this.createControl('cancel',this._boundCancelHandler,'editor_cancel');addText('After',this.options.okControl||this.options.cancelControl);},destroy:function(){if(this._oldInnerHTML)
this.element.innerHTML=this._oldInnerHTML;this.leaveEditMode();this.unregisterListeners();},enterEditMode:function(e){if(this._saving||this._editing)return;this._editing=true;this.triggerCallback('onEnterEditMode');if(this.options.externalControl)
this.options.externalControl.hide();this.element.hide();this.createForm();this.element.parentNode.insertBefore(this._form,this.element);if(!this.options.loadTextURL)
this.postProcessEditField();if(e)Event.stop(e);},enterHover:function(e){if(this.options.hoverClassName)
this.element.addClassName(this.options.hoverClassName);if(this._saving)return;this.triggerCallback('onEnterHover');},getText:function(){return this.element.innerHTML.unescapeHTML();},handleAJAXFailure:function(transport){this.triggerCallback('onFailure',transport);if(this._oldInnerHTML){this.element.innerHTML=this._oldInnerHTML;this._oldInnerHTML=null;}},handleFormCancellation:function(e){this.wrapUp();if(e)Event.stop(e);},handleFormSubmission:function(e){var form=this._form;var value=$F(this._controls.editor);this.prepareSubmission();var params=this.options.callback(form,value)||'';if(Object.isString(params))
params=params.toQueryParams();params.editorId=this.element.id;if(this.options.htmlResponse){var options=Object.extend({evalScripts:true},this.options.ajaxOptions);Object.extend(options,{parameters:params,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler});new Ajax.Updater({success:this.element},this.url,options);}else{var options=Object.extend({method:'get'},this.options.ajaxOptions);Object.extend(options,{parameters:params,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler});new Ajax.Request(this.url,options);}
if(e)Event.stop(e);},leaveEditMode:function(){this.element.removeClassName(this.options.savingClassName);this.removeForm();this.leaveHover();this.element.style.backgroundColor=this._originalBackground;this.element.show();if(this.options.externalControl)
this.options.externalControl.show();this._saving=false;this._editing=false;this._oldInnerHTML=null;this.triggerCallback('onLeaveEditMode');},leaveHover:function(e){if(this.options.hoverClassName)
this.element.removeClassName(this.options.hoverClassName);if(this._saving)return;this.triggerCallback('onLeaveHover');},loadExternalText:function(){this._form.addClassName(this.options.loadingClassName);this._controls.editor.disabled=true;var options=Object.extend({method:'get'},this.options.ajaxOptions);Object.extend(options,{parameters:'editorId='+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){this._form.removeClassName(this.options.loadingClassName);var text=transport.responseText;if(this.options.stripLoadedTextTags)
text=text.stripTags();this._controls.editor.value=text;this._controls.editor.disabled=false;this.postProcessEditField();}.bind(this),onFailure:this._boundFailureHandler});new Ajax.Request(this.options.loadTextURL,options);},postProcessEditField:function(){var fpc=this.options.fieldPostCreation;if(fpc)
$(this._controls.editor)['focus'==fpc?'focus':'activate']();},prepareOptions:function(){this.options=Object.clone(Ajax.InPlaceEditor.DefaultOptions);Object.extend(this.options,Ajax.InPlaceEditor.DefaultCallbacks);[this._extraDefaultOptions].flatten().compact().each(function(defs){Object.extend(this.options,defs);}.bind(this));},prepareSubmission:function(){this._saving=true;this.removeForm();this.leaveHover();this.showSaving();},registerListeners:function(){this._listeners={};var listener;$H(Ajax.InPlaceEditor.Listeners).each(function(pair){listener=this[pair.value].bind(this);this._listeners[pair.key]=listener;if(!this.options.externalControlOnly)
this.element.observe(pair.key,listener);if(this.options.externalControl)
this.options.externalControl.observe(pair.key,listener);}.bind(this));},removeForm:function(){if(!this._form)return;this._form.remove();this._form=null;this._controls={};},showSaving:function(){this._oldInnerHTML=this.element.innerHTML;this.element.innerHTML=this.options.savingText;this.element.addClassName(this.options.savingClassName);this.element.style.backgroundColor=this._originalBackground;this.element.show();},triggerCallback:function(cbName,arg){if('function'==typeof this.options[cbName]){this.options[cbName](this,arg);}},unregisterListeners:function(){$H(this._listeners).each(function(pair){if(!this.options.externalControlOnly)
this.element.stopObserving(pair.key,pair.value);if(this.options.externalControl)
this.options.externalControl.stopObserving(pair.key,pair.value);}.bind(this));},wrapUp:function(transport){this.leaveEditMode();this._boundComplete(transport,this.element);}});Object.extend(Ajax.InPlaceEditor.prototype,{dispose:Ajax.InPlaceEditor.prototype.destroy});Ajax.InPlaceCollectionEditor=Class.create(Ajax.InPlaceEditor,{initialize:function($super,element,url,options){this._extraDefaultOptions=Ajax.InPlaceCollectionEditor.DefaultOptions;$super(element,url,options);},createEditField:function(){var list=document.createElement('select');list.name=this.options.paramName;list.size=1;this._controls.editor=list;this._collection=this.options.collection||[];if(this.options.loadCollectionURL)
this.loadCollection();else
this.checkForExternalText();this._form.appendChild(this._controls.editor);},loadCollection:function(){this._form.addClassName(this.options.loadingClassName);this.showLoadingText(this.options.loadingCollectionText);var options=Object.extend({method:'get'},this.options.ajaxOptions);Object.extend(options,{parameters:'editorId='+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){var js=transport.responseText.strip();if(!/^\[.*\]$/.test(js))
throw('Server returned an invalid collection representation.');this._collection=eval(js);this.checkForExternalText();}.bind(this),onFailure:this.onFailure});new Ajax.Request(this.options.loadCollectionURL,options);},showLoadingText:function(text){this._controls.editor.disabled=true;var tempOption=this._controls.editor.firstChild;if(!tempOption){tempOption=document.createElement('option');tempOption.value='';this._controls.editor.appendChild(tempOption);tempOption.selected=true;}
tempOption.update((text||'').stripScripts().stripTags());},checkForExternalText:function(){this._text=this.getText();if(this.options.loadTextURL)
this.loadExternalText();else
this.buildOptionList();},loadExternalText:function(){this.showLoadingText(this.options.loadingText);var options=Object.extend({method:'get'},this.options.ajaxOptions);Object.extend(options,{parameters:'editorId='+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){this._text=transport.responseText.strip();this.buildOptionList();}.bind(this),onFailure:this.onFailure});new Ajax.Request(this.options.loadTextURL,options);},buildOptionList:function(){this._form.removeClassName(this.options.loadingClassName);this._collection=this._collection.map(function(entry){return 2===entry.length?entry:[entry,entry].flatten();});var marker=('value'in this.options)?this.options.value:this._text;var textFound=this._collection.any(function(entry){return entry[0]==marker;}.bind(this));this._controls.editor.update('');var option;this._collection.each(function(entry,index){option=document.createElement('option');option.value=entry[0];option.selected=textFound?entry[0]==marker:0==index;option.appendChild(document.createTextNode(entry[1]));this._controls.editor.appendChild(option);}.bind(this));this._controls.editor.disabled=false;Field.scrollFreeActivate(this._controls.editor);}});Ajax.InPlaceEditor.prototype.initialize.dealWithDeprecatedOptions=function(options){if(!options)return;function fallback(name,expr){if(name in options||expr===undefined)return;options[name]=expr;};fallback('cancelControl',(options.cancelLink?'link':(options.cancelButton?'button':options.cancelLink==options.cancelButton==false?false:undefined)));fallback('okControl',(options.okLink?'link':(options.okButton?'button':options.okLink==options.okButton==false?false:undefined)));fallback('highlightColor',options.highlightcolor);fallback('highlightEndColor',options.highlightendcolor);};Object.extend(Ajax.InPlaceEditor,{DefaultOptions:{ajaxOptions:{},autoRows:3,cancelControl:'link',cancelText:'cancel',clickToEditText:'Click to edit',externalControl:null,externalControlOnly:false,fieldPostCreation:'activate',formClassName:'inplaceeditor-form',formId:null,highlightColor:'#ffff99',highlightEndColor:'#ffffff',hoverClassName:'',htmlResponse:true,loadingClassName:'inplaceeditor-loading',loadingText:'Loading...',okControl:'button',okText:'ok',paramName:'value',rows:1,savingClassName:'inplaceeditor-saving',savingText:'Saving...',size:0,stripLoadedTextTags:false,submitOnBlur:false,textAfterControls:'',textBeforeControls:'',textBetweenControls:''},DefaultCallbacks:{callback:function(form){return Form.serialize(form);},onComplete:function(transport,element){new Effect.Highlight(element,{startcolor:this.options.highlightColor,keepBackgroundImage:true});},onEnterEditMode:null,onEnterHover:function(ipe){ipe.element.style.backgroundColor=ipe.options.highlightColor;if(ipe._effect)
ipe._effect.cancel();},onFailure:function(transport,ipe){alert('Error communication with the server: '+transport.responseText.stripTags());},onFormCustomization:null,onLeaveEditMode:null,onLeaveHover:function(ipe){ipe._effect=new Effect.Highlight(ipe.element,{startcolor:ipe.options.highlightColor,endcolor:ipe.options.highlightEndColor,restorecolor:ipe._originalBackground,keepBackgroundImage:true});}},Listeners:{click:'enterEditMode',keydown:'checkForEscapeOrReturn',mouseover:'enterHover',mouseout:'leaveHover'}});Ajax.InPlaceCollectionEditor.DefaultOptions={loadingCollectionText:'Loading options...'};Form.Element.DelayedObserver=Class.create({initialize:function(element,delay,callback){this.delay=delay||0.5;this.element=$(element);this.callback=callback;this.timer=null;this.lastValue=$F(this.element);Event.observe(this.element,'keyup',this.delayedListener.bindAsEventListener(this));},delayedListener:function(event){if(this.lastValue==$F(this.element))return;if(this.timer)clearTimeout(this.timer);this.timer=setTimeout(this.onTimerEvent.bind(this),this.delay*1000);this.lastValue=$F(this.element);},onTimerEvent:function(){this.timer=null;this.callback(this.element,$F(this.element));}});var Resizeable=Class.create();Resizeable.prototype={initialize:function(element){var options=Object.extend({top:6,bottom:6,left:6,right:6,minHeight:0,minWidth:0,zindex:1000,resize:null,duringresize:null},arguments[1]||{});this.element=$(element);this.handle=this.element;Element.makePositioned(this.element);this.options=options;this.active=false;this.resizing=false;this.currentDirection='';this.eventMouseDown=this.startResize.bindAsEventListener(this);this.eventMouseUp=this.endResize.bindAsEventListener(this);this.eventMouseMove=this.update.bindAsEventListener(this);this.eventCursorCheck=this.cursor.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);this.registerEvents();},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);this.unregisterEvents();},registerEvents:function(){Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress);Event.observe(this.handle,"mousedown",this.eventMouseDown);Event.observe(this.element,"mousemove",this.eventCursorCheck);},unregisterEvents:function(){},startResize:function(event){if(Event.isLeftClick(event)){var src=Event.element(event);if(src.tagName&&(src.tagName=='INPUT'||src.tagName=='SELECT'||src.tagName=='BUTTON'||src.tagName=='TEXTAREA'))return;var dir=this.directions(event);if(dir.length>0){this.active=true;var offsets=Position.cumulativeOffset(this.element);this.startTop=offsets[1];this.startLeft=offsets[0];this.startWidth=parseInt(Element.getStyle(this.element,'width'));this.startHeight=parseInt(Element.getStyle(this.element,'height'));this.startX=event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;this.startY=event.clientY+document.body.scrollTop+document.documentElement.scrollTop;this.currentDirection=dir;Event.stop(event);}}},finishResize:function(event,success){this.active=false;this.resizing=false;if(this.options.zindex)
this.element.style.zIndex=this.originalZ;if(this.options.resize){this.options.resize(this.element);}},keyPress:function(event){if(this.active){if(event.keyCode==Event.KEY_ESC){this.finishResize(event,false);Event.stop(event);}}},endResize:function(event){if(this.active&&this.resizing){this.finishResize(event,true);Event.stop(event);}
this.active=false;this.resizing=false;},draw:function(event){var pointer=[Event.pointerX(event),Event.pointerY(event)];var style=this.element.style;if(this.currentDirection.indexOf('n')!=-1){var pointerMoved=this.startY-pointer[1];var margin=Element.getStyle(this.element,'margin-top')||"0";var newHeight=this.startHeight+pointerMoved;if(newHeight>this.options.minHeight){style.height=newHeight+"px";style.top=(this.startTop-pointerMoved-parseInt(margin))+"px";}}
if(this.currentDirection.indexOf('w')!=-1){var pointerMoved=this.startX-pointer[0];var margin=Element.getStyle(this.element,'margin-left')||"0";var newWidth=this.startWidth+pointerMoved;if(newWidth>this.options.minWidth){style.left=(this.startLeft-pointerMoved-parseInt(margin))+"px";style.width=newWidth+"px";}}
if(this.currentDirection.indexOf('s')!=-1){var newHeight=this.startHeight+pointer[1]-this.startY;if(newHeight>this.options.minHeight){style.height=newHeight+"px";}}
if(this.currentDirection.indexOf('e')!=-1){var newWidth=this.startWidth+pointer[0]-this.startX;if(newWidth>this.options.minWidth){style.width=newWidth+"px";}}
if(style.visibility=="hidden")style.visibility="";},between:function(val,low,high){return(val>=low&&val<high);},directions:function(event){var pointer=[Event.pointerX(event),Event.pointerY(event)];var offsets=Position.cumulativeOffset(this.element);var cursor='';if(this.between(pointer[1]-offsets[1],0,this.options.top))cursor+='n';if(this.between((offsets[1]+this.element.offsetHeight)-pointer[1],0,this.options.bottom))cursor+='s';if(this.between(pointer[0]-offsets[0],0,this.options.left))cursor+='w';if(this.between((offsets[0]+this.element.offsetWidth)-pointer[0],0,this.options.right))cursor+='e';return cursor;},cursor:function(event){var cursor=this.directions(event);if(cursor.length>0){cursor+='-resize';}else{cursor='';}
this.element.style.cursor=cursor;},update:function(event){if(this.active){if(!this.resizing){var style=this.element.style;this.resizing=true;if(Element.getStyle(this.element,'position')=='')
style.position="relative";if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,'z-index')||0);style.zIndex=this.options.zindex;}}
this.draw(event);if(this.options.duringresize){this.options.duringresize(this.element);}
if(navigator.appVersion.indexOf('AppleWebKit')>0)window.scrollBy(0,0);Event.stop(event);return false;}}}
if(!document.createElement('canvas').getContext){(function(){var m=Math;var mr=m.round;var ms=m.sin;var mc=m.cos;var abs=m.abs;var sqrt=m.sqrt;var Z=10;var Z2=Z/2;function getContext(){return this.context_||(this.context_=new CanvasRenderingContext2D_(this));}
var slice=Array.prototype.slice;function bind(f,obj,var_args){var a=slice.call(arguments,2);return function(){return f.apply(obj,a.concat(slice.call(arguments)));};}
var G_vmlCanvasManager_={init:function(opt_doc){if(/MSIE/.test(navigator.userAgent)&&!window.opera){var doc=opt_doc||document;doc.createElement('canvas');doc.attachEvent('onreadystatechange',bind(this.init_,this,doc));}},init_:function(doc){if(!doc.namespaces['g_vml_']){doc.namespaces.add('g_vml_','urn:schemas-microsoft-com:vml','#default#VML');}
if(!doc.namespaces['g_o_']){doc.namespaces.add('g_o_','urn:schemas-microsoft-com:office:office','#default#VML');}
if(!doc.styleSheets['ex_canvas_']){var ss=doc.createStyleSheet();ss.owningElement.id='ex_canvas_';ss.cssText='canvas{display:inline-block;overflow:hidden;'+'text-align:left;width:300px;height:150px}'+'g_vml_\\:*{behavior:url(#default#VML)}'+'g_o_\\:*{behavior:url(#default#VML)}';}
var els=doc.getElementsByTagName('canvas');for(var i=0;i<els.length;i++){this.initElement(els[i]);}},initElement:function(el){if(!el.getContext){el.getContext=getContext;el.innerHTML='';el.attachEvent('onpropertychange',onPropertyChange);el.attachEvent('onresize',onResize);var attrs=el.attributes;if(attrs.width&&attrs.width.specified){el.style.width=attrs.width.nodeValue+'px';}else{el.width=el.clientWidth;}
if(attrs.height&&attrs.height.specified){el.style.height=attrs.height.nodeValue+'px';}else{el.height=el.clientHeight;}}
return el;}};function onPropertyChange(e){var el=e.srcElement;switch(e.propertyName){case'width':el.style.width=el.attributes.width.nodeValue+'px';el.getContext().clearRect();break;case'height':el.style.height=el.attributes.height.nodeValue+'px';el.getContext().clearRect();break;}}
function onResize(e){var el=e.srcElement;if(el.firstChild){el.firstChild.style.width=el.clientWidth+'px';el.firstChild.style.height=el.clientHeight+'px';}}
G_vmlCanvasManager_.init();var dec2hex=[];for(var i=0;i<16;i++){for(var j=0;j<16;j++){dec2hex[i*16+j]=i.toString(16)+j.toString(16);}}
function createMatrixIdentity(){return[[1,0,0],[0,1,0],[0,0,1]];}
function matrixMultiply(m1,m2){var result=createMatrixIdentity();for(var x=0;x<3;x++){for(var y=0;y<3;y++){var sum=0;for(var z=0;z<3;z++){sum+=m1[x][z]*m2[z][y];}
result[x][y]=sum;}}
return result;}
function copyState(o1,o2){o2.fillStyle=o1.fillStyle;o2.lineCap=o1.lineCap;o2.lineJoin=o1.lineJoin;o2.lineWidth=o1.lineWidth;o2.miterLimit=o1.miterLimit;o2.shadowBlur=o1.shadowBlur;o2.shadowColor=o1.shadowColor;o2.shadowOffsetX=o1.shadowOffsetX;o2.shadowOffsetY=o1.shadowOffsetY;o2.strokeStyle=o1.strokeStyle;o2.globalAlpha=o1.globalAlpha;o2.arcScaleX_=o1.arcScaleX_;o2.arcScaleY_=o1.arcScaleY_;o2.lineScale_=o1.lineScale_;}
function processStyle(styleString){var str,alpha=1;styleString=String(styleString);if(styleString.substring(0,3)=='rgb'){var start=styleString.indexOf('(',3);var end=styleString.indexOf(')',start+1);var guts=styleString.substring(start+1,end).split(',');str='#';for(var i=0;i<3;i++){str+=dec2hex[Number(guts[i])];}
if(guts.length==4&&styleString.substr(3,1)=='a'){alpha=guts[3];}}else{str=styleString;}
return{color:str,alpha:alpha};}
function processLineCap(lineCap){switch(lineCap){case'butt':return'flat';case'round':return'round';case'square':default:return'square';}}
function CanvasRenderingContext2D_(surfaceElement){this.m_=createMatrixIdentity();this.mStack_=[];this.aStack_=[];this.currentPath_=[];this.strokeStyle='#000';this.fillStyle='#000';this.lineWidth=1;this.lineJoin='miter';this.lineCap='butt';this.miterLimit=Z*1;this.globalAlpha=1;this.canvas=surfaceElement;var el=surfaceElement.ownerDocument.createElement('div');el.style.width=surfaceElement.clientWidth+'px';el.style.height=surfaceElement.clientHeight+'px';el.style.overflow='hidden';el.style.position='absolute';surfaceElement.appendChild(el);this.element_=el;this.arcScaleX_=1;this.arcScaleY_=1;this.lineScale_=1;}
var contextPrototype=CanvasRenderingContext2D_.prototype;contextPrototype.clearRect=function(){this.element_.innerHTML='';};contextPrototype.beginPath=function(){this.currentPath_=[];};contextPrototype.moveTo=function(aX,aY){var p=this.getCoords_(aX,aY);this.currentPath_.push({type:'moveTo',x:p.x,y:p.y});this.currentX_=p.x;this.currentY_=p.y;};contextPrototype.lineTo=function(aX,aY){var p=this.getCoords_(aX,aY);this.currentPath_.push({type:'lineTo',x:p.x,y:p.y});this.currentX_=p.x;this.currentY_=p.y;};contextPrototype.bezierCurveTo=function(aCP1x,aCP1y,aCP2x,aCP2y,aX,aY){var p=this.getCoords_(aX,aY);var cp1=this.getCoords_(aCP1x,aCP1y);var cp2=this.getCoords_(aCP2x,aCP2y);bezierCurveTo(this,cp1,cp2,p);};function bezierCurveTo(self,cp1,cp2,p){self.currentPath_.push({type:'bezierCurveTo',cp1x:cp1.x,cp1y:cp1.y,cp2x:cp2.x,cp2y:cp2.y,x:p.x,y:p.y});self.currentX_=p.x;self.currentY_=p.y;}
contextPrototype.quadraticCurveTo=function(aCPx,aCPy,aX,aY){var cp=this.getCoords_(aCPx,aCPy);var p=this.getCoords_(aX,aY);var cp1={x:this.currentX_+2.0/3.0*(cp.x-this.currentX_),y:this.currentY_+2.0/3.0*(cp.y-this.currentY_)};var cp2={x:cp1.x+(p.x-this.currentX_)/3.0,y:cp1.y+(p.y-this.currentY_)/3.0};bezierCurveTo(this,cp1,cp2,p);};contextPrototype.arc=function(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){aRadius*=Z;var arcType=aClockwise?'at':'wa';var xStart=aX+mc(aStartAngle)*aRadius-Z2;var yStart=aY+ms(aStartAngle)*aRadius-Z2;var xEnd=aX+mc(aEndAngle)*aRadius-Z2;var yEnd=aY+ms(aEndAngle)*aRadius-Z2;if(xStart==xEnd&&!aClockwise){xStart+=0.125;}
var p=this.getCoords_(aX,aY);var pStart=this.getCoords_(xStart,yStart);var pEnd=this.getCoords_(xEnd,yEnd);this.currentPath_.push({type:arcType,x:p.x,y:p.y,radius:aRadius,xStart:pStart.x,yStart:pStart.y,xEnd:pEnd.x,yEnd:pEnd.y});};contextPrototype.rect=function(aX,aY,aWidth,aHeight){this.moveTo(aX,aY);this.lineTo(aX+aWidth,aY);this.lineTo(aX+aWidth,aY+aHeight);this.lineTo(aX,aY+aHeight);this.closePath();};contextPrototype.strokeRect=function(aX,aY,aWidth,aHeight){var oldPath=this.currentPath_;this.beginPath();this.moveTo(aX,aY);this.lineTo(aX+aWidth,aY);this.lineTo(aX+aWidth,aY+aHeight);this.lineTo(aX,aY+aHeight);this.closePath();this.stroke();this.currentPath_=oldPath;};contextPrototype.fillRect=function(aX,aY,aWidth,aHeight){var oldPath=this.currentPath_;this.beginPath();this.moveTo(aX,aY);this.lineTo(aX+aWidth,aY);this.lineTo(aX+aWidth,aY+aHeight);this.lineTo(aX,aY+aHeight);this.closePath();this.fill();this.currentPath_=oldPath;};contextPrototype.createLinearGradient=function(aX0,aY0,aX1,aY1){var gradient=new CanvasGradient_('gradient');gradient.x0_=aX0;gradient.y0_=aY0;gradient.x1_=aX1;gradient.y1_=aY1;return gradient;};contextPrototype.createRadialGradient=function(aX0,aY0,aR0,aX1,aY1,aR1){var gradient=new CanvasGradient_('gradientradial');gradient.x0_=aX0;gradient.y0_=aY0;gradient.r0_=aR0;gradient.x1_=aX1;gradient.y1_=aY1;gradient.r1_=aR1;return gradient;};contextPrototype.drawImage=function(image,var_args){var dx,dy,dw,dh,sx,sy,sw,sh;var oldRuntimeWidth=image.runtimeStyle.width;var oldRuntimeHeight=image.runtimeStyle.height;image.runtimeStyle.width='auto';image.runtimeStyle.height='auto';var w=image.width;var h=image.height;image.runtimeStyle.width=oldRuntimeWidth;image.runtimeStyle.height=oldRuntimeHeight;if(arguments.length==3){dx=arguments[1];dy=arguments[2];sx=sy=0;sw=dw=w;sh=dh=h;}else if(arguments.length==5){dx=arguments[1];dy=arguments[2];dw=arguments[3];dh=arguments[4];sx=sy=0;sw=w;sh=h;}else if(arguments.length==9){sx=arguments[1];sy=arguments[2];sw=arguments[3];sh=arguments[4];dx=arguments[5];dy=arguments[6];dw=arguments[7];dh=arguments[8];}else{throw Error('Invalid number of arguments');}
var d=this.getCoords_(dx,dy);var w2=sw/2;var h2=sh/2;var vmlStr=[];var W=10;var H=10;vmlStr.push(' <g_vml_:group',' coordsize="',Z*W,',',Z*H,'"',' coordorigin="0,0"',' style="width:',W,'px;height:',H,'px;position:absolute;');if(this.m_[0][0]!=1||this.m_[0][1]){var filter=[];filter.push('M11=',this.m_[0][0],',','M12=',this.m_[1][0],',','M21=',this.m_[0][1],',','M22=',this.m_[1][1],',','Dx=',mr(d.x/Z),',','Dy=',mr(d.y/Z),'');var max=d;var c2=this.getCoords_(dx+dw,dy);var c3=this.getCoords_(dx,dy+dh);var c4=this.getCoords_(dx+dw,dy+dh);max.x=m.max(max.x,c2.x,c3.x,c4.x);max.y=m.max(max.y,c2.y,c3.y,c4.y);vmlStr.push('padding:0 ',mr(max.x/Z),'px ',mr(max.y/Z),'px 0;filter:progid:DXImageTransform.Microsoft.Matrix(',filter.join(''),", sizingmethod='clip');")}else{vmlStr.push('top:',mr(d.y/Z),'px;left:',mr(d.x/Z),'px;');}
vmlStr.push(' ">','<g_vml_:image src="',image.src,'"',' style="width:',Z*dw,'px;',' height:',Z*dh,'px;"',' cropleft="',sx/w,'"',' croptop="',sy/h,'"',' cropright="',(w-sx-sw)/w,'"',' cropbottom="',(h-sy-sh)/h,'"',' />','</g_vml_:group>');this.element_.insertAdjacentHTML('BeforeEnd',vmlStr.join(''));};contextPrototype.stroke=function(aFill){var lineStr=[];var lineOpen=false;var a=processStyle(aFill?this.fillStyle:this.strokeStyle);var color=a.color;var opacity=a.alpha*this.globalAlpha;var W=10;var H=10;lineStr.push('<g_vml_:shape',' filled="',!!aFill,'"',' style="position:absolute;width:',W,'px;height:',H,'px;"',' coordorigin="0 0" coordsize="',Z*W,' ',Z*H,'"',' stroked="',!aFill,'"',' path="');var newSeq=false;var min={x:null,y:null};var max={x:null,y:null};for(var i=0;i<this.currentPath_.length;i++){var p=this.currentPath_[i];var c;switch(p.type){case'moveTo':c=p;lineStr.push(' m ',mr(p.x),',',mr(p.y));break;case'lineTo':lineStr.push(' l ',mr(p.x),',',mr(p.y));break;case'close':lineStr.push(' x ');p=null;break;case'bezierCurveTo':lineStr.push(' c ',mr(p.cp1x),',',mr(p.cp1y),',',mr(p.cp2x),',',mr(p.cp2y),',',mr(p.x),',',mr(p.y));break;case'at':case'wa':lineStr.push(' ',p.type,' ',mr(p.x-this.arcScaleX_*p.radius),',',mr(p.y-this.arcScaleY_*p.radius),' ',mr(p.x+this.arcScaleX_*p.radius),',',mr(p.y+this.arcScaleY_*p.radius),' ',mr(p.xStart),',',mr(p.yStart),' ',mr(p.xEnd),',',mr(p.yEnd));break;}
if(p){if(min.x==null||p.x<min.x){min.x=p.x;}
if(max.x==null||p.x>max.x){max.x=p.x;}
if(min.y==null||p.y<min.y){min.y=p.y;}
if(max.y==null||p.y>max.y){max.y=p.y;}}}
lineStr.push(' ">');if(!aFill){var lineWidth=this.lineScale_*this.lineWidth;if(lineWidth<1){opacity*=lineWidth;}
lineStr.push('<g_vml_:stroke',' opacity="',opacity,'"',' joinstyle="',this.lineJoin,'"',' miterlimit="',this.miterLimit,'"',' endcap="',processLineCap(this.lineCap),'"',' weight="',lineWidth,'px"',' color="',color,'" />');}else if(this.fillStyle instanceof CanvasGradient_){var fillStyle=this.fillStyle;var angle=0;var focus={x:0,y:0};var shift=0;var expansion=1;if(fillStyle.type_=='gradient'){var x0=fillStyle.x0_/this.arcScaleX_;var y0=fillStyle.y0_/this.arcScaleY_;var x1=fillStyle.x1_/this.arcScaleX_;var y1=fillStyle.y1_/this.arcScaleY_;var p0=this.getCoords_(x0,y0);var p1=this.getCoords_(x1,y1);var dx=p1.x-p0.x;var dy=p1.y-p0.y;angle=Math.atan2(dx,dy)*180/Math.PI;if(angle<0){angle+=360;}
if(angle<1e-6){angle=0;}}else{var p0=this.getCoords_(fillStyle.x0_,fillStyle.y0_);var width=max.x-min.x;var height=max.y-min.y;focus={x:(p0.x-min.x)/width,y:(p0.y-min.y)/height};width/=this.arcScaleX_*Z;height/=this.arcScaleY_*Z;var dimension=m.max(width,height);shift=2*fillStyle.r0_/dimension;expansion=2*fillStyle.r1_/dimension-shift;}
var stops=fillStyle.colors_;stops.sort(function(cs1,cs2){return cs1.offset-cs2.offset;});var length=stops.length;var color1=stops[0].color;var color2=stops[length-1].color;var opacity1=stops[0].alpha*this.globalAlpha;var opacity2=stops[length-1].alpha*this.globalAlpha;var colors=[];for(var i=0;i<length;i++){var stop=stops[i];colors.push(stop.offset*expansion+shift+' '+stop.color);}
lineStr.push('<g_vml_:fill type="',fillStyle.type_,'"',' method="none" focus="100%"',' color="',color1,'"',' color2="',color2,'"',' colors="',colors.join(','),'"',' opacity="',opacity2,'"',' g_o_:opacity2="',opacity1,'"',' angle="',angle,'"',' focusposition="',focus.x,',',focus.y,'" />');}else if(this.fillStyle instanceof CanvasPattern_){var ws=max.x-min.x;var hs=max.y-min.y;if(ws&&hs){var deltaLeft=-min.x;var deltaTop=-min.y;lineStr.push('<g_vml_:fill',' position="',deltaLeft/ws*this.arcScaleX_*this.arcScaleX_,',',deltaTop/hs*this.arcScaleY_*this.arcScaleY_,'"',' type="tile"',' src="',this.fillStyle.src_,'" />');}}else{lineStr.push('<g_vml_:fill color="',color,'" opacity="',opacity,'" />');}
lineStr.push('</g_vml_:shape>');this.element_.insertAdjacentHTML('beforeEnd',lineStr.join(''));};contextPrototype.fill=function(){this.stroke(true);}
contextPrototype.closePath=function(){this.currentPath_.push({type:'close'});};contextPrototype.getCoords_=function(aX,aY){var m=this.m_;return{x:Z*(aX*m[0][0]+aY*m[1][0]+m[2][0])-Z2,y:Z*(aX*m[0][1]+aY*m[1][1]+m[2][1])-Z2}};contextPrototype.save=function(){var o={};copyState(this,o);this.aStack_.push(o);this.mStack_.push(this.m_);this.m_=matrixMultiply(createMatrixIdentity(),this.m_);};contextPrototype.restore=function(){copyState(this.aStack_.pop(),this);this.m_=this.mStack_.pop();};function matrixIsFinite(m){for(var j=0;j<3;j++){for(var k=0;k<2;k++){if(!isFinite(m[j][k])||isNaN(m[j][k])){return false;}}}
return true;}
function setM(ctx,m,updateLineScale){if(!matrixIsFinite(m)){return;}
ctx.m_=m;if(updateLineScale){var det=m[0][0]*m[1][1]-m[0][1]*m[1][0];ctx.lineScale_=sqrt(abs(det));}}
contextPrototype.translate=function(aX,aY){var m1=[[1,0,0],[0,1,0],[aX,aY,1]];setM(this,matrixMultiply(m1,this.m_),false);};contextPrototype.rotate=function(aRot){var c=mc(aRot);var s=ms(aRot);var m1=[[c,s,0],[-s,c,0],[0,0,1]];setM(this,matrixMultiply(m1,this.m_),false);};contextPrototype.scale=function(aX,aY){this.arcScaleX_*=aX;this.arcScaleY_*=aY;var m1=[[aX,0,0],[0,aY,0],[0,0,1]];setM(this,matrixMultiply(m1,this.m_),true);};contextPrototype.transform=function(m11,m12,m21,m22,dx,dy){var m1=[[m11,m12,0],[m21,m22,0],[dx,dy,1]];setM(this,matrixMultiply(m1,this.m_),true);};contextPrototype.setTransform=function(m11,m12,m21,m22,dx,dy){var m=[[m11,m12,0],[m21,m22,0],[dx,dy,1]];setM(this,m,true);};contextPrototype.clip=function(){};contextPrototype.arcTo=function(){};contextPrototype.createPattern=function(image,repetition){return new CanvasPattern_(image,repetition);};function CanvasGradient_(aType){this.type_=aType;this.x0_=0;this.y0_=0;this.r0_=0;this.x1_=0;this.y1_=0;this.r1_=0;this.colors_=[];}
CanvasGradient_.prototype.addColorStop=function(aOffset,aColor){aColor=processStyle(aColor);this.colors_.push({offset:aOffset,color:aColor.color,alpha:aColor.alpha});};function CanvasPattern_(image,repetition){assertImageIsValid(image);switch(repetition){case'repeat':case null:case'':this.repetition_='repeat';break
case'repeat-x':case'repeat-y':case'no-repeat':this.repetition_=repetition;break;default:throwException('SYNTAX_ERR');}
this.src_=image.src;this.width_=image.width;this.height_=image.height;}
function throwException(s){throw new DOMException_(s);}
function assertImageIsValid(img){if(!img||img.nodeType!=1||img.tagName!='IMG'){throwException('TYPE_MISMATCH_ERR');}
if(img.readyState!='complete'){throwException('INVALID_STATE_ERR');}}
function DOMException_(s){this.code=this[s];this.message=s+': DOM Exception '+this.code;};var p=DOMException_.prototype=new Error;p.INDEX_SIZE_ERR=1;p.DOMSTRING_SIZE_ERR=2;p.HIERARCHY_REQUEST_ERR=3;p.WRONG_DOCUMENT_ERR=4;p.INVALID_CHARACTER_ERR=5;p.NO_DATA_ALLOWED_ERR=6;p.NO_MODIFICATION_ALLOWED_ERR=7;p.NOT_FOUND_ERR=8;p.NOT_SUPPORTED_ERR=9;p.INUSE_ATTRIBUTE_ERR=10;p.INVALID_STATE_ERR=11;p.SYNTAX_ERR=12;p.INVALID_MODIFICATION_ERR=13;p.NAMESPACE_ERR=14;p.INVALID_ACCESS_ERR=15;p.VALIDATION_ERR=16;p.TYPE_MISMATCH_ERR=17;G_vmlCanvasManager=G_vmlCanvasManager_;CanvasRenderingContext2D=CanvasRenderingContext2D_;CanvasGradient=CanvasGradient_;CanvasPattern=CanvasPattern_;DOMException=DOMException_;})();}
var Flotr={version:'%version%',author:'Bas Wenneker',website:'http://www.solutoire.com',_registeredTypes:{'lines':'drawSeriesLines','points':'drawSeriesPoints','bars':'drawSeriesBars','candles':'drawSeriesCandles','pie':'drawSeriesPie'},register:function(type,functionName){Flotr._registeredTypes[type]=functionName+'';},draw:function(el,data,options,_GraphKlass_){_GraphKlass_=_GraphKlass_||Flotr.Graph;return new _GraphKlass_(el,data,options);},getSeries:function(data){return data.collect(function(serie){var i;serie=(serie.data)?Object.clone(serie):{'data':serie};for(i=serie.data.length-1;i>-1;--i){serie.data[i][1]=(serie.data[i][1]===null?null:parseFloat(serie.data[i][1]));}
return serie;});},merge:function(src,dest){var result=dest||{};for(var i in src){result[i]=(src[i]!=null&&typeof(src[i])=='object'&&!(src[i].constructor==Array||src[i].constructor==RegExp)&&!Object.isElement(src[i]))?Flotr.merge(src[i],dest[i]):result[i]=src[i];}
return result;},getTickSize:function(noTicks,min,max,decimals){var delta=(max-min)/noTicks;var magn=Flotr.getMagnitude(delta);var norm=delta/magn;var tickSize=10;if(norm<1.5)tickSize=1;else if(norm<2.25)tickSize=2;else if(norm<3)tickSize=((decimals==0)?2:2.5);else if(norm<7.5)tickSize=5;return tickSize*magn;},defaultTickFormatter:function(val){return val+'';},defaultTrackFormatter:function(obj){return'('+obj.x+', '+obj.y+')';},defaultPieLabelFormatter:function(slice){return(slice.fraction*100).toFixed(2)+'%';},convertToBytes:function(value,precision,base){var sizes=['Y','Z','E','P','T','G','M','k',''],fractionSizes=['y','z','a','f','p','n','','m',''],total=sizes.length;base=base||1024;precision=precision||2;if(value==0)return 0;if(value>1){while(total--&&(value>1))value/=base;}
else{sizes=fractionSizes;total=sizes.length;while(total--&&(value<1))value*=base;}
return(Math.round(value*precision)/precision)+sizes[total];},getMagnitude:function(x){return Math.pow(10,Math.floor(Math.log(x)/Math.LN10));},toPixel:function(val){return Math.floor(val)+0.5;},toRad:function(angle){return-angle*(Math.PI/180);},parseColor:function(str){if(str instanceof Flotr.Color)return str;var result,Color=Flotr.Color;if((result=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(str)))
return new Color(parseInt(result[1]),parseInt(result[2]),parseInt(result[3]));if((result=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(str)))
return new Color(parseInt(result[1]),parseInt(result[2]),parseInt(result[3]),parseFloat(result[4]));if((result=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(str)))
return new Color(parseFloat(result[1])*2.55,parseFloat(result[2])*2.55,parseFloat(result[3])*2.55);if((result=/rgba\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(str)))
return new Color(parseFloat(result[1])*2.55,parseFloat(result[2])*2.55,parseFloat(result[3])*2.55,parseFloat(result[4]));if((result=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(str)))
return new Color(parseInt(result[1],16),parseInt(result[2],16),parseInt(result[3],16));if((result=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(str)))
return new Color(parseInt(result[1]+result[1],16),parseInt(result[2]+result[2],16),parseInt(result[3]+result[3],16));var name=str.strip().toLowerCase();if(name=='transparent'){return new Color(255,255,255,0);}
return((result=Color.lookupColors[name]))?new Color(result[0],result[1],result[2]):false;},extractColor:function(element){var color;do{color=element.getStyle('background-color').toLowerCase();if(!(color==''||color=='transparent'))break;element=element.up(0);}while(!element.nodeName.match(/^body$/i));return(color=='rgba(0, 0, 0, 0)')?'transparent':color;}};Flotr.Graph=Class.create({initialize:function(el,data,options){this.el=$(el);if(!this.el)throw'The target container doesn\'t exist';this.data=data;this.series=Flotr.getSeries(data);this.setOptions(options);this.lastMousePos={pageX:null,pageY:null};this.selection={first:{x:-1,y:-1},second:{x:-1,y:-1}};this.plotOffset={left:0,right:0,top:0,bottom:0};this.prevSelection=null;this.selectionInterval=null;this.ignoreClick=false;this.prevHit=null;this.constructCanvas();this.initEvents();this.findDataRanges();this.calculateTicks(this.axes.x);this.calculateTicks(this.axes.x2);this.calculateTicks(this.axes.y);this.calculateTicks(this.axes.y2);this.calculateSpacing();this.draw();this.insertLegend();if(this.options.spreadsheet.show)this.constructTabs();},setOptions:function(opts){var options={colors:['#00A8F0','#C0D800','#CB4B4B','#4DA74D','#9440ED'],title:null,subtitle:null,legend:{show:true,noColumns:1,labelFormatter:Prototype.K,labelBoxBorderColor:'#CCCCCC',labelBoxWidth:14,labelBoxHeight:10,labelBoxMargin:5,container:null,position:'nw',margin:5,backgroundColor:null,backgroundOpacity:0.85},xaxis:{ticks:null,showLabels:true,labelsAngle:0,title:null,titleAngle:0,noTicks:5,tickFormatter:Flotr.defaultTickFormatter,tickDecimals:null,min:null,max:null,autoscaleMargin:0,color:null},x2axis:{},yaxis:{ticks:null,showLabels:true,labelsAngle:0,title:null,titleAngle:90,noTicks:5,tickFormatter:Flotr.defaultTickFormatter,tickDecimals:null,min:null,max:null,autoscaleMargin:0,color:null},y2axis:{titleAngle:270},points:{show:false,radius:3,lineWidth:2,fill:true,fillColor:'#FFFFFF',fillOpacity:0.4},lines:{show:false,lineWidth:2,fill:false,fillColor:null,fillOpacity:0.4},bars:{show:false,lineWidth:2,barWidth:1,fill:true,fillColor:null,fillOpacity:0.4,horizontal:false,stacked:false,centered:true},candles:{show:false,lineWidth:1,wickLineWidth:1,candleWidth:0.6,fill:true,upFillColor:'#00A8F0',downFillColor:'#CB4B4B',fillOpacity:0.5,barcharts:false},pie:{show:false,lineWidth:1,fill:true,fillColor:null,fillOpacity:0.6,explode:6,sizeRatio:0.6,startAngle:Math.PI/4,labelFormatter:Flotr.defaultPieLabelFormatter,pie3D:false,pie3DviewAngle:(Math.PI/2*0.8),pie3DspliceThickness:20},grid:{color:'#545454',backgroundColor:null,tickColor:'#DDDDDD',labelMargin:3,verticalLines:true,horizontalLines:true,outlineWidth:2},selection:{mode:null,color:'#B6D9FF',fps:20},crosshair:{mode:null,color:'#FF0000',hideCursor:true},mouse:{track:false,position:'se',relative:false,trackFormatter:Flotr.defaultTrackFormatter,margin:5,lineColor:'#FF3F19',trackDecimals:1,sensibility:2,radius:3,fillColor:null,fillOpacity:0.4},shadowSize:4,defaultType:'lines',HtmlText:true,fontSize:7.5,spreadsheet:{show:false,tabGraphLabel:'Graph',tabDataLabel:'Data',toolbarDownload:'Download CSV',toolbarSelectAll:'Select all'}};options.x2axis=Object.extend(Object.clone(options.xaxis),options.x2axis);options.y2axis=Object.extend(Object.clone(options.yaxis),options.y2axis);this.options=Flotr.merge((opts||{}),options);this.axes={x:{options:this.options.xaxis,n:1},x2:{options:this.options.x2axis,n:2},y:{options:this.options.yaxis,n:1},y2:{options:this.options.y2axis,n:2}};var assignedColors=[],colors=[],ln=this.series.length,neededColors=this.series.length,oc=this.options.colors,usedColors=[],variation=0,c,i,j,s,tooClose;for(i=neededColors-1;i>-1;--i){c=this.series[i].color;if(c!=null){--neededColors;if(Object.isNumber(c))assignedColors.push(c);else usedColors.push(Flotr.parseColor(c));}}
for(i=assignedColors.length-1;i>-1;--i)
neededColors=Math.max(neededColors,assignedColors[i]+1);for(i=0;colors.length<neededColors;){c=(oc.length==i)?new Flotr.Color(100,100,100):Flotr.parseColor(oc[i]);var sign=variation%2==1?-1:1;var factor=1+sign*Math.ceil(variation/2)*0.2;c.scale(factor,factor,factor);colors.push(c);if(++i>=oc.length){i=0;++variation;}}
for(i=0,j=0;i<ln;++i){s=this.series[i];if(s.color==null){s.color=colors[j++].toString();}else if(Object.isNumber(s.color)){s.color=colors[s.color].toString();}
if(!s.xaxis)s.xaxis=this.axes.x;if(s.xaxis==1)s.xaxis=this.axes.x;else if(s.xaxis==2)s.xaxis=this.axes.x2;if(!s.yaxis)s.yaxis=this.axes.y;if(s.yaxis==1)s.yaxis=this.axes.y;else if(s.yaxis==2)s.yaxis=this.axes.y2;s.lines=Object.extend(Object.clone(this.options.lines),s.lines);s.points=Object.extend(Object.clone(this.options.points),s.points);s.bars=Object.extend(Object.clone(this.options.bars),s.bars);s.candles=Object.extend(Object.clone(this.options.candles),s.candles);s.pie=Object.extend(Object.clone(this.options.pie),s.pie);s.mouse=Object.extend(Object.clone(this.options.mouse),s.mouse);if(s.shadowSize==null)s.shadowSize=this.options.shadowSize;}},constructCanvas:function(){var el=this.el,size,c,oc;this.canvas=el.select('.flotr-canvas')[0];this.overlay=el.select('.flotr-overlay')[0];el.childElements().invoke('remove');el.setStyle({position:'relative',cursor:'default'});this.canvasWidth=el.getWidth();this.canvasHeight=el.getHeight();size={'width':this.canvasWidth,'height':this.canvasHeight};if(this.canvasWidth<=0||this.canvasHeight<=0){throw'Invalid dimensions for plot, width = '+this.canvasWidth+', height = '+this.canvasHeight;}
if(!this.canvas){c=this.canvas=$(document.createElement('canvas'));c.className='flotr-canvas';c.writeAttribute('style','position:absolute;left:0px;top:0px;');}
c=this.canvas.writeAttribute(size).show();el.insert(c);if(!this.overlay){oc=this.overlay=$(document.createElement('canvas'));oc.className='flotr-overlay';oc.writeAttribute('style','position:absolute;left:0px;top:0px;');}
oc=this.overlay.writeAttribute(size).show();el.insert(oc);if(Prototype.Browser.IE){window.G_vmlCanvasManager.initElement(c);window.G_vmlCanvasManager.initElement(oc);}
this.ctx=c.getContext('2d');this.octx=oc.getContext('2d');this.textEnabled=!!this.ctx.drawText;},getTextDimensions:function(text,canvasStyle,HtmlStyle,className){if(!text)return{width:0,height:0};if(!this.options.HtmlText&&this.textEnabled){var bounds=this.ctx.getTextBounds(text,canvasStyle);return{width:bounds.width+2,height:bounds.height+6};}
else{var dummyDiv=this.el.insert('<div style="position:absolute;top:-10000px;'+HtmlStyle+'" class="'+className+' flotr-dummy-div">'+text+'</div>').select(".flotr-dummy-div")[0];dim=dummyDiv.getDimensions();dummyDiv.remove();return dim;}},loadDataGrid:function(){if(this.seriesData)return this.seriesData;var s=this.series,dg=[];for(i=0;i<s.length;++i){s[i].data.each(function(v){var x=v[0],y=v[1],r=dg.find(function(row){return row[0]==x});if(r)r[i+1]=y;else{var newRow=[];newRow[0]=x;newRow[i+1]=y;dg.push(newRow);}});}
dg=dg.sortBy(function(v){return v[0];});return this.seriesData=dg;},showTab:function(tabName){var elementsClassNames='canvas, .flotr-labels, .flotr-legend, .flotr-legend-bg, .flotr-title, .flotr-subtitle';switch(tabName){case'graph':this.datagrid.up().hide();this.el.select(elementsClassNames).invoke('show');this.tabs.data.removeClassName('selected');this.tabs.graph.addClassName('selected');break;case'data':this.constructDataGrid();this.datagrid.up().show();this.el.select(elementsClassNames).invoke('hide');this.tabs.data.addClassName('selected');this.tabs.graph.removeClassName('selected');break;}},constructTabs:function(){var tabsContainer=new Element('div',{className:'flotr-tabs-group',style:'position:absolute;left:0px;top:'+this.canvasHeight+'px;width:'+this.canvasWidth+'px;'});this.el.insert({bottom:tabsContainer});this.tabs={graph:new Element('div',{className:'flotr-tab selected',style:'float:left;'}).update(this.options.spreadsheet.tabGraphLabel),data:new Element('div',{className:'flotr-tab',style:'float:left;'}).update(this.options.spreadsheet.tabDataLabel)};tabsContainer.insert(this.tabs.graph).insert(this.tabs.data);this.el.setStyle({height:this.canvasHeight+this.tabs.data.getHeight()+2+'px'});this.tabs.graph.observe('click',(function(){this.showTab('graph')}).bind(this));this.tabs.data.observe('click',(function(){this.showTab('data')}).bind(this));},constructDataGrid:function(){if(this.datagrid)return this.datagrid;var i,j,s=this.series,datagrid=this.loadDataGrid(),t=this.datagrid=new Element('table',{className:'flotr-datagrid',style:'height:100px;'}),colgroup=['<colgroup><col />'];var html=['<tr class="first-row">'];html.push('<th>&nbsp;</th>');for(i=0;i<s.length;++i){html.push('<th scope="col">'+(s[i].label||String.fromCharCode(65+i))+'</th>');colgroup.push('<col />');}
html.push('</tr>');for(j=0;j<datagrid.length;++j){html.push('<tr>');for(i=0;i<s.length+1;++i){var tag='td';var content=(datagrid[j][i]!=null?Math.round(datagrid[j][i]*100000)/100000:'');if(i==0){tag='th';var label;if(this.options.xaxis.ticks){var tick=this.options.xaxis.ticks.find(function(x){return x[0]==datagrid[j][i]});if(tick)label=tick[1];}
else{label=this.options.xaxis.tickFormatter(content);}
if(label)content=label;}
html.push('<'+tag+(tag=='th'?' scope="row"':'')+'>'+content+'</'+tag+'>');}
html.push('</tr>');}
colgroup.push('</colgroup>');t.update(colgroup.join('')+html.join(''));if(!Prototype.Browser.IE){t.select('td').each(function(td){td.observe('mouseover',function(e){td=e.element();var siblings=td.previousSiblings();t.select('th[scope=col]')[siblings.length-1].addClassName('hover');t.select('colgroup col')[siblings.length].addClassName('hover');});td.observe('mouseout',function(){t.select('colgroup col.hover, th.hover').each(function(e){e.removeClassName('hover')});});});}
var toolbar=new Element('div',{className:'flotr-datagrid-toolbar'}).insert(new Element('button',{type:'button',className:'flotr-datagrid-toolbar-button'}).update(this.options.spreadsheet.toolbarDownload).observe('click',this.downloadCSV.bind(this))).insert(new Element('button',{type:'button',className:'flotr-datagrid-toolbar-button'}).update(this.options.spreadsheet.toolbarSelectAll).observe('click',this.selectAllData.bind(this)));var container=new Element('div',{className:'flotr-datagrid-container',style:'left:0px;top:0px;width:'+this.canvasWidth+'px;height:'+this.canvasHeight+'px;overflow:auto;'});container.insert(toolbar);t.wrap(container.hide());this.el.insert(container);return t;},selectAllData:function(){if(this.tabs){var selection,range,doc,win,node=this.constructDataGrid();this.showTab('data');(function(){if((doc=node.ownerDocument)&&(win=doc.defaultView)&&win.getSelection&&doc.createRange&&(selection=window.getSelection())&&selection.removeAllRanges){range=doc.createRange();range.selectNode(node);selection.removeAllRanges();selection.addRange(range);}
else if(document.body&&document.body.createTextRange&&(range=document.body.createTextRange())){range.moveToElementText(node);range.select();}}).defer();return true;}
else return false;},downloadCSV:function(){var i,csv='"x"',series=this.series,dg=this.loadDataGrid();for(i=0;i<series.length;++i){csv+='%09"'+(series[i].label||String.fromCharCode(65+i))+'"';}
csv+="%0D%0A";for(i=0;i<dg.length;++i){if(this.options.xaxis.ticks){var tick=this.options.xaxis.ticks.find(function(x){return x[0]==dg[i][0]});if(tick)dg[i][0]=tick[1];}
else{dg[i][0]=this.options.xaxis.tickFormatter(dg[i][0]);}
csv+=dg[i].join('%09')+"%0D%0A";}
if(Prototype.Browser.IE){csv=csv.gsub('%09','\t').gsub('%0A','\n').gsub('%0D','\r');window.open().document.write(csv);}
else window.open('data:text/csv,'+csv);},initEvents:function(){this.overlay.stopObserving();this.overlay.observe('mousedown',this.mouseDownHandler.bind(this));this.overlay.observe('mousemove',this.mouseMoveHandler.bind(this));this.overlay.observe('click',this.clickHandler.bind(this));},findDataRanges:function(){var s=this.series,a=this.axes;a.x.datamin=a.x.datamax=a.x2.datamin=a.x2.datamax=a.y.datamin=a.y.datamax=a.y2.datamin=a.y2.datamax=0;if(s.length>0){var i,j,h,x,y,data,xaxis,yaxis;for(i=0;i<s.length;++i){data=s[i].data,xaxis=s[i].xaxis,yaxis=s[i].yaxis;if(data.length>0&&!s[i].hide){if(!xaxis.used)xaxis.datamin=xaxis.datamax=data[0][0];if(!yaxis.used)yaxis.datamin=yaxis.datamax=data[0][1];xaxis.used=true;yaxis.used=true;for(h=data.length-1;h>-1;--h){x=data[h][0];if(x<xaxis.datamin)xaxis.datamin=x;else if(x>xaxis.datamax)xaxis.datamax=x;for(j=1;j<data[h].length;j++){y=data[h][j];if(y<yaxis.datamin)yaxis.datamin=y;else if(y>yaxis.datamax)yaxis.datamax=y;}}}}}
this.findXAxesValues();this.calculateRange(a.x);this.extendXRangeIfNeededByBar(a.x);if(a.x2.used){this.calculateRange(a.x2);this.extendXRangeIfNeededByBar(a.x2);}
this.calculateRange(a.y);this.extendYRangeIfNeededByBar(a.y);if(a.y2.used){this.calculateRange(a.y2);this.extendYRangeIfNeededByBar(a.y2);}},calculateRange:function(axis){var o=axis.options,min=o.min!=null?o.min:axis.datamin,max=o.max!=null?o.max:axis.datamax,margin;if(max-min==0.0){var widen=(max==0.0)?1.0:0.01;min-=widen;max+=widen;}
axis.tickSize=Flotr.getTickSize(o.noTicks,min,max,o.tickDecimals);if(o.min==null){margin=o.autoscaleMargin;if(margin!=0){min-=axis.tickSize*margin;if(min<0&&axis.datamin>=0)min=0;min=axis.tickSize*Math.floor(min/axis.tickSize);}}
if(o.max==null){margin=o.autoscaleMargin;if(margin!=0){max+=axis.tickSize*margin;if(max>0&&axis.datamax<=0)max=0;max=axis.tickSize*Math.ceil(max/axis.tickSize);}}
axis.min=min;axis.max=max;},extendXRangeIfNeededByBar:function(axis){if(axis.options.max==null){var newmin=axis.min,newmax=axis.max,i,s,b,c,stackedSums=[],lastSerie=null;for(i=0;i<this.series.length;++i){s=this.series[i];b=s.bars;c=s.candles;if(s.xaxis==axis){if(c.show||(b.centered&&b.show)){newmax=Math.max(axis.datamax+0.5,newmax);newmin=Math.min(axis.datamin-0.5,newmin);}
if(b.show){if(!b.horizontal&&(b.barWidth+axis.datamax>newmax))
newmax=axis.max+(b.centered?b.barWidth/2:b.barWidth);if(b.stacked&&b.horizontal){for(j=0;j<s.data.length;j++){if(b.show&&b.stacked){var x=s.data[j][0]+'';stackedSums[x]=(stackedSums[x]||0)+s.data[j][1];lastSerie=s;}}
for(var j in stackedSums){newmax=Math.max(stackedSums[j],newmax);}}}}}
axis.lastSerie=lastSerie;axis.max=newmax;axis.min=newmin;}},extendYRangeIfNeededByBar:function(axis){if(axis.options.max==null){var newmax=axis.max,i,s,b,c,stackedSums={},lastSerie=null;for(i=0;i<this.series.length;++i){s=this.series[i];b=s.bars;c=s.candles;if(s.yaxis==axis&&b.show&&!s.hide){if(b.horizontal&&(b.barWidth+axis.datamax>newmax)||(c.candleWidth+axis.datamax>newmax)){newmax=axis.max+b.barWidth;}
if(b.stacked&&!b.horizontal){for(j=0;j<s.data.length;j++){if(s.bars.show&&s.bars.stacked){var x=s.data[j][0]+'';stackedSums[x]=(stackedSums[x]||0)+s.data[j][1];lastSerie=s;}}
for(var j in stackedSums){newmax=Math.max(stackedSums[j],newmax);}}}}
axis.lastSerie=lastSerie;axis.max=newmax;}},findXAxesValues:function(){for(i=this.series.length-1;i>-1;--i){s=this.series[i];s.xaxis.values=s.xaxis.values||{};for(j=s.data.length-1;j>-1;--j){s.xaxis.values[s.data[j][0]+'']={};}}},calculateTicks:function(axis){var o=axis.options,i,v;axis.ticks=[];if(o.ticks){var ticks=o.ticks,t,label;if(Object.isFunction(ticks)){ticks=ticks({min:axis.min,max:axis.max});}
for(i=0;i<ticks.length;++i){t=ticks[i];if(typeof(t)=='object'){v=t[0];label=(t.length>1)?t[1]:o.tickFormatter(v);}else{v=t;label=o.tickFormatter(v);}
axis.ticks[i]={v:v,label:label};}}
else{var start=axis.tickSize*Math.ceil(axis.min/axis.tickSize),decimals;for(i=0;start+i*axis.tickSize<=axis.max;++i){v=start+i*axis.tickSize;decimals=o.tickDecimals;if(decimals==null)decimals=1-Math.floor(Math.log(axis.tickSize)/Math.LN10);if(decimals<0)decimals=0;v=v.toFixed(decimals);axis.ticks.push({v:v,label:o.tickFormatter(v)});}}},calculateSpacing:function(){var a=this.axes,options=this.options,series=this.series,margin=options.grid.labelMargin,x=a.x,x2=a.x2,y=a.y,y2=a.y2,maxOutset=2,i,j,l,dim;[x,x2,y,y2].each(function(axis){var maxLabel='';if(axis.options.showLabels){for(i=0;i<axis.ticks.length;++i){l=axis.ticks[i].label.length;if(l>maxLabel.length){maxLabel=axis.ticks[i].label;}}}
axis.maxLabel=this.getTextDimensions(maxLabel,{size:options.fontSize,angle:Flotr.toRad(axis.options.labelsAngle)},'font-size:smaller;','flotr-grid-label');axis.titleSize=this.getTextDimensions(axis.options.title,{size:options.fontSize*1.2,angle:Flotr.toRad(axis.options.titleAngle)},'font-weight:bold;','flotr-axis-title');},this);dim=this.getTextDimensions(options.title,{size:options.fontSize*1.5},'font-size:1em;font-weight:bold;','flotr-title');this.titleHeight=dim.height;dim=this.getTextDimensions(options.subtitle,{size:options.fontSize},'font-size:smaller;','flotr-subtitle');this.subtitleHeight=dim.height;if(options.show){maxOutset=Math.max(maxOutset,options.points.radius+options.points.lineWidth/2);}
for(j=0;j<options.length;++j){if(series[j].points.show){maxOutset=Math.max(maxOutset,series[j].points.radius+series[j].points.lineWidth/2);}}
var p=this.plotOffset;p.bottom+=(x.options.showLabels?(x.maxLabel.height+margin):0)+
(x.options.title?(x.titleSize.height+margin):0)+maxOutset;p.top+=(x2.options.showLabels?(x2.maxLabel.height+margin):0)+
(x2.options.title?(x2.titleSize.height+margin):0)+this.subtitleHeight+this.titleHeight+maxOutset;p.left+=(y.options.showLabels?(y.maxLabel.width+margin):0)+
(y.options.title?(y.titleSize.width+margin):0)+maxOutset;p.right+=(y2.options.showLabels?(y2.maxLabel.width+margin):0)+
(y2.options.title?(y2.titleSize.width+margin):0)+maxOutset;p.top=Math.floor(p.top);this.plotWidth=this.canvasWidth-p.left-p.right;this.plotHeight=this.canvasHeight-p.bottom-p.top;x.scale=this.plotWidth/(x.max-x.min);x2.scale=this.plotWidth/(x2.max-x2.min);y.scale=this.plotHeight/(y.max-y.min);y2.scale=this.plotHeight/(y2.max-y2.min);},draw:function(){this.drawGrid();this.drawLabels();this.drawTitles();if(this.series.length){this.el.fire('flotr:beforedraw',[this.series,this]);for(var i=0;i<this.series.length;i++){if(!this.series[i].hide)
this.drawSeries(this.series[i]);}}
this.el.fire('flotr:afterdraw',[this.series,this]);},tHoz:function(x,axis){axis=axis||this.axes.x;return(x-axis.min)*axis.scale;},tVert:function(y,axis){axis=axis||this.axes.y;return this.plotHeight-(y-axis.min)*axis.scale;},drawGrid:function(){var v,o=this.options,ctx=this.ctx;if(o.grid.verticalLines||o.grid.horizontalLines){this.el.fire('flotr:beforegrid',[this.axes.x,this.axes.y,o,this]);}
ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);if(o.grid.backgroundColor!=null){ctx.fillStyle=o.grid.backgroundColor;ctx.fillRect(0,0,this.plotWidth,this.plotHeight);}
ctx.lineWidth=1;ctx.strokeStyle=o.grid.tickColor;ctx.beginPath();if(o.grid.verticalLines){for(var i=0;i<this.axes.x.ticks.length;++i){v=this.axes.x.ticks[i].v;if((v==this.axes.x.min||v==this.axes.x.max)&&o.grid.outlineWidth!=0)
continue;ctx.moveTo(Math.floor(this.tHoz(v))+ctx.lineWidth/2,0);ctx.lineTo(Math.floor(this.tHoz(v))+ctx.lineWidth/2,this.plotHeight);}}
if(o.grid.horizontalLines){for(var j=0;j<this.axes.y.ticks.length;++j){v=this.axes.y.ticks[j].v;if((v==this.axes.y.min||v==this.axes.y.max)&&o.grid.outlineWidth!=0)
continue;ctx.moveTo(0,Math.floor(this.tVert(v))+ctx.lineWidth/2);ctx.lineTo(this.plotWidth,Math.floor(this.tVert(v))+ctx.lineWidth/2);}}
ctx.stroke();if(o.grid.outlineWidth!=0){ctx.lineWidth=o.grid.outlineWidth;ctx.strokeStyle=o.grid.color;ctx.lineJoin='round';ctx.strokeRect(0,0,this.plotWidth,this.plotHeight);}
ctx.restore();if(o.grid.verticalLines||o.grid.horizontalLines){this.el.fire('flotr:aftergrid',[this.axes.x,this.axes.y,o,this]);}},drawLabels:function(){var noLabels=0,axis,xBoxWidth,i,html,tick,options=this.options,ctx=this.ctx,a=this.axes;for(i=0;i<a.x.ticks.length;++i){if(a.x.ticks[i].label){++noLabels;}}
xBoxWidth=this.plotWidth/noLabels;if(!options.HtmlText&&this.textEnabled){var style={size:options.fontSize,adjustAlign:true};axis=a.x;style.color=axis.options.color||options.grid.color;for(i=0;i<axis.ticks.length&&axis.options.showLabels&&axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='c';style.valign='t';ctx.drawText(tick.label,this.plotOffset.left+this.tHoz(tick.v,axis),this.plotOffset.top+this.plotHeight+options.grid.labelMargin,style);}
axis=a.x2;style.color=axis.options.color||options.grid.color;for(i=0;i<axis.ticks.length&&axis.options.showLabels&&axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='c';style.valign='b';ctx.drawText(tick.label,this.plotOffset.left+this.tHoz(tick.v,axis),this.plotOffset.top+options.grid.labelMargin,style);}
axis=a.y;style.color=axis.options.color||options.grid.color;for(i=0;i<axis.ticks.length&&axis.options.showLabels&&axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='r';style.valign='m';ctx.drawText(tick.label,this.plotOffset.left-options.grid.labelMargin,this.plotOffset.top+this.tVert(tick.v,axis),style);}
axis=a.y2;style.color=axis.options.color||options.grid.color;for(i=0;i<axis.ticks.length&&axis.options.showLabels&&axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='l';style.valign='m';ctx.drawText(tick.label,this.plotOffset.left+this.plotWidth+options.grid.labelMargin,this.plotOffset.top+this.tVert(tick.v,axis),style);ctx.save();ctx.strokeStyle=style.color;ctx.beginPath();ctx.moveTo(this.plotOffset.left+this.plotWidth-8,this.plotOffset.top+this.tVert(tick.v,axis));ctx.lineTo(this.plotOffset.left+this.plotWidth,this.plotOffset.top+this.tVert(tick.v,axis));ctx.stroke();ctx.restore();}}
else if(a.x.options.showLabels||a.x2.options.showLabels||a.y.options.showLabels||a.y2.options.showLabels){html=['<div style="font-size:smaller;color:'+options.grid.color+';" class="flotr-labels">'];axis=a.x;if(axis.options.showLabels){for(i=0;i<axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0||(this.plotOffset.left+this.tHoz(tick.v,axis)<0)||(this.plotOffset.left+this.tHoz(tick.v,axis)>this.canvasWidth))continue;html.push('<div style="position:absolute;top:'+(this.plotOffset.top+this.plotHeight+options.grid.labelMargin)+'px;left:'+(this.plotOffset.left+this.tHoz(tick.v,axis)-xBoxWidth/2)+'px;width:'+xBoxWidth+'px;text-align:center;'+(axis.options.color?('color:'+axis.options.color+';'):'')+'" class="flotr-grid-label">'+tick.label+'</div>');}}
axis=a.x2;if(axis.options.showLabels&&axis.used){for(i=0;i<axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0||(this.plotOffset.left+this.tHoz(tick.v,axis)<0)||(this.plotOffset.left+this.tHoz(tick.v,axis)>this.canvasWidth))continue;html.push('<div style="position:absolute;top:'+(this.plotOffset.top-options.grid.labelMargin-axis.maxLabel.height)+'px;left:'+(this.plotOffset.left+this.tHoz(tick.v,axis)-xBoxWidth/2)+'px;width:'+xBoxWidth+'px;text-align:center;'+(axis.options.color?('color:'+axis.options.color+';'):'')+'" class="flotr-grid-label">'+tick.label+'</div>');}}
axis=a.y;if(axis.options.showLabels){for(i=0;i<axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0||(this.plotOffset.top+this.tVert(tick.v,axis)<0)||(this.plotOffset.top+this.tVert(tick.v,axis)>this.canvasHeight))continue;html.push('<div style="position:absolute;top:'+(this.plotOffset.top+this.tVert(tick.v,axis)-axis.maxLabel.height/2)+'px;left:0;width:'+(this.plotOffset.left-options.grid.labelMargin)+'px;text-align:right;'+(axis.options.color?('color:'+axis.options.color+';'):'')+'" class="flotr-grid-label">'+tick.label+'</div>');}}
axis=a.y2;if(axis.options.showLabels&&axis.used){ctx.save();ctx.strokeStyle=axis.options.color||options.grid.color;ctx.beginPath();for(i=0;i<axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0||(this.plotOffset.top+this.tVert(tick.v,axis)<0)||(this.plotOffset.top+this.tVert(tick.v,axis)>this.canvasHeight))continue;html.push('<div style="position:absolute;top:'+(this.plotOffset.top+this.tVert(tick.v,axis)-axis.maxLabel.height/2)+'px;right:0;width:'+(this.plotOffset.right-options.grid.labelMargin)+'px;text-align:left;'+(axis.options.color?('color:'+axis.options.color+';'):'')+'" class="flotr-grid-label">'+tick.label+'</div>');ctx.moveTo(this.plotOffset.left+this.plotWidth-8,this.plotOffset.top+this.tVert(tick.v,axis));ctx.lineTo(this.plotOffset.left+this.plotWidth,this.plotOffset.top+this.tVert(tick.v,axis));}
ctx.stroke();ctx.restore();}
html.push('</div>');this.el.insert(html.join(''));}},drawTitles:function(){var html,options=this.options,margin=options.grid.labelMargin,ctx=this.ctx,a=this.axes;if(!options.HtmlText&&this.textEnabled){var style={size:options.fontSize,color:options.grid.color,halign:'c'};if(options.subtitle){ctx.drawText(options.subtitle,this.plotOffset.left+this.plotWidth/2,this.titleHeight+this.subtitleHeight-2,style);}
style.weight=1.5;style.size*=1.5;if(options.title){ctx.drawText(options.title,this.plotOffset.left+this.plotWidth/2,this.titleHeight-2,style);}
style.weight=1.8;style.size*=0.8;style.adjustAlign=true;if(a.x.options.title&&a.x.used){style.halign='c';style.valign='t';style.angle=Flotr.toRad(a.x.options.titleAngle);ctx.drawText(a.x.options.title,this.plotOffset.left+this.plotWidth/2,this.plotOffset.top+a.x.maxLabel.height+this.plotHeight+2*margin,style);}
if(a.x2.options.title&&a.x2.used){style.halign='c';style.valign='b';style.angle=Flotr.toRad(a.x2.options.titleAngle);ctx.drawText(a.x2.options.title,this.plotOffset.left+this.plotWidth/2,this.plotOffset.top-a.x2.maxLabel.height-2*margin,style);}
if(a.y.options.title&&a.y.used){style.halign='r';style.valign='m';style.angle=Flotr.toRad(a.y.options.titleAngle);ctx.drawText(a.y.options.title,this.plotOffset.left-a.y.maxLabel.width-2*margin,this.plotOffset.top+this.plotHeight/2,style);}
if(a.y2.options.title&&a.y2.used){style.halign='l';style.valign='m';style.angle=Flotr.toRad(a.y2.options.titleAngle);ctx.drawText(a.y2.options.title,this.plotOffset.left+this.plotWidth+a.y2.maxLabel.width+2*margin,this.plotOffset.top+this.plotHeight/2,style);}}
else{html=['<div style="color:'+options.grid.color+';" class="flotr-titles">'];if(options.title)
html.push('<div style="position:absolute;top:0;left:'+this.plotOffset.left+'px;font-size:1em;font-weight:bold;text-align:center;width:'+this.plotWidth+'px;" class="flotr-title">'+options.title+'</div>');if(options.subtitle)
html.push('<div style="position:absolute;top:'+this.titleHeight+'px;left:'+this.plotOffset.left+'px;font-size:smaller;text-align:center;width:'+this.plotWidth+'px;" class="flotr-subtitle">'+options.subtitle+'</div>');html.push('</div>');html.push('<div class="flotr-axis-title" style="font-weight:bold;">');if(a.x.options.title&&a.x.used)
html.push('<div style="position:absolute;top:'+(this.plotOffset.top+this.plotHeight+options.grid.labelMargin+a.x.titleSize.height)+'px;left:'+this.plotOffset.left+'px;width:'+this.plotWidth+'px;text-align:center;" class="flotr-axis-title">'+a.x.options.title+'</div>');if(a.x2.options.title&&a.x2.used)
html.push('<div style="position:absolute;top:0;left:'+this.plotOffset.left+'px;width:'+this.plotWidth+'px;text-align:center;" class="flotr-axis-title">'+a.x2.options.title+'</div>');if(a.y.options.title&&a.y.used)
html.push('<div style="position:absolute;top:'+(this.plotOffset.top+this.plotHeight/2-a.y.titleSize.height/2)+'px;left:0;text-align:right;" class="flotr-axis-title">'+a.y.options.title+'</div>');if(a.y2.options.title&&a.y2.used)
html.push('<div style="position:absolute;top:'+(this.plotOffset.top+this.plotHeight/2-a.y.titleSize.height/2)+'px;right:0;text-align:right;" class="flotr-axis-title">'+a.y2.options.title+'</div>');html.push('</div>');this.el.insert(html.join(''));}},drawSeries:function(series){series=series||this.series;var drawn=false;for(var type in Flotr._registeredTypes){if(series[type]&&series[type].show){this[Flotr._registeredTypes[type]](series);drawn=true;}}
if(!drawn){this[Flotr._registeredTypes[this.options.defaultType]](series);}},plotLine:function(series,offset){var ctx=this.ctx,xa=series.xaxis,ya=series.yaxis,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),data=series.data;if(data.length<2)return;var prevx=tHoz(data[0][0],xa),prevy=tVert(data[0][1],ya)+offset;ctx.beginPath();ctx.moveTo(prevx,prevy);for(var i=0;i<data.length-1;++i){var x1=data[i][0],y1=data[i][1],x2=data[i+1][0],y2=data[i+1][1];if(y1===null||y2===null)continue;if(y1<=y2&&y1<ya.min){if(y2<ya.min)continue;x1=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.min;}
else if(y2<=y1&&y2<ya.min){if(y1<ya.min)continue;x2=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.min;}
if(y1>=y2&&y1>ya.max){if(y2>ya.max)continue;x1=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.max;}
else if(y2>=y1&&y2>ya.max){if(y1>ya.max)continue;x2=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.max;}
if(x1<=x2&&x1<xa.min){if(x2<xa.min)continue;y1=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.min;}
else if(x2<=x1&&x2<xa.min){if(x1<xa.min)continue;y2=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.min;}
if(x1>=x2&&x1>xa.max){if(x2>xa.max)continue;y1=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.max;}
else if(x2>=x1&&x2>xa.max){if(x1>xa.max)continue;y2=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.max;}
if(prevx!=tHoz(x1,xa)||prevy!=tVert(y1,ya)+offset)
ctx.moveTo(tHoz(x1,xa),tVert(y1,ya)+offset);prevx=tHoz(x2,xa);prevy=tVert(y2,ya)+offset;ctx.lineTo(prevx,prevy);}
ctx.stroke();},plotLineArea:function(series,offset){var data=series.data;if(data.length<2)return;var top,lastX=0,ctx=this.ctx,xa=series.xaxis,ya=series.yaxis,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),bottom=Math.min(Math.max(0,ya.min),ya.max),first=true;ctx.beginPath();for(var i=0;i<data.length-1;++i){var x1=data[i][0],y1=data[i][1],x2=data[i+1][0],y2=data[i+1][1];if(x1<=x2&&x1<xa.min){if(x2<xa.min)continue;y1=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.min;}
else if(x2<=x1&&x2<xa.min){if(x1<xa.min)continue;y2=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.min;}
if(x1>=x2&&x1>xa.max){if(x2>xa.max)continue;y1=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.max;}
else if(x2>=x1&&x2>xa.max){if(x1>xa.max)continue;y2=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.max;}
if(first){ctx.moveTo(tHoz(x1,xa),tVert(bottom,ya)+offset);first=false;}
if(y1>=ya.max&&y2>=ya.max){ctx.lineTo(tHoz(x1,xa),tVert(ya.max,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(ya.max,ya)+offset);continue;}
else if(y1<=ya.min&&y2<=ya.min){ctx.lineTo(tHoz(x1,xa),tVert(ya.min,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(ya.min,ya)+offset);continue;}
var x1old=x1,x2old=x2;if(y1<=y2&&y1<ya.min&&y2>=ya.min){x1=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.min;}
else if(y2<=y1&&y2<ya.min&&y1>=ya.min){x2=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.min;}
if(y1>=y2&&y1>ya.max&&y2<=ya.max){x1=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.max;}
else if(y2>=y1&&y2>ya.max&&y1<=ya.max){x2=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.max;}
if(x1!=x1old){top=(y1<=ya.min)?top=ya.min:ya.max;ctx.lineTo(tHoz(x1old,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(x1,xa),tVert(top,ya)+offset);}
ctx.lineTo(tHoz(x1,xa),tVert(y1,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(y2,ya)+offset);if(x2!=x2old){top=(y2<=ya.min)?ya.min:ya.max;ctx.lineTo(tHoz(x2old,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(top,ya)+offset);}
lastX=Math.max(x2,x2old);}
ctx.lineTo(tHoz(lastX,xa),tVert(bottom,ya)+offset);ctx.closePath();ctx.fill();},drawSeriesLines:function(series){series=series||this.series;var ctx=this.ctx;ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);ctx.lineJoin='round';var lw=series.lines.lineWidth;var sw=series.shadowSize;if(sw>0){ctx.lineWidth=sw/2;var offset=lw/2+ctx.lineWidth/2;ctx.strokeStyle="rgba(0,0,0,0.1)";this.plotLine(series,offset+sw/2);ctx.strokeStyle="rgba(0,0,0,0.2)";this.plotLine(series,offset);if(series.lines.fill){ctx.fillStyle="rgba(0,0,0,0.05)";this.plotLineArea(series,offset+sw/2);}}
ctx.lineWidth=lw;ctx.strokeStyle=series.color;if(series.lines.fill){ctx.fillStyle=series.lines.fillColor!=null?series.lines.fillColor:Flotr.parseColor(series.color).scale(null,null,null,series.lines.fillOpacity).toString();this.plotLineArea(series,0);}
this.plotLine(series,0);ctx.restore();},drawSeriesPoints:function(series){var ctx=this.ctx;ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);var lw=series.lines.lineWidth;var sw=series.shadowSize;if(sw>0){ctx.lineWidth=sw/2;ctx.strokeStyle='rgba(0,0,0,0.1)';this.plotPointShadows(series,sw/2+ctx.lineWidth/2,series.points.radius);ctx.strokeStyle='rgba(0,0,0,0.2)';this.plotPointShadows(series,ctx.lineWidth/2,series.points.radius);}
ctx.lineWidth=series.points.lineWidth;ctx.strokeStyle=series.color;ctx.fillStyle=series.points.fillColor!=null?series.points.fillColor:series.color;this.plotPoints(series,series.points.radius,series.points.fill);ctx.restore();},plotPoints:function(series,radius,fill){var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,i,data=series.data;for(i=data.length-1;i>-1;--i){var x=data[i][0],y=data[i][1];if(y===null||x<xa.min||x>xa.max||y<ya.min||y>ya.max)
continue;ctx.beginPath();ctx.arc(this.tHoz(x,xa),this.tVert(y,ya),radius,0,2*Math.PI,true);if(fill)ctx.fill();ctx.stroke();}},plotPointShadows:function(series,offset,radius){var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,i,data=series.data;for(i=data.length-1;i>-1;--i){var x=data[i][0],y=data[i][1];if(y===null||x<xa.min||x>xa.max||y<ya.min||y>ya.max)
continue;ctx.beginPath();ctx.arc(this.tHoz(x,xa),this.tVert(y,ya)+offset,radius,0,Math.PI,false);ctx.stroke();}},drawSeriesBars:function(series){var ctx=this.ctx,bw=series.bars.barWidth,lw=Math.min(series.bars.lineWidth,bw);ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);ctx.lineJoin='miter';ctx.lineWidth=lw;ctx.strokeStyle=series.color;this.plotBarsShadows(series,bw,0,series.bars.fill);if(series.bars.fill){var color=series.bars.fillColor||series.color;ctx.fillStyle=Flotr.parseColor(color).scale(null,null,null,series.bars.fillOpacity).toString();}
this.plotBars(series,bw,0,series.bars.fill);ctx.restore();},plotBars:function(series,barWidth,offset,fill){var data=series.data;if(data.length<1)return;var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this);for(var i=0;i<data.length;i++){var x=data[i][0],y=data[i][1],drawLeft=true,drawTop=true,drawRight=true;if(y===null)continue;var stackOffset=0;if(series.bars.stacked){$H(xa.values).each(function(pair){if(pair.key==x){stackOffset=pair.value.stack||0;pair.value.stack=stackOffset+y;}});}
if(series.bars.horizontal)
var left=stackOffset,right=x+stackOffset,bottom=y,top=y+barWidth;else
var left=x-(series.bars.centered?barWidth/2:0),right=x+barWidth-(series.bars.centered?barWidth/2:0),bottom=stackOffset,top=y+stackOffset;if(right<xa.min||left>xa.max||top<ya.min||bottom>ya.max)
continue;if(left<xa.min){left=xa.min;drawLeft=false;}
if(right>xa.max){right=xa.max;if(xa.lastSerie!=series&&series.bars.horizontal)
drawTop=false;}
if(bottom<ya.min)
bottom=ya.min;if(top>ya.max){top=ya.max;if(ya.lastSerie!=series&&!series.bars.horizontal)
drawTop=false;}
if(fill){ctx.beginPath();ctx.moveTo(tHoz(left,xa),tVert(bottom,ya)+offset);ctx.lineTo(tHoz(left,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(right,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(right,xa),tVert(bottom,ya)+offset);ctx.fill();}
if(series.bars.lineWidth!=0&&(drawLeft||drawRight||drawTop)){ctx.beginPath();ctx.moveTo(tHoz(left,xa),tVert(bottom,ya)+offset);ctx[drawLeft?'lineTo':'moveTo'](tHoz(left,xa),tVert(top,ya)+offset);ctx[drawTop?'lineTo':'moveTo'](tHoz(right,xa),tVert(top,ya)+offset);ctx[drawRight?'lineTo':'moveTo'](tHoz(right,xa),tVert(bottom,ya)+offset);ctx.stroke();}}},plotBarsShadows:function(series,barWidth,offset){var data=series.data;if(data.length<1)return;var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),sw=this.options.shadowSize;for(var i=0;i<data.length;i++){var x=data[i][0],y=data[i][1];if(y===null)continue;var stackOffset=0;if(series.bars.stacked){$H(xa.values).each(function(pair){if(pair.key==x){stackOffset=pair.value.stackShadow||0;pair.value.stackShadow=stackOffset+y;}});}
if(series.bars.horizontal)
var left=stackOffset,right=x+stackOffset,bottom=y,top=y+barWidth;else
var left=x-(series.bars.centered?barWidth/2:0),right=x+barWidth-(series.bars.centered?barWidth/2:0),bottom=stackOffset,top=y+stackOffset;if(right<xa.min||left>xa.max||top<ya.min||bottom>ya.max)
continue;if(left<xa.min)left=xa.min;if(right>xa.max)right=xa.max;if(bottom<ya.min)bottom=ya.min;if(top>ya.max)top=ya.max;var width=tHoz(right,xa)-tHoz(left,xa)-((tHoz(right,xa)+sw<=this.plotWidth)?0:sw);var height=Math.max(0,tVert(bottom,ya)-tVert(top,ya)-((tVert(bottom,ya)+sw<=this.plotHeight)?0:sw));ctx.fillStyle='rgba(0,0,0,0.05)';ctx.fillRect(Math.min(tHoz(left,xa)+sw,this.plotWidth),Math.min(tVert(top,ya)+sw,this.plotWidth),width,height);}},drawSeriesCandles:function(series){var ctx=this.ctx,bw=series.candles.candleWidth;ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);ctx.lineJoin='miter';ctx.lineWidth=series.candles.lineWidth;this.plotCandlesShadows(series,bw/2);this.plotCandles(series,bw/2);ctx.restore();},plotCandles:function(series,offset){var data=series.data;if(data.length<1)return;var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this);for(var i=0;i<data.length;i++){var d=data[i],x=d[0],open=d[1],high=d[2],low=d[3],close=d[4];var left=x-series.candles.candleWidth/2,right=x+series.candles.candleWidth/2,bottom=Math.max(ya.min,low),top=Math.min(ya.max,high),bottom2=Math.max(ya.min,Math.min(open,close)),top2=Math.min(ya.max,Math.max(open,close));if(right<xa.min||left>xa.max||top<ya.min||bottom>ya.max)
continue;var color=series.candles[open>close?'downFillColor':'upFillColor'];if(series.candles.fill&&!series.candles.barcharts){ctx.fillStyle=Flotr.parseColor(color).scale(null,null,null,series.candles.fillOpacity).toString();ctx.fillRect(tHoz(left,xa),tVert(top2,ya)+offset,tHoz(right,xa)-tHoz(left,xa),tVert(bottom2,ya)-tVert(top2,ya));}
if(series.candles.lineWidth||series.candles.wickLineWidth){var x,y,pixelOffset=(series.candles.wickLineWidth%2)/2;x=Math.floor(tHoz((left+right)/2),xa)+pixelOffset;ctx.save();ctx.strokeStyle=color;ctx.lineWidth=series.candles.wickLineWidth;ctx.lineCap='butt';if(series.candles.barcharts){ctx.beginPath();ctx.moveTo(x,Math.floor(tVert(top,ya)+offset));ctx.lineTo(x,Math.floor(tVert(bottom,ya)+offset));y=Math.floor(tVert(open,ya)+offset)+0.5;ctx.moveTo(Math.floor(tHoz(left,xa))+pixelOffset,y);ctx.lineTo(x,y);y=Math.floor(tVert(close,ya)+offset)+0.5;ctx.moveTo(Math.floor(tHoz(right,xa))+pixelOffset,y);ctx.lineTo(x,y);}
else{ctx.strokeRect(tHoz(left,xa),tVert(top2,ya)+offset,tHoz(right,xa)-tHoz(left,xa),tVert(bottom2,ya)-tVert(top2,ya));ctx.beginPath();ctx.moveTo(x,Math.floor(tVert(top2,ya)+offset));ctx.lineTo(x,Math.floor(tVert(top,ya)+offset));ctx.moveTo(x,Math.floor(tVert(bottom2,ya)+offset));ctx.lineTo(x,Math.floor(tVert(bottom,ya)+offset));}
ctx.stroke();ctx.restore();}}},plotCandlesShadows:function(series,offset){var data=series.data;if(data.length<1||series.candles.barcharts)return;var xa=series.xaxis,ya=series.yaxis,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),sw=this.options.shadowSize;for(var i=0;i<data.length;i++){var d=data[i],x=d[0],open=d[1],high=d[2],low=d[3],close=d[4];var left=x-series.candles.candleWidth/2,right=x+series.candles.candleWidth/2,bottom=Math.max(ya.min,Math.min(open,close)),top=Math.min(ya.max,Math.max(open,close));if(right<xa.min||left>xa.max||top<ya.min||bottom>ya.max)
continue;var width=tHoz(right,xa)-tHoz(left,xa)-((tHoz(right,xa)+sw<=this.plotWidth)?0:sw);var height=Math.max(0,tVert(bottom,ya)-tVert(top,ya)-((tVert(bottom,ya)+sw<=this.plotHeight)?0:sw));this.ctx.fillStyle='rgba(0,0,0,0.05)';this.ctx.fillRect(Math.min(tHoz(left,xa)+sw,this.plotWidth),Math.min(tVert(top,ya)+sw,this.plotWidth),width,height);}},drawSeriesPie:function(series){if(this.options.pie.drawn)return;var ctx=this.ctx,options=this.options,lw=series.pie.lineWidth,sw=series.shadowSize,data=series.data,plotOffset=this.plotOffset,radius=(Math.min(this.canvasWidth,this.canvasHeight)*series.pie.sizeRatio)/2,html=[],vScale=1,plotTickness=Math.sin(series.pie.viewAngle)*series.pie.spliceThickness/vScale,style={size:options.fontSize*1.2,color:options.grid.color,weight:1.5},center={x:plotOffset.left+(this.plotWidth)/2,y:plotOffset.top+(this.plotHeight)/2},portions=this.series.collect(function(hash,index){if(hash.pie.show&&hash.data[0][1]!==null)
return{name:(hash.label||hash.data[0][1]),value:[index,hash.data[0][1]],options:hash.pie,series:hash};}),sum=portions.pluck('value').pluck(1).inject(0,function(acc,n){return acc+n;}),fraction=0.0,angle=series.pie.startAngle,value=0.0;var slices=portions.collect(function(slice){angle+=fraction;value=parseFloat(slice.value[1]);fraction=value/sum;return{name:slice.name,fraction:fraction,x:slice.value[0],y:value,options:slice.options,series:slice.series,startAngle:2*angle*Math.PI,endAngle:2*(angle+fraction)*Math.PI};});ctx.save();if(sw>0){slices.each(function(slice){if(slice.startAngle==slice.endAngle)return;var bisection=(slice.startAngle+slice.endAngle)/2,xOffset=center.x+Math.cos(bisection)*slice.options.explode+sw,yOffset=center.y+Math.sin(bisection)*slice.options.explode+sw;this.plotSlice(xOffset,yOffset,radius,slice.startAngle,slice.endAngle,false,vScale);if(series.pie.fill){ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fill();}},this);}
if(options.HtmlText||!this.textEnabled)
html=['<div style="color:'+this.options.grid.color+'" class="flotr-labels">'];slices.each(function(slice,index){if(slice.startAngle==slice.endAngle)return;var bisection=(slice.startAngle+slice.endAngle)/2,color=slice.series.color,fillColor=slice.options.fillColor||color,xOffset=center.x+Math.cos(bisection)*slice.options.explode,yOffset=center.y+Math.sin(bisection)*slice.options.explode;this.plotSlice(xOffset,yOffset,radius,slice.startAngle,slice.endAngle,false,vScale);if(series.pie.fill){ctx.fillStyle=Flotr.parseColor(fillColor).scale(null,null,null,series.pie.fillOpacity).toString();ctx.fill();}
ctx.lineWidth=lw;ctx.strokeStyle=color;ctx.stroke();var label=options.pie.labelFormatter(slice),textAlignRight=(Math.cos(bisection)<0),distX=xOffset+Math.cos(bisection)*(series.pie.explode+radius),distY=yOffset+Math.sin(bisection)*(series.pie.explode+radius);if(slice.fraction&&label){if(options.HtmlText||!this.textEnabled){var divStyle='position:absolute;top:'+(distY-5)+'px;';if(textAlignRight)
divStyle+='right:'+(this.canvasWidth-distX)+'px;text-align:right;';else
divStyle+='left:'+distX+'px;text-align:left;';html.push('<div style="'+divStyle+'" class="flotr-grid-label">'+label+'</div>');}
else{style.halign=textAlignRight?'r':'l';ctx.drawText(label,distX,distY+style.size/2,style);}}},this);if(options.HtmlText||!this.textEnabled){html.push('</div>');this.el.insert(html.join(''));}
ctx.restore();options.pie.drawn=true;},plotSlice:function(x,y,radius,startAngle,endAngle,fill,vScale){var ctx=this.ctx;vScale=vScale||1;ctx.scale(1,vScale);ctx.beginPath();ctx.moveTo(x,y);ctx.arc(x,y,radius,startAngle,endAngle,fill);ctx.lineTo(x,y);ctx.closePath();},insertLegend:function(){if(!this.options.legend.show)
return;var series=this.series,plotOffset=this.plotOffset,options=this.options,fragments=[],rowStarted=false,ctx=this.ctx,i;var noLegendItems=series.findAll(function(s){return(s.label&&!s.hide)}).size();if(noLegendItems){if(!options.HtmlText&&this.textEnabled){var style={size:options.fontSize*1.1,color:options.grid.color};var p=options.legend.position,m=options.legend.margin,lbw=options.legend.labelBoxWidth,lbh=options.legend.labelBoxHeight,lbm=options.legend.labelBoxMargin,offsetX=plotOffset.left+m,offsetY=plotOffset.top+m;var labelMaxWidth=0;for(i=series.length-1;i>-1;--i){if(!series[i].label||series[i].hide)continue;var label=options.legend.labelFormatter(series[i].label);labelMaxWidth=Math.max(labelMaxWidth,ctx.measureText(label,style));}
var legendWidth=Math.round(lbw+lbm*3+labelMaxWidth),legendHeight=Math.round(noLegendItems*(lbm+lbh)+lbm);if(p.charAt(0)=='s')offsetY=plotOffset.top+this.plotHeight-(m+legendHeight);if(p.charAt(1)=='e')offsetX=plotOffset.left+this.plotWidth-(m+legendWidth);var color=Flotr.parseColor(options.legend.backgroundColor||'rgb(240,240,240)').scale(null,null,null,options.legend.backgroundOpacity||0.1).toString();ctx.fillStyle=color;ctx.fillRect(offsetX,offsetY,legendWidth,legendHeight);ctx.strokeStyle=options.legend.labelBoxBorderColor;ctx.strokeRect(Flotr.toPixel(offsetX),Flotr.toPixel(offsetY),legendWidth,legendHeight);var x=offsetX+lbm;var y=offsetY+lbm;for(i=0;i<series.length;i++){if(!series[i].label||series[i].hide)continue;var label=options.legend.labelFormatter(series[i].label);ctx.fillStyle=series[i].color;ctx.fillRect(x,y,lbw-1,lbh-1);ctx.strokeStyle=options.legend.labelBoxBorderColor;ctx.lineWidth=1;ctx.strokeRect(Math.ceil(x)-1.5,Math.ceil(y)-1.5,lbw+2,lbh+2);ctx.drawText(label,x+lbw+lbm,y+(lbh+style.size-ctx.fontDescent(style))/2,style);y+=lbh+lbm;}}
else{for(i=0;i<series.length;++i){if(!series[i].label||series[i].hide)continue;if(i%options.legend.noColumns==0){fragments.push(rowStarted?'</tr><tr>':'<tr>');rowStarted=true;}
var legend=options.legend,s=series[i],label=legend.labelFormatter(s.label),boxWidth=legend.labelBoxWidth,boxHeight=legend.labelBoxHeight,opacity='opacity:'+s.bars.fillOpacity+';filter:alpha(opacity='+s.bars.fillOpacity+');',color='background-color:'+((s.bars.show&&s.bars.fillColor&&s.bars.fill)?s.bars.fillColor:s.color)+';';fragments.push('<td class="flotr-legend-color-box">','<div style="border:1px solid ',legend.labelBoxBorderColor,';padding:1px">','<div style="width:',(boxWidth-1),'px;height:',(boxHeight-1),'px;border:1px solid ',series[i].color,'">','<div style="width:',boxWidth,'px;height:',boxHeight,'px;',opacity,color,'"></div>','</div>','</div>','</td>','<td class="flotr-legend-label">',label,'</td>');}
if(rowStarted)fragments.push('</tr>');if(fragments.length>0){var table='<table style="font-size:smaller;color:'+options.grid.color+'">'+fragments.join("")+'</table>';if(options.legend.container!=null){$(options.legend.container).update(table);}
else{var pos='',p=options.legend.position,m=options.legend.margin;if(p.charAt(0)=='n')pos+='top:'+(m+plotOffset.top)+'px;';else if(p.charAt(0)=='s')pos+='bottom:'+(m+plotOffset.bottom)+'px;';if(p.charAt(1)=='e')pos+='right:'+(m+plotOffset.right)+'px;';else if(p.charAt(1)=='w')pos+='left:'+(m+plotOffset.left)+'px;';var div=this.el.insert('<div class="flotr-legend" style="position:absolute;z-index:2;'+pos+'">'+table+'</div>').select('div.flotr-legend').first();if(options.legend.backgroundOpacity!=0.0){var c=options.legend.backgroundColor;if(c==null){var tmp=(options.grid.backgroundColor!=null)?options.grid.backgroundColor:Flotr.extractColor(div);c=Flotr.parseColor(tmp).adjust(null,null,null,1).toString();}
this.el.insert('<div class="flotr-legend-bg" style="position:absolute;width:'+div.getWidth()+'px;height:'+div.getHeight()+'px;'+pos+'background-color:'+c+';"> </div>').select('div.flotr-legend-bg').first().setStyle({'opacity':options.legend.backgroundOpacity});}}}}}},getEventPosition:function(event){var offset=this.overlay.cumulativeOffset(),rx=(event.pageX-offset.left-this.plotOffset.left),ry=(event.pageY-offset.top-this.plotOffset.top),ax=0,ay=0;if(event.pageX==null&&event.clientX!=null){var de=document.documentElement,b=document.body;ax=event.clientX+(de&&de.scrollLeft||b.scrollLeft||0);ay=event.clientY+(de&&de.scrollTop||b.scrollTop||0);}else{ax=event.pageX;ay=event.pageY;}
return{x:this.axes.x.min+rx/this.axes.x.scale,x2:this.axes.x2.min+rx/this.axes.x2.scale,y:this.axes.y.max-ry/this.axes.y.scale,y2:this.axes.y2.max-ry/this.axes.y2.scale,relX:rx,relY:ry,absX:ax,absY:ay};},clickHandler:function(event){if(this.ignoreClick){this.ignoreClick=false;return;}
this.el.fire('flotr:click',[this.getEventPosition(event),this]);},mouseMoveHandler:function(event){var pos=this.getEventPosition(event);this.lastMousePos.pageX=pos.absX;this.lastMousePos.pageY=pos.absY;if(this.options.crosshair.mode)
this.clearCrosshair();if(this.selectionInterval==null&&(this.options.mouse.track||this.series.any(function(s){return s.mouse&&s.mouse.track;})))
this.hit(pos);if(this.options.crosshair.mode)
this.drawCrosshair(pos);this.el.fire('flotr:mousemove',[event,pos,this]);},mouseDownHandler:function(event){if(event.isRightClick()){event.stop();var overlay=this.overlay;overlay.hide();function cancelContextMenu(){overlay.show();$(document).stopObserving('mousemove',cancelContextMenu);}
$(document).observe('mousemove',cancelContextMenu);return;}
if(!this.options.selection.mode||!event.isLeftClick())return;this.setSelectionPos(this.selection.first,event);if(this.selectionInterval!=null){clearInterval(this.selectionInterval);}
this.lastMousePos.pageX=null;this.selectionInterval=setInterval(this.updateSelection.bind(this),1000/this.options.selection.fps);this.mouseUpHandler=this.mouseUpHandler.bind(this);$(document).observe('mouseup',this.mouseUpHandler);},fireSelectEvent:function(){var a=this.axes,selection=this.selection,x1=(selection.first.x<=selection.second.x)?selection.first.x:selection.second.x,x2=(selection.first.x<=selection.second.x)?selection.second.x:selection.first.x,y1=(selection.first.y>=selection.second.y)?selection.first.y:selection.second.y,y2=(selection.first.y>=selection.second.y)?selection.second.y:selection.first.y;x1=a.x.min+x1/a.x.scale;x2=a.x.min+x2/a.x.scale;y1=a.y.max-y1/a.y.scale;y2=a.y.max-y2/a.y.scale;this.el.fire('flotr:select',[{x1:x1,y1:y1,x2:x2,y2:y2},this]);},mouseUpHandler:function(event){$(document).stopObserving('mouseup',this.mouseUpHandler);event.stop();if(this.selectionInterval!=null){clearInterval(this.selectionInterval);this.selectionInterval=null;}
this.setSelectionPos(this.selection.second,event);this.clearSelection();if(this.selectionIsSane()){this.drawSelection();this.fireSelectEvent();this.ignoreClick=true;}},setSelectionPos:function(pos,event){var options=this.options,offset=$(this.overlay).cumulativeOffset();if(options.selection.mode.indexOf('x')==-1){pos.x=(pos==this.selection.first)?0:this.plotWidth;}else{pos.x=event.pageX-offset.left-this.plotOffset.left;pos.x=Math.min(Math.max(0,pos.x),this.plotWidth);}
if(options.selection.mode.indexOf('y')==-1){pos.y=(pos==this.selection.first)?0:this.plotHeight;}else{pos.y=event.pageY-offset.top-this.plotOffset.top;pos.y=Math.min(Math.max(0,pos.y),this.plotHeight);}},updateSelection:function(){if(this.lastMousePos.pageX==null)return;this.setSelectionPos(this.selection.second,this.lastMousePos);this.clearSelection();if(this.selectionIsSane())this.drawSelection();},clearSelection:function(){if(this.prevSelection==null)return;var prevSelection=this.prevSelection,lw=this.octx.lineWidth,plotOffset=this.plotOffset,x=Math.min(prevSelection.first.x,prevSelection.second.x),y=Math.min(prevSelection.first.y,prevSelection.second.y),w=Math.abs(prevSelection.second.x-prevSelection.first.x),h=Math.abs(prevSelection.second.y-prevSelection.first.y);this.octx.clearRect(x+plotOffset.left-lw/2+0.5,y+plotOffset.top-lw/2+0.5,w+lw,h+lw);this.prevSelection=null;},setSelection:function(area){var options=this.options,xa=this.axes.x,ya=this.axes.y,vertScale=ya.scale,hozScale=xa.scale,selX=options.selection.mode.indexOf('x')!=-1,selY=options.selection.mode.indexOf('y')!=-1;this.clearSelection();this.selection.first.y=selX?0:(ya.max-area.y1)*vertScale;this.selection.second.y=selX?this.plotHeight:(ya.max-area.y2)*vertScale;this.selection.first.x=selY?0:(area.x1-xa.min)*hozScale;this.selection.second.x=selY?this.plotWidth:(area.x2-xa.min)*hozScale;this.drawSelection();this.fireSelectEvent();},drawSelection:function(){var prevSelection=this.prevSelection,selection=this.selection,octx=this.octx,options=this.options,plotOffset=this.plotOffset;if(prevSelection!=null&&selection.first.x==prevSelection.first.x&&selection.first.y==prevSelection.first.y&&selection.second.x==prevSelection.second.x&&selection.second.y==prevSelection.second.y)
return;octx.save();octx.strokeStyle=Flotr.parseColor(options.selection.color).scale(null,null,null,0.8).toString();octx.lineWidth=1;octx.lineJoin='miter';octx.fillStyle=Flotr.parseColor(options.selection.color).scale(null,null,null,0.4).toString();this.prevSelection={first:{x:selection.first.x,y:selection.first.y},second:{x:selection.second.x,y:selection.second.y}};var x=Math.min(selection.first.x,selection.second.x),y=Math.min(selection.first.y,selection.second.y),w=Math.abs(selection.second.x-selection.first.x),h=Math.abs(selection.second.y-selection.first.y);octx.fillRect(x+plotOffset.left+0.5,y+plotOffset.top+0.5,w,h);octx.strokeRect(x+plotOffset.left+0.5,y+plotOffset.top+0.5,w,h);octx.restore();},drawCrosshair:function(pos){var octx=this.octx,options=this.options,plotOffset=this.plotOffset,x=plotOffset.left+pos.relX+0.5,y=plotOffset.top+pos.relY+0.5,modeX=options.crosshair.mode.indexOf('x')!=-1,modeY=options.crosshair.mode.indexOf('y')!=-1;if(pos.relX<0||pos.relY<0||pos.relX>this.plotWidth||pos.relY>this.plotHeight){this.el.style.cursor=null;this.el.removeClassName('flotr-crosshair');return;}
this.lastMousePos.relX=null;this.lastMousePos.relY=null;if(options.crosshair.hideCursor){this.el.style.cursor='url(blank.cur), crosshair';this.el.addClassName('flotr-crosshair');}
octx.save();octx.strokeStyle=options.crosshair.color;octx.lineWidth=1;octx.beginPath();if(modeX){octx.moveTo(x,plotOffset.top);octx.lineTo(x,plotOffset.top+this.plotHeight);this.lastMousePos.relX=x;}
if(modeY){octx.moveTo(plotOffset.left,y);octx.lineTo(plotOffset.left+this.plotWidth,y);this.lastMousePos.relY=y;}
octx.stroke();octx.restore();},clearCrosshair:function(){if(this.lastMousePos.relX!=null)
this.octx.clearRect(this.lastMousePos.relX-0.5,this.plotOffset.top,1,this.plotHeight+1);if(this.lastMousePos.relY!=null)
this.octx.clearRect(this.plotOffset.left,this.lastMousePos.relY-0.5,this.plotWidth+1,1);},selectionIsSane:function(){return Math.abs(this.selection.second.x-this.selection.first.x)>=5&&Math.abs(this.selection.second.y-this.selection.first.y)>=5;},clearHit:function(){if(!this.prevHit)return;var prevHit=this.prevHit,plotOffset=this.plotOffset,s=prevHit.series,lw=s.bars.lineWidth;if(!s.bars.show){var r=s.points.radius;this.octx.clearRect(this.tHoz(prevHit.x,prevHit.xaxis)+plotOffset.left-r*2,this.tVert(prevHit.y,prevHit.yaxis)+plotOffset.top-r*2,r*3+s.points.lineWidth*3,r*3+s.points.lineWidth*3);}
else{var bw=s.bars.barWidth;this.octx.clearRect(this.tHoz(prevHit.x-bw/2,prevHit.xaxis)+plotOffset.left-lw,this.tVert(prevHit.y,prevHit.yaxis)+plotOffset.top-lw,this.tHoz(bw,prevHit.xaxis)+lw*2,this.tVert(0,prevHit.yaxis)+lw*2);}},drawHit:function(n){var octx=this.octx,s=n.series,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this);if(s.mouse.lineColor!=null){octx.save();octx.lineWidth=s.points.lineWidth;octx.strokeStyle=s.mouse.lineColor;octx.fillStyle=Flotr.parseColor(s.mouse.fillColor||'#ffffff').scale(null,null,null,s.mouse.fillOpacity).toString();if(!s.bars.show){octx.translate(this.plotOffset.left,this.plotOffset.top);octx.beginPath();octx.arc(tHoz(n.x,n.xaxis),tVert(n.y,n.yaxis),s.mouse.radius,0,2*Math.PI,true);octx.fill();octx.stroke();}
else{var bw=s.bars.barWidth;octx.save();octx.translate(this.plotOffset.left,this.plotOffset.top);octx.beginPath();octx.moveTo(tHoz(n.x-(bw/2),n.xaxis),tVert(n.yaxis.min,n.yaxis));octx.lineTo(tHoz(n.x-(bw/2),n.xaxis),tVert(n.y,n.yaxis));octx.lineTo(tHoz(n.x+(bw/2),n.xaxis),tVert(n.y,n.yaxis));octx.lineTo(tHoz(n.x+(bw/2),n.xaxis),tVert(n.yaxis.min,n.yaxis));octx.stroke();octx.closePath();if(s.mouse.fillColor){octx.beginPath();octx.moveTo(tHoz(n.x-(bw/2),n.xaxis),tVert(n.yaxis.min,n.yaxis));octx.lineTo(tHoz(n.x-(bw/2),n.xaxis),tVert(n.y,n.yaxis));octx.lineTo(tHoz(n.x+(bw/2),n.xaxis),tVert(n.y,n.yaxis));octx.lineTo(tHoz(n.x+(bw/2),n.xaxis),tVert(n.yaxis.min,n.yaxis));octx.fill();octx.closePath();}
octx.restore();}
octx.restore();}
this.prevHit=n;},hit:function(mouse){var series=this.series,options=this.options,prevHit=this.prevHit,plotOffset=this.plotOffset,octx=this.octx,data,xsens,ysens,x,y,xa,ya,mx,my,i,n={dist:Number.MAX_VALUE,x:null,y:null,relX:mouse.relX,relY:mouse.relY,absX:mouse.absX,absY:mouse.absY,mouse:null,xaxis:null,yaxis:null,series:null,index:null};for(i=0;i<series.length;i++){s=series[i];if(!s.mouse.track)continue;data=s.data;xa=s.xaxis;ya=s.yaxis;xsens=(2*options.points.lineWidth)/xa.scale*s.mouse.sensibility;ysens=(2*options.points.lineWidth)/ya.scale*s.mouse.sensibility;mx=mouse.relX/xa.scale+xa.min;my=-mouse.relY/ya.scale+ya.max;for(var j=0,xpow,ypow;j<data.length;j++){x=data[j][0];y=data[j][1];if(y===null||xa.min>x||xa.max<x||ya.min>y||ya.max<y)continue;var xdiff=Math.abs(x-mx),ydiff=Math.abs(y-my);if(((!s.bars.show)&&xdiff<xsens&&ydiff<ysens)||(s.bars.show&&xdiff<s.bars.barWidth/2&&my>ya.min&&my<y)){var distance=Math.sqrt(xdiff*xdiff+ydiff*ydiff);if(distance<n.dist){n.dist=distance;n.x=x;n.y=y;n.xaxis=xa;n.yaxis=ya;n.mouse=s.mouse;n.series=s;n.index=j;}}}}
if(n.series&&(n.mouse&&n.mouse.track&&!prevHit||(prevHit))){var mt=this.mouseTrack||this.el.select(".flotr-mouse-value")[0],pos='',s=n.series,p=n.mouse.position,m=n.mouse.margin,elStyle='opacity:0.7;background-color:#000;color:#fff;display:none;position:absolute;padding:2px 8px;-moz-border-radius:4px;border-radius:4px;white-space:nowrap;';if(!n.mouse.relative){if(p.charAt(0)=='n')pos+='top:'+(m+plotOffset.top)+'px;';else if(p.charAt(0)=='s')pos+='bottom:'+(m+plotOffset.bottom)+'px;';if(p.charAt(1)=='e')pos+='right:'+(m+plotOffset.right)+'px;';else if(p.charAt(1)=='w')pos+='left:'+(m+plotOffset.left)+'px;';}
else{if(!s.bars.show){if(p.charAt(0)=='n')pos+='bottom:'+(m-plotOffset.top-this.tVert(n.y,n.yaxis)+this.canvasHeight)+'px;';else if(p.charAt(0)=='s')pos+='top:'+(m+plotOffset.top+this.tVert(n.y,n.yaxis))+'px;';if(p.charAt(1)=='e')pos+='left:'+(m+plotOffset.left+this.tHoz(n.x,n.xaxis))+'px;';else if(p.charAt(1)=='w')pos+='right:'+(m-plotOffset.left-this.tHoz(n.x,n.xaxis)+this.canvasWidth)+'px;';}
else{pos+='bottom:'+(m-plotOffset.top-this.tVert(n.yaxis.min+((n.y-n.yaxis.min)/2),n.yaxis)+this.canvasHeight)+'px;';pos+='left:'+(m+plotOffset.left+this.tHoz(n.x-options.bars.barWidth/2,n.xaxis))+'px;';}}
elStyle+=pos;if(!mt){this.el.insert('<div class="flotr-mouse-value" style="'+elStyle+'"></div>');mt=this.mouseTrack=this.el.select('.flotr-mouse-value').first();}
else{this.mouseTrack=mt.setStyle(elStyle);}
if(n.x!==null&&n.y!==null){mt.show();this.clearHit();this.drawHit(n);var decimals=n.mouse.trackDecimals;if(decimals==null||decimals<0)decimals=0;mt.innerHTML=n.mouse.trackFormatter({x:n.x.toFixed(decimals),y:n.y.toFixed(decimals),series:n.series,index:n.index});mt.fire('flotr:hit',[n,this]);}
else if(prevHit){mt.hide();this.clearHit();}}
else if(this.prevHit){this.mouseTrack.hide();this.clearHit();}},saveImage:function(type,width,height,replaceCanvas){var image=null;switch(type){case'jpeg':case'jpg':image=Canvas2Image.saveAsJPEG(this.canvas,replaceCanvas,width,height);break;default:case'png':image=Canvas2Image.saveAsPNG(this.canvas,replaceCanvas,width,height);break;case'bmp':image=Canvas2Image.saveAsBMP(this.canvas,replaceCanvas,width,height);break;}
if(Object.isElement(image)&&replaceCanvas){this.restoreCanvas();this.canvas.hide();this.overlay.hide();this.el.insert(image.setStyle({position:'absolute'}));}},restoreCanvas:function(){this.canvas.show();this.overlay.show();this.el.select('img').invoke('remove');}});Flotr.Color=Class.create({initialize:function(r,g,b,a){this.rgba=['r','g','b','a'];var x=4;while(-1<--x){this[this.rgba[x]]=arguments[x]||((x==3)?1.0:0);}
this.normalize();},adjust:function(rd,gd,bd,ad){var x=4;while(-1<--x){if(arguments[x]!=null)
this[this.rgba[x]]+=arguments[x];}
return this.normalize();},clone:function(){return new Flotr.Color(this.r,this.b,this.g,this.a);},limit:function(val,minVal,maxVal){return Math.max(Math.min(val,maxVal),minVal);},normalize:function(){var limit=this.limit;this.r=limit(parseInt(this.r),0,255);this.g=limit(parseInt(this.g),0,255);this.b=limit(parseInt(this.b),0,255);this.a=limit(this.a,0,1);return this;},scale:function(rf,gf,bf,af){var x=4;while(-1<--x){if(arguments[x]!=null)
this[this.rgba[x]]*=arguments[x];}
return this.normalize();},distance:function(color){if(!color)return;color=new Flotr.parseColor(color);var dist=0,x=3;while(-1<--x){dist+=Math.abs(this[this.rgba[x]]-color[this.rgba[x]]);}
return dist;},toString:function(){return(this.a>=1.0)?'rgb('+[this.r,this.g,this.b].join(',')+')':'rgba('+[this.r,this.g,this.b,this.a].join(',')+')';}});Flotr.Color.lookupColors={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0]};Flotr.Date={format:function(d,format){if(!d)return;var leftPad=function(n){n=n.toString();return n.length==1?"0"+n:n;};var r=[],c,escape=false;for(var i=0;i<format.length;++i){c=format.charAt(i);if(escape){switch(c){case'h':c=d.getUTCHours().toString();break;case'H':c=leftPad(d.getUTCHours());break;case'M':c=leftPad(d.getUTCMinutes());break;case'S':c=leftPad(d.getUTCSeconds());break;case'd':c=d.getUTCDate().toString();break;case'm':c=(d.getUTCMonth()+1).toString();break;case'y':c=d.getUTCFullYear().toString();break;case'b':c=Flotr.Date.monthNames[d.getUTCMonth()];break;}
r.push(c);escape=false;}
else{if(c=="%")
escape=true;else
r.push(c);}}
return r.join("");},formatter:function(v,axis){var d=new Date(v);if(axis.options.timeformat!=null)
return Flotr.Date.format(d,axis.options.timeformat);var t=axis.tickSize[0]*Flotr.Date.timeUnits[axis.tickSize[1]],span=axis.max-axis.min;if(t<Flotr.Date.timeUnits.minute)
fmt="%h:%M:%S";else if(t<Flotr.Date.timeUnits.day)
fmt=(span<2*Flotr.Date.timeUnits.day)?"%h:%M":"%b %d %h:%M";else if(t<Flotr.Date.timeUnits.month)
fmt="%b %d";else if(t<Flotr.Date.timeUnits.year)
fmt=(span<Flotr.Date.timeUnits.year)?"%b":"%b %y";else
fmt="%y";return Flotr.Date.format(d,fmt);},generator:function(axis){var ticks=[],tickSize=axis.tickSize[0],unit=axis.tickSize[1],d=new Date(axis.min),step=tickSize*timeUnitSize[unit];switch(unit){case"second":d.setUTCSeconds(floorInBase(d.getUTCSeconds(),tickSize));break;case"minute":d.setUTCMinutes(floorInBase(d.getUTCMinutes(),tickSize));break;case"hour":d.setUTCHours(floorInBase(d.getUTCHours(),tickSize));break;case"month":d.setUTCMonth(floorInBase(d.getUTCMonth(),tickSize));break;case"year":d.setUTCFullYear(floorInBase(d.getUTCFullYear(),tickSize));break;}
d.setUTCMilliseconds(0);if(step>=timeUnitSize.minute)d.setUTCSeconds(0);if(step>=timeUnitSize.hour)d.setUTCMinutes(0);if(step>=timeUnitSize.day)d.setUTCHours(0);if(step>=timeUnitSize.day*4)d.setUTCDate(1);if(step>=timeUnitSize.year)d.setUTCMonth(0);var carry=0,v=Number.NaN,prev;do{prev=v;v=d.getTime();ticks.push({v:v,label:axis.tickFormatter(v,axis)});if(unit=="month"){if(tickSize<1){d.setUTCDate(1);var start=d.getTime();d.setUTCMonth(d.getUTCMonth()+1);var end=d.getTime();d.setTime(v+carry*timeUnitSize.hour+(end-start)*tickSize);carry=d.getUTCHours();d.setUTCHours(0);}
else
d.setUTCMonth(d.getUTCMonth()+tickSize);}
else if(unit=="year"){d.setUTCFullYear(d.getUTCFullYear()+tickSize);}
else
d.setTime(v+step);}while(v<axis.max&&v!=prev);return ticks;},timeUnits:{second:1000,minute:1000*60,hour:1000*60*60,day:1000*60*60*24,month:1000*60*60*24*30,year:1000*60*60*24*30*365.2425},spec:[[1,"second"],[2,"second"],[5,"second"],[10,"second"],[30,"second"],[1,"minute"],[2,"minute"],[5,"minute"],[10,"minute"],[30,"minute"],[1,"hour"],[2,"hour"],[4,"hour"],[8,"hour"],[12,"hour"],[1,"day"],[2,"day"],[3,"day"],[0.25,"month"],[0.5,"month"],[1,"month"],[2,"month"],[3,"month"],[6,"month"],[1,"year"]],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]};var Canvas2Image=(function(){var oCanvas=document.createElement("canvas"),sc=String.fromCharCode,strDownloadMime="image/octet-stream",bReplaceDownloadMime=false;if(!oCanvas.getContext){return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}}}
var bHasImageData=!!(oCanvas.getContext("2d").getImageData),bHasDataURL=!!(oCanvas.toDataURL),bHasBase64=!!(window.btoa);var readCanvasData=function(oCanvas){var iWidth=parseInt(oCanvas.width),iHeight=parseInt(oCanvas.height);return oCanvas.getContext("2d").getImageData(0,0,iWidth,iHeight);}
var encodeData=function(data){var i,aData,strData="";if(typeof data=="string"){strData=data;}else{aData=data;for(i=0;i<aData.length;i++){strData+=sc(aData[i]);}}
return btoa(strData);}
var createBMP=function(oData){var strHeader='',iWidth=oData.width,iHeight=oData.height;strHeader+='BM';var iFileSize=iWidth*iHeight*4+54;strHeader+=sc(iFileSize%256);iFileSize=Math.floor(iFileSize/256);strHeader+=sc(iFileSize%256);iFileSize=Math.floor(iFileSize/256);strHeader+=sc(iFileSize%256);iFileSize=Math.floor(iFileSize/256);strHeader+=sc(iFileSize%256);strHeader+=sc(0,0,0,0,54,0,0,0);strHeader+=sc(40,0,0,0);var iImageWidth=iWidth;strHeader+=sc(iImageWidth%256);iImageWidth=Math.floor(iImageWidth/256);strHeader+=sc(iImageWidth%256);iImageWidth=Math.floor(iImageWidth/256);strHeader+=sc(iImageWidth%256);iImageWidth=Math.floor(iImageWidth/256);strHeader+=sc(iImageWidth%256);var iImageHeight=iHeight;strHeader+=sc(iImageHeight%256);iImageHeight=Math.floor(iImageHeight/256);strHeader+=sc(iImageHeight%256);iImageHeight=Math.floor(iImageHeight/256);strHeader+=sc(iImageHeight%256);iImageHeight=Math.floor(iImageHeight/256);strHeader+=sc(iImageHeight%256);strHeader+=sc(1,0,32,0);strHeader+=sc(0,0,0,0);var iDataSize=iWidth*iHeight*4;strHeader+=sc(iDataSize%256);iDataSize=Math.floor(iDataSize/256);strHeader+=sc(iDataSize%256);iDataSize=Math.floor(iDataSize/256);strHeader+=sc(iDataSize%256);iDataSize=Math.floor(iDataSize/256);strHeader+=sc(iDataSize%256);strHeader+=sc(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var aImgData=oData.data,strPixelData="",c,x,y=iHeight,iOffsetX,iOffsetY,strPixelRow;do{iOffsetY=iWidth*(y-1)*4;strPixelRow="";for(x=0;x<iWidth;x++){iOffsetX=4*x;strPixelRow+=sc(aImgData[iOffsetY+iOffsetX+2],aImgData[iOffsetY+iOffsetX+1],aImgData[iOffsetY+iOffsetX],aImgData[iOffsetY+iOffsetX+3]);}
strPixelData+=strPixelRow;}while(--y);return encodeData(strHeader+strPixelData);}
var saveFile=function(strData){if(!window.open(strData)){document.location.href=strData;}}
var makeDataURI=function(strData,strMime){return"data:"+strMime+";base64,"+strData;}
var makeImageObject=function(strSource){var oImgElement=document.createElement("img");oImgElement.src=strSource;return oImgElement;}
var scaleCanvas=function(oCanvas,iWidth,iHeight){if(iWidth&&iHeight){var oSaveCanvas=document.createElement("canvas");oSaveCanvas.width=iWidth;oSaveCanvas.height=iHeight;oSaveCanvas.style.width=iWidth+"px";oSaveCanvas.style.height=iHeight+"px";var oSaveCtx=oSaveCanvas.getContext("2d");oSaveCtx.drawImage(oCanvas,0,0,oCanvas.width,oCanvas.height,0,0,iWidth,iWidth);return oSaveCanvas;}
return oCanvas;}
return{saveAsPNG:function(oCanvas,bReturnImg,iWidth,iHeight){if(!bHasDataURL)return false;var oScaledCanvas=scaleCanvas(oCanvas,iWidth,iHeight),strMime="image/png",strData=oScaledCanvas.toDataURL(strMime);if(bReturnImg){return makeImageObject(strData);}else{saveFile(bReplaceDownloadMime?strData.replace(strMime,strDownloadMime):strData);}
return true;},saveAsJPEG:function(oCanvas,bReturnImg,iWidth,iHeight){if(!bHasDataURL)return false;var oScaledCanvas=scaleCanvas(oCanvas,iWidth,iHeight),strMime="image/jpeg",strData=oScaledCanvas.toDataURL(strMime);if(strData.indexOf(strMime)!=5)return false;if(bReturnImg){return makeImageObject(strData);}else{saveFile(bReplaceDownloadMime?strData.replace(strMime,strDownloadMime):strData);}
return true;},saveAsBMP:function(oCanvas,bReturnImg,iWidth,iHeight){if(!(bHasDataURL&&bHasImageData&&bHasBase64))return false;var oScaledCanvas=scaleCanvas(oCanvas,iWidth,iHeight),strMime="image/bmp",oData=readCanvasData(oScaledCanvas),strImgData=createBMP(oData);if(bReturnImg){return makeImageObject(makeDataURI(strImgData,strMime));}else{saveFile(makeDataURI(strImgData,strMime));}
return true;}};})();debug=function(message){if(console&&typeof console.log!='undefined'){console.log(message);}}
css_attr=function(selector,attr){$$(selector).each(function(elem){debug(elem.getStyle(attr));});}
zindex=function(selector){css_attr(selector,'z-index');}
auth_token=function(){if(typeof(AUTH_TOKEN)=="undefined"){return false;}
return AUTH_TOKEN;}
flatten_sortables=function(){$$('.sortable').each(function(i){i.setStyle({zIndex:'auto'});});}
decode_model=function(elem){var dom_id=elem.identify()
var match=dom_id.gsub(/(.*)_([0-9]+)/,function(match){return match;});var matches=match.split(",");return{type:matches[1],id:matches[2]};}
focus_first_field=function(){if(document.forms.size==1){var first_form=document.forms[0];var inputs=first_form.getInputs('text');if(inputs&&inputs[0]){inputs[0].activate();}}}
is_mac=function(){if(navigator){if(navigator.platform){return(navigator.platform.indexOf("Mac")>-1);}}
return false;}
show_alert=function(elem,force){if(force||(!readCookie(elem.identify()))){Effect.toggle(elem,'blind',{});new Effect.Opacity('wrapper',{from:1.0,to:0.25,duration:0.25});elem.observe('click',function(event){Effect.toggle(elem,'blind',{});new Effect.Opacity('wrapper',{from:0.25,to:1.0,duration:0.25});elem.stopObserving();});};};document.observe("dom:loaded",function(){if($("project-signin")){Event.observe('login','focus',function(event){$("login").previous(0).setStyle({"display":"none"});});Event.observe('login','blur',function(event){if($("login").value=="")$("login").previous(0).setStyle({"display":"block"});});Event.observe('password','focus',function(event){$("password").previous(0).setStyle({"display":"none"});});Event.observe('password','blur',function(event){if($("password").value=="")$("password").previous(0).setStyle({"display":"block"});});if($("login").value!=''){$("login").previous(0).setStyle({"display":"none"});}
if($("password").value!=''){$("password").previous(0).setStyle({"display":"none"});}}});var dropdown_for=function(dropDownLinkId,dropDownMenuId){var dropDownLink=$(dropDownLinkId);var dropDownMenu=$(dropDownMenuId);var dropDownLink_width=dropDownLink.getDimensions().width;var dropDownMenu_width=dropDownMenu.getDimensions().width;var padding=0;dropDownMenu.show();dropDownMenu.hide();dropDownMenu.setStyle({'z-index':2000});dropDownMenu.setStyle({'padding':padding+"px"});if(dropDownMenu_width<dropDownLink_width){dropDownMenu.setStyle({width:dropDownLink_width+"px"});dropDownMenu_width=dropDownLink_width;}
var left_offset=dropDownLink_width/-1;var top_offset=dropDownLink.getDimensions().height-padding;var options={setWidth:false,setHeight:false,offsetLeft:left_offset,offsetTop:top_offset};var is_showing=false;var in_dropDownLink=false;var in_dropDownMenu=false;var hide_timer=null;dropDownMenu.clonePosition(dropDownLink,options);var hide=function(){dropDownMenu.hide();is_showing=false;hide_timer=null;};var show=function(){dropDownMenu.show();is_showing=true;if(hide_timer!==null){clearTimeout(hide_timer);hide_timer=null;}};var updateMouseStatus=function(){if(in_dropDownLink||in_dropDownMenu){show();}
else{if(is_showing){is_showing=false;hide_timer=setTimeout(hide,100);}}};var mouseEnterHandler=function(event){var mouse_over_element=event.target;if(mouse_over_element){if(mouse_over_element==dropDownMenu||mouse_over_element.descendantOf(dropDownMenu)){in_dropDownMenu=true;}
else{in_dropDownMenu=false;}
if(mouse_over_element==dropDownLink||mouse_over_element.descendantOf(dropDownLink)){in_dropDownLink=true;}
else{in_dropDownLink=false;}}
updateMouseStatus();};document.observe('mouseover',mouseEnterHandler);dropDownMenu.observe('click',function(event){show();});};function createCookie(name,value,days){if(!days){days=14}
var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));var expires="; expires="+date.toGMTString();document.cookie=name+"="+value+expires+"; path=/";}
function readCookie(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length);}
return null;}
function eraseCookie(name){createCookie(name,"",-1);}
(function(){var default_duration=0.2;var accordion_toggle_class='accordion_toggle';var open_class='accordion_toggle_open';var closed_class='accordion_toggle_closed';var show_hide_class='accordion_show_hide_text';var element_for_toggle=function(toggle_element){return $(toggle_element).next('.accordion_content');}
var id_for_toggle=function(toggle_element){return $(toggle_element).up().identify();}
var has_cookie=function(toggle_element){return(readCookie(id_for_toggle(toggle_element))=="true");}
var set_cookie=function(toggle_element){createCookie(id_for_toggle(toggle_element),'true');}
var remove_cookie=function(toggle_element){eraseCookie(id_for_toggle(toggle_element));}
var is_on=function(toggle_element){return toggle_element.hasClassName(open_class);}
var is_a_toggle=function(elm){return(elm.hasClassName(open_class)||elm.hasClassName(closed_class));}
var is_show_hide=function(elm){return(elm.hasClassName(show_hide_class));}
var turn_on=function(toggle_element,duration){toggle_element.addClassName(open_class);toggle_element.removeClassName(closed_class);var show_hider=$(toggle_element).down("."+show_hide_class);if(show_hider){show_hider.update(show_hider.innerHTML.replace('Show','Hide'));show_hider.update(show_hider.innerHTML.replace('show','Hide'));}
Effect.BlindDown(element_for_toggle(toggle_element),{duration:duration});}
var turn_off=function(toggle_element,duration){toggle_element.addClassName(closed_class);toggle_element.removeClassName(open_class);var show_hider=$(toggle_element).down("."+show_hide_class);if(show_hider){show_hider.update(show_hider.innerHTML.replace('Hide','Show'));show_hider.update(show_hider.innerHTML.replace('hide','Show'));}
Effect.BlindUp(element_for_toggle(toggle_element),{duration:duration});}
var toggle=function(event){var toggle_element=event.element();if(is_show_hide(toggle_element)){toggle_element=toggle_element.up("."+accordion_toggle_class);}
if(toggle_element){if(is_a_toggle(toggle_element)){if(is_on(toggle_element)){turn_off(toggle_element,default_duration);remove_cookie(toggle_element);}
else{turn_on(toggle_element,default_duration);set_cookie(toggle_element);}
event.stop()}}}
document.observe('dom:loaded',function(){$$("."+closed_class).each(function(element){if(has_cookie(element)){turn_on(element,0);}});})
document.observe('click',toggle);}());var selected_class='item_selected';var unselected_class='item_selectable';var rites_document={};var last_rites_document={}
var is_selected=function(element){return element.hasClassName(selected_class)}
var selected=function(toggle_element){return(readCookie(id_for_toggle(toggle_element))=="true");}
var set_cookie=function(toggle_element){createCookie(id_for_toggle(toggle_element),'true');}
var remove_cookie=function(toggle_element){eraseCookie(id_for_toggle(toggle_element));}
var get_selectable=function(element){element=$(element)
if(element.hasClassName(unselected_class))return element;if(element.hasClassName(selected_class))return element;if(element.up("."+unselected_class))return element.up("."+unselected_class);if(element.up("."+selected_class))return element.up("."+selected_class)
return null}
var item_select=function(event){item_deselect();var element=event.element();var element=$(element);var selected=get_selectable(element)
if(selected){var type='';var id='';selected.identify().gsub(/item_([\w|_]+)_(\d+)/,function(match){type=match[1];id=match[2];});selected.addClassName(selected_class);selected.removeClassName(unselected_class);if(selected.up('li')){selected.up('li').addClassName(selected_class);selected.up('li').removeClassName(unselected_class);}
if(selected.down('.item')){selected.down('.item').addClassName(selected_class);selected.down('.item').removeClassName(unselected_class);}
rites_document.selected_type=type;rites_document.selected_id=id;if(rites_document.selected_type!=last_rites_document.selected_type||rites_document.selected_id!=last_rites_document.selected_id){update_links();last_rites_document.selected_id=rites_document.selected_id;last_rites_document.selected_type=rites_document.selected_type;}}}
var item_deselect=function(){$$("."+selected_class).each(function(element){element.removeClassName(selected_class);element.addClassName(unselected_class);if(element.up('li')){element.up('li').removeClassName(selected_class);element.up('li').addClassName(unselected_class);}
if(element.down('.item')){element.down('.item').addClassName(selected_class);element.down('.item').removeClassName(unselected_class);}
rites_document.selected_type=null;rites_document.selected_id=null;rites_document.selected_name="unknown"});}
var update_links=function(){if(rites_document&&$('copy_link')){if(rites_document.selected_type!=null){var template=new Template('<a href="#" class="rollover"><img src="/images/paste-in.png"></a><a href="#">copy #{name}</a>');$('copy_link').addClassName('copy_paste_enabled');$('copy_link').removeClassName('copy_paste_disabled');$('copy_link').observe('click',copy);new Ajax.Request('/name_for_clipboard_data?clipboard_data_type='+rites_document.selected_type+'&clipboard_data_id='+rites_document.selected_id,{method:'get',onSuccess:function(transport){rites_document.selected_name=transport.responseText
$('copy_link').update(template.evaluate({type:rites_document.selected_type,name:rites_document.selected_name}));}});}
else{$('copy_link').addClassName('copy_paste_disabled');$('copy_link').removeClassName('copy_paste_enabled');$('copy_link').stopObserving();$('copy_link').update('copy (nothing selected)');}}}
var copy=function(){var template=new Template('#{type}:#{name} is now in your clipboard.');createCookie('clipboard_data_type',rites_document.selected_type);createCookie('clipboard_data_id',rites_document.selected_id);alert(template.evaluate({type:rites_document.selected_type,name:rites_document.selected_name}));var params={container_id:container_id,clipboard_data_type:rites_document.selected_type,clipboard_data_id:rites_document.selected_id};if(auth_token()){params.authenticity_token=auth_token();}
new Ajax.Updater({success:'paste_link'},'paste_link',{parameters:params});}
var show_wait=function(){if($('waiter')){$('waiter').show();}}
var hide_wait=function(){if($('waiter')){$('waiter').hide();}}
document.observe('click',item_select);var LiveValidation=Class.create();Object.extend(LiveValidation,{VERSION:"1.3 prototype",TEXTAREA:1,TEXT:2,PASSWORD:3,CHECKBOX:4,SELECT:5,FILE:6,massValidate:function(C){var D=true;for(var B=0,A=C.length;B<A;++B){var E=C[B].validate();if(D){D=E;}}return D;}});LiveValidation.prototype={validClass:"LV_valid",invalidClass:"LV_invalid",messageClass:"LV_validation_message",validFieldClass:"LV_valid_field",invalidFieldClass:"LV_invalid_field",initialize:function(B,A){if(!B){throw new Error("LiveValidation::initialize - No element reference or element id has been provided!");}this.element=$(B);if(!this.element){throw new Error("LiveValidation::initialize - No element with reference or id of '"+B+"' exists!");}this.elementType=this.getElementType();this.validations=[];this.form=this.element.form;this.options=Object.extend({validMessage:"Thankyou!",onValid:function(){this.insertMessage(this.createMessageSpan());this.addFieldClass();},onInvalid:function(){this.insertMessage(this.createMessageSpan());this.addFieldClass();},insertAfterWhatNode:this.element,onlyOnBlur:false,wait:0,onlyOnSubmit:false},A||{});var C=this.options.insertAfterWhatNode||this.element;this.options.insertAfterWhatNode=$(C);Object.extend(this,this.options);if(this.form){this.formObj=LiveValidationForm.getInstance(this.form);this.formObj.addField(this);}this.boundFocus=this.doOnFocus.bindAsEventListener(this);Event.observe(this.element,"focus",this.boundFocus);if(!this.onlyOnSubmit){switch(this.elementType){case LiveValidation.CHECKBOX:this.boundClick=this.validate.bindAsEventListener(this);Event.observe(this.element,"click",this.boundClick);case LiveValidation.SELECT:case LiveValidation.FILE:this.boundChange=this.validate.bindAsEventListener(this);Event.observe(this.element,"change",this.boundChange);break;default:if(!this.onlyOnBlur){this.boundKeyup=this.deferValidation.bindAsEventListener(this);Event.observe(this.element,"keyup",this.boundKeyup);}this.boundBlur=this.validate.bindAsEventListener(this);Event.observe(this.element,"blur",this.boundBlur);}}},destroy:function(){if(this.formObj){this.formObj.removeField(this);this.formObj.destroy();}Event.stopObserving(this.element,"focus",this.boundFocus);if(!this.onlyOnSubmit){switch(this.elementType){case LiveValidation.CHECKBOX:Event.stopObserving(this.element,"click",this.boundClick);case LiveValidation.SELECT:case LiveValidation.FILE:Event.stopObserving(this.element,"change",this.boundChange);break;default:if(!this.onlyOnBlur){Event.stopObserving(this.element,"keyup",this.boundKeyup);}Event.stopObserving(this.element,"blur",this.boundBlur);}}this.validations=[];this.removeMessageAndFieldClass();},add:function(A,B){this.validations.push({type:A,params:B||{}});return this;},remove:function(A,B){this.validations=this.validations.reject(function(C){return(C.type==A&&C.params==B);});return this;},deferValidation:function(A){if(this.wait>=300){this.removeMessageAndFieldClass();}if(this.timeout){clearTimeout(this.timeout);}this.timeout=setTimeout(this.validate.bind(this),this.wait);},doOnBlur:function(){this.focused=false;this.validate();},doOnFocus:function(){this.focused=true;this.removeMessageAndFieldClass();},getElementType:function(){switch(true){case(this.element.nodeName.toUpperCase()=="TEXTAREA"):return LiveValidation.TEXTAREA;case(this.element.nodeName.toUpperCase()=="INPUT"&&this.element.type.toUpperCase()=="TEXT"):return LiveValidation.TEXT;case(this.element.nodeName.toUpperCase()=="INPUT"&&this.element.type.toUpperCase()=="PASSWORD"):return LiveValidation.PASSWORD;case(this.element.nodeName.toUpperCase()=="INPUT"&&this.element.type.toUpperCase()=="CHECKBOX"):return LiveValidation.CHECKBOX;case(this.element.nodeName.toUpperCase()=="INPUT"&&this.element.type.toUpperCase()=="FILE"):return LiveValidation.FILE;case(this.element.nodeName.toUpperCase()=="SELECT"):return LiveValidation.SELECT;case(this.element.nodeName.toUpperCase()=="INPUT"):throw new Error("LiveValidation::getElementType - Cannot use LiveValidation on an "+this.element.type+" input!");default:throw new Error("LiveValidation::getElementType - Element must be an input, select, or textarea!");}},doValidations:function(){this.validationFailed=false;for(var C=0,A=this.validations.length;C<A;++C){var B=this.validations[C];switch(B.type){case Validate.Presence:case Validate.Confirmation:case Validate.Acceptance:this.displayMessageWhenEmpty=true;this.validationFailed=!this.validateElement(B.type,B.params);break;default:this.validationFailed=!this.validateElement(B.type,B.params);break;}if(this.validationFailed){return false;}}this.message=this.validMessage;return true;},validateElement:function(A,C){var D=(this.elementType==LiveValidation.SELECT)?this.element.options[this.element.selectedIndex].value:this.element.value;if(A==Validate.Acceptance){if(this.elementType!=LiveValidation.CHECKBOX){throw new Error("LiveValidation::validateElement - Element to validate acceptance must be a checkbox!");}D=this.element.checked;}var E=true;try{A(D,C);}catch(B){if(B instanceof Validate.Error){if(D!==""||(D===""&&this.displayMessageWhenEmpty)){this.validationFailed=true;this.message=B.message;E=false;}}else{throw B;}}finally{return E;}},validate:function(){if(!this.element.disabled){var A=this.doValidations();if(A){this.onValid();return true;}else{this.onInvalid();return false;}}else{return true;}},enable:function(){this.element.disabled=false;return this;},disable:function(){this.element.disabled=true;this.removeMessageAndFieldClass();return this;},createMessageSpan:function(){var A=document.createElement("span");var B=document.createTextNode(this.message);A.appendChild(B);return A;},insertMessage:function(B){this.removeMessage();var A=this.validationFailed?this.invalidClass:this.validClass;if((this.displayMessageWhenEmpty&&(this.elementType==LiveValidation.CHECKBOX||this.element.value==""))||this.element.value!=""){$(B).addClassName(this.messageClass+(" "+A));if(nxtSibling=this.insertAfterWhatNode.nextSibling){this.insertAfterWhatNode.parentNode.insertBefore(B,nxtSibling);}else{this.insertAfterWhatNode.parentNode.appendChild(B);}}},addFieldClass:function(){this.removeFieldClass();if(!this.validationFailed){if(this.displayMessageWhenEmpty||this.element.value!=""){if(!this.element.hasClassName(this.validFieldClass)){this.element.addClassName(this.validFieldClass);}}}else{if(!this.element.hasClassName(this.invalidFieldClass)){this.element.addClassName(this.invalidFieldClass);}}},removeMessage:function(){if(nxtEl=this.insertAfterWhatNode.next("."+this.messageClass)){nxtEl.remove();}},removeFieldClass:function(){this.element.removeClassName(this.invalidFieldClass);this.element.removeClassName(this.validFieldClass);},removeMessageAndFieldClass:function(){this.removeMessage();this.removeFieldClass();}};var LiveValidationForm=Class.create();Object.extend(LiveValidationForm,{instances:{},getInstance:function(A){var B=Math.random()*Math.random();if(!A.id){A.id="formId_"+B.toString().replace(/\./,"")+new Date().valueOf();}if(!LiveValidationForm.instances[A.id]){LiveValidationForm.instances[A.id]=new LiveValidationForm(A);}return LiveValidationForm.instances[A.id];}});LiveValidationForm.prototype={initialize:function(A){this.element=$(A);this.fields=[];this.oldOnSubmit=this.element.onsubmit||function(){};this.element.onsubmit=function(C){var B=(LiveValidation.massValidate(this.fields))?this.oldOnSubmit.call(this.element,C)!==false:false;if(!B){Event.stop(C);}}.bindAsEventListener(this);},addField:function(A){this.fields.push(A);},removeField:function(A){this.fields=this.fields.without(A);},destroy:function(A){if(this.fields.length!=0&&!A){return false;}this.element.onsubmit=this.oldOnSubmit;LiveValidationForm.instances[this.element.id]=null;return true;}};var Validate={Presence:function(A,B){var C=Object.extend({failureMessage:"Can't be empty!"},B||{});if(A===""||A===null||A===undefined){Validate.fail(C.failureMessage);}return true;},Numericality:function(B,C){var A=B;var B=Number(B);var C=C||{};var D={notANumberMessage:C.notANumberMessage||"Must be a number!",notAnIntegerMessage:C.notAnIntegerMessage||"Must be an integer!",wrongNumberMessage:C.wrongNumberMessage||"Must be "+C.is+"!",tooLowMessage:C.tooLowMessage||"Must not be less than "+C.minimum+"!",tooHighMessage:C.tooHighMessage||"Must not be more than "+C.maximum+"!",is:((C.is)||(C.is==0))?C.is:null,minimum:((C.minimum)||(C.minimum==0))?C.minimum:null,maximum:((C.maximum)||(C.maximum==0))?C.maximum:null,onlyInteger:C.onlyInteger||false};if(!isFinite(B)){Validate.fail(D.notANumberMessage);}if(D.onlyInteger&&((/\.0+$|\.$/.test(String(A)))||(B!=parseInt(B)))){Validate.fail(D.notAnIntegerMessage);}switch(true){case(D.is!==null):if(B!=Number(D.is)){Validate.fail(D.wrongNumberMessage);}break;case(D.minimum!==null&&D.maximum!==null):Validate.Numericality(B,{tooLowMessage:D.tooLowMessage,minimum:D.minimum});Validate.Numericality(B,{tooHighMessage:D.tooHighMessage,maximum:D.maximum});break;case(D.minimum!==null):if(B<Number(D.minimum)){Validate.fail(D.tooLowMessage);}break;case(D.maximum!==null):if(B>Number(D.maximum)){Validate.fail(D.tooHighMessage);}break;}return true;},Format:function(A,B){var A=String(A);var C=Object.extend({failureMessage:"Not valid!",pattern:/./,negate:false},B||{});if(!C.negate&&!C.pattern.test(A)){Validate.fail(C.failureMessage);}if(C.negate&&C.pattern.test(A)){Validate.fail(C.failureMessage);}return true;},Email:function(A,B){var C=Object.extend({failureMessage:"Must be a valid email address!"},B||{});Validate.Format(A,{failureMessage:C.failureMessage,pattern:/^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/i});return true;},Length:function(A,B){var A=String(A);var B=B||{};var C={wrongLengthMessage:B.wrongLengthMessage||"Must be "+B.is+" characters long!",tooShortMessage:B.tooShortMessage||"Must not be less than "+B.minimum+" characters long!",tooLongMessage:B.tooLongMessage||"Must not be more than "+B.maximum+" characters long!",is:((B.is)||(B.is==0))?B.is:null,minimum:((B.minimum)||(B.minimum==0))?B.minimum:null,maximum:((B.maximum)||(B.maximum==0))?B.maximum:null};switch(true){case(C.is!==null):if(A.length!=Number(C.is)){Validate.fail(C.wrongLengthMessage);}break;case(C.minimum!==null&&C.maximum!==null):Validate.Length(A,{tooShortMessage:C.tooShortMessage,minimum:C.minimum});Validate.Length(A,{tooLongMessage:C.tooLongMessage,maximum:C.maximum});break;case(C.minimum!==null):if(A.length<Number(C.minimum)){Validate.fail(C.tooShortMessage);}break;case(C.maximum!==null):if(A.length>Number(C.maximum)){Validate.fail(C.tooLongMessage);}break;default:throw new Error("Validate::Length - Length(s) to validate against must be provided!");}return true;},Inclusion:function(C,D){var E=Object.extend({failureMessage:"Must be included in the list!",within:[],allowNull:false,partialMatch:false,caseSensitive:true,negate:false},D||{});if(E.allowNull&&C==null){return true;}if(!E.allowNull&&C==null){Validate.fail(E.failureMessage);}if(!E.caseSensitive){var A=[];E.within.each(function(F){if(typeof F=="string"){F=F.toLowerCase();}A.push(F);});E.within=A;if(typeof C=="string"){C=C.toLowerCase();}}var B=(E.within.indexOf(C)==-1)?false:true;if(E.partialMatch){B=false;E.within.each(function(F){if(C.indexOf(F)!=-1){B=true;}});}if((!E.negate&&!B)||(E.negate&&B)){Validate.fail(E.failureMessage);}return true;},Exclusion:function(A,B){var C=Object.extend({failureMessage:"Must not be included in the list!",within:[],allowNull:false,partialMatch:false,caseSensitive:true},B||{});C.negate=true;Validate.Inclusion(A,C);return true;},Confirmation:function(A,B){if(!B.match){throw new Error("Validate::Confirmation - Error validating confirmation: Id of element to match must be provided!");}var C=Object.extend({failureMessage:"Does not match!",match:null},B||{});C.match=$(B.match);if(!C.match){throw new Error("Validate::Confirmation - There is no reference with name of, or element with id of '"+C.match+"'!");}if(A!=C.match.value){Validate.fail(C.failureMessage);}return true;},Acceptance:function(A,B){var C=Object.extend({failureMessage:"Must be accepted!"},B||{});if(!A){Validate.fail(C.failureMessage);}return true;},Custom:function(A,B){var C=Object.extend({against:function(){return true;},args:{},failureMessage:"Not valid!"},B||{});if(!C.against(A,C.args)){Validate.fail(C.failureMessage);}return true;},now:function(A,D,C){if(!A){throw new Error("Validate::now - Validation function must be provided!");}var E=true;try{A(D,C||{});}catch(B){if(B instanceof Validate.Error){E=false;}else{throw B;}}finally{return E;}},Error:function(A){this.message=A;this.name="ValidationError";},fail:function(A){throw new Validate.Error(A);}};var showWait=function(){var selector="run_link";var waiting_id=null;var counting_id=null;var timer_dom='counter';var wait_dom='please_wait';var wait_secs=20;var counter=0;var hideWait=function(){waiting_id=null;clearInterval(counting_id);counting_id=null;$(timer_dom).update('completed');$(wait_dom).hide();}
var update_counter=function(){$(timer_dom).update(counter);counter=counter-1;}
if(waiting_id||counting_id){return;}
waiting_id=setTimeout(hideWait,wait_secs*1000);$(timer_dom).update(wait_secs);counting_id=setInterval(update_counter,1000);counter=wait_secs;$(wait_dom).show();};document.observe("dom:loaded",function(){$$(".run_link").each(function(item){item.observe("click",showWait);});});function set(parentId,selected){$$(parentId+' input.filter_checkbox').each(function(box){box.checked=selected;});return false;}
function selectAll(parentId){return set(parentId,true);}
function selectNone(parentId){return set(parentId,false);}
function autoPrintNextTime(){createCookie('auto_print_next_time','true');}
function autoPrint(){var should=readCookie('auto_print_next_time')=='true';eraseCookie('auto_print_next_time');if(should){window.print();}}
function areChanges(parentId){var diff=false;var last=null;var checker=function(box){if(last===null){last=box.checked;}else if(last!=box.checked){diff=true;}};$$(parentId+' input.filter_checkbox').each(checker);return diff;}
function saveChangesAndPrint(parentId,formId){if(areChanges(parentId)){var actualInput=null;var inputs=Form.getInputs($(formId),'submit');inputs.each(function(input){if(input.value=="Show selected"){actualInput=input;}});if(actualInput!==null){autoPrintNextTime();actualInput.click();}}else{window.print();}}
Event.observe(window,'load',function(){window.setTimeout("autoPrint();",3000);});PendingRequests=0;PendingTimeout=30000;PendingQue={};var repaginate=function(opts){var selector=opts.selector||".pagination > a";var current_url=location.href;var links=$$(selector);var serialized_data='';var rewrite_link=function(link_elem){var link_text=link_elem.href;var query=link_text.replace(/^.*\?/,"");current_url=current_url.replace(/\?.*$/,"");link_elem.href=current_url+"?"+query+"&"+serialized_data;};links.each(function(l){rewrite_link(l);});};var startUpdate=function(progress_sel,update_sel){if(typeof progress_sel=='undefined'){progress_sel='search_spinner';}
if(typeof update_sel=='undefined'){update_sel='offering_list';}
$(update_sel).hide();$(progress_sel).show();};var endUpdate=function(progress_sel,update_sel){if(typeof progress_sel=='undefined'){progress_sel='search_spinner';}
if(typeof update_sel=='undefined'){update_sel='offering_list';}
$(update_sel).show();$(progress_sel).hide();repaginate({});};PendingStart=function(pre,post){if(typeof pre=='undefined'){pre=startUpdate;}
if(typeof post=='undefined'){post=endUpdate;}
PendingRequests++;pre.call();if(typeof PendingQue[post]=='undefined'){PendingQue[post]=0;}
else{PendingQue[post]=PendingQue[post]+1;}};PendingEnd=function(post){if(typeof post=='undefined'){post=endUpdate;}
PendingRequests--;if(typeof PendingQue[post]=='undefined'){PendingQue[post]=0;}
else{PendingQue[post]=PendingQue[post]-1;}
if(PendingQue[post]<1){post.call();}};var ParseOfferingUrl=function(url){var offering_id_str=null;if(url.match(/portal\/offerings\/\d+\.jnlp/gi)){offering_id_str=url.match(/\d+\.jnlp/gi).first();offering_id_str=offering_id_str.match(/\d+/gi).first();}
return offering_id_str;};var EnableWorkgroups=function(_selector){var _selector=_selector||'a.run_link';$$(_selector).each(function(el){var offering_id=ParseOfferingUrl(el.href);el.stopObserving('click');el.observe('click',function(e){Workgroup(offering_id);e.stop();});});};var Workgroup=function(_offering){var load_error=false;var loading_learners=false;var learners=[];var collaborators=[];var offering=_offering;var pending_requests=0;var learners_list=null;var learners_dropdown=null;var add_button=null;var run_button=null;var run_message=null;var add_group=null;var learners_container=null;var lightbox_hood=null;var lightbox_content=null;var learner_id_for=function(learner){return"_LEARNER_"+learner.id;};var load_dom_elems=function(){if(learners_list==null){learners_list=$('learners_list');learners_dropdown=$('learners_dropdown');add_button=$('add_button');run_button=$('run_button');run_message=$('run_message');add_group=$('add_group');learners_container=$('learners_container');lightbox_hood=$('lightbox_hood');lightbox_content=$('lightbox_content');}};var show_workgroup_editor=function(){load_learners();$('workgroup_panel').show();$('show_workgroups').up().hide();};var hide_workgroup_editor=function(){$('workgroup_panel').hide();$('show_workgroups').up().show();};var close_dialog=function(){var timeout=null;var closefunction=function(){learners=[];collaborators=[];update_ui();loading_learners=true;if(pending_requests<1){lightbox_hood.hide();lightbox_content.hide();hide_workgroup_editor();clearTimeout(timeout)
$(document).stopObserving('keydown');}}
timeout=setTimeout(function(){closefunction();},100);};var launch_action=function(){pending_requests=pending_requests+1;lightbox_hood.hide();lightbox_content.hide();showWait();new Ajax.Request('/portal/offerings/'+offering+'/start.json',{parameters:{students:collaborators.map(function(l){return l.id;}).join(',')},onSuccess:function(){pending_requests=pending_requests-1;close_dialog();window.location="/portal/offerings/"+offering+".jnlp"},onFaiulre:function(){pending_requests=pending_requests-1;}});};var handle_keydown=function(e){var code;if(!e)var e=window.event;if(e.keyCode)code=e.keyCode;else if(e.which)code=e.which;switch(code){case 27:handle_escape(e);break;case 13:handle_return(e);break;default:}};var handle_escape=function(e){close_dialog();};var handle_return=function(e){};var load=function(){load_dom_elems();learners=[];collaborators=[];$(document).observe('keydown',handle_keydown);$('show_workgroups').observe('click',show_workgroup_editor);$('cancel_button').observe('click',close_dialog);lightbox_hood.show();lightbox_content.show();update_ui();};var add_learner=function(learner){learners=learners.without(learner);learners=learners.sortBy(function(e){return e.name;});collaborators.push(learner);collaborators=collaborators.sortBy(function(e){return e.name;});update_ui();};var remove_learner=function(learner){collaborators=collaborators.without(learner).sortBy(function(e){return e.name;});learners.push(learner);learners=learners.sortBy(function(e){return e.name;});update_ui();};var disable_run=function(){run_button.setOpacity(0.3);run_message.update('enter valid passwords for all collaborators');run_message.addClassName('wg_important');run_button.stopObserving('click');};var enable_run=function(){run_button.setOpacity(1);run_message.update('run the activity now');run_message.removeClassName('wg_important')
run_button.stopObserving('click');run_button.observe('click',launch_action);};var disable_add=function(){add_button.setOpacity(0.5);add_button.stopObserving('click');};var enable_add=function(){add_button.setOpacity(1);add_button.stopObserving('click');add_button.observe('click',function(e){add_learner(selected_learner());});};var selected_learner=function(){selected=learners_dropdown.select('option').find(function(ele){return!!ele.selected});var learner=learners.detect(function(l){return l.id==parseInt(selected.value);});return learner;};var load_learners=function(){learners=[];load_error=false;loading_learners=true;update_ui();pending_requests=pending_requests+1;new Ajax.Request('/portal/offerings/'+offering+'/learners.json',{method:'get',onSuccess:function(transport){learners=transport.responseJSON;learners=learners.sortBy(function(l){return l.name});loading_learners=false;load_error=false;pending_requests=pending_requests-1;update_ui();},onFailure:function(){load_error=true;loading_learners=false;pending_requests=pending_requests-1;update_ui();}});};var add_learner_to_container=function(learner){var template=$('learner_template');var learner_el=Element.clone(template,true);var name_field=learner_el.select('.name_field').first();var delete_button=learner_el.select('.delete').first();var password_field=learner_el.select('.password_field').first();var login_button=learner_el.select('.login_button').first();var pending=learner_el.select('.pending').first();var complete=learner_el.select('.complete').first();var login_failed=learner_el.select('.fail').first();var wait=learner_el.select('.wait').first();name_field.update(learner.name);learner_el.id=learner_id_for(learner);learners_list.insert({bottom:learner_el});var do_check_password=function(){pending.hide();wait.show();check_password(learner,password_field.value,login_success,login_failure);};login_button.observe('click',do_check_password);password_field.observe('keydown',function(e){var code;if(!e)var e=window.event;if(e.keyCode)code=e.keyCode;else if(e.which)code=e.which;switch(code){case 13:do_check_password();break;default:}});if(learner.have_consent){pending.hide();}
else{complete.hide();}
delete_button.observe('click',function(){remove_learner(learner);});login_failed.hide();wait.hide();var login_success=function(){learner.have_consent=true;login_button.stopObserving();pending.hide();login_failed.hide();wait.hide();complete.show();update_ui();};var login_failure=function(){login_failed.show();wait.hide();pending.show();update_ui();}};var remove_learner_from_container=function(learner){var learner_dom=$(learner_id_for(learner));if(learner_dom){learner_dom.remove();}};var clear_containers=function(){learners_dropdown.select('.learner').each(function(e){e.remove();});learners_container.select('.learner').each(function(e){e.remove();});};var reset_visual_state=function(){clear_containers();enable_run();enable_add();add_group.show();learners_container.show();$('load_wait').hide();$('load_error').hide();};var update_ui=function(){reset_visual_state();learners.each(function(learner){add_learner_to_dropdown(learner);});collaborators.each(function(learner){add_learner_to_container(learner);if(!learner.have_consent){disable_run();}});if(pending_requests>1){disable_run();disable_add();}
if(collaborators.size()<1){learners_container.hide();}
if(loading_learners){add_group.hide();$('load_wait').show();}
if(load_error){$('load_error').show();}};var add_learner_to_dropdown=function(learner){var learner_el=new Element('option',{'class':'learner',id:learner_id_for(learner),value:learner.id}).update(learner.name);learners_dropdown.insert({bottom:learner_el})};var remove_learner_from_dropdown=function(learner){var id=learner_id_for(learner,"dropdown");var learner_dom=$(id);if(learner_dom){$(id).remove();}};var check_password=function(learner,passwd,succ,fail){pending_requests=pending_requests+1;new Ajax.Request('/portal/offerings/'+offering+'/check_learner_auth',{parameters:{'learner_id':learner.id,'pw':passwd},onSuccess:function(transport){pending_requests=pending_requests-1;succ.call();},onFailure:function(){pending_requests=pending_requests-1;fail.call();}});};load();};(function(){var SelectParser;SelectParser=(function(){function SelectParser(){this.options_index=0;this.parsed=[];}
SelectParser.prototype.add_node=function(child){if(child.nodeName==="OPTGROUP"){return this.add_group(child);}else{return this.add_option(child);}};SelectParser.prototype.add_group=function(group){var group_position,option,_i,_len,_ref,_results;group_position=this.parsed.length;this.parsed.push({array_index:group_position,group:true,label:group.label,children:0,disabled:group.disabled});_ref=group.childNodes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){option=_ref[_i];_results.push(this.add_option(option,group_position,group.disabled));}
return _results;};SelectParser.prototype.add_option=function(option,group_position,group_disabled){if(option.nodeName==="OPTION"){if(option.text!==""){if(group_position!=null){this.parsed[group_position].children+=1;}
this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:option.value,text:option.text,html:option.innerHTML,selected:option.selected,disabled:group_disabled===true?group_disabled:option.disabled,group_array_index:group_position,classes:option.className,style:option.style.cssText});}else{this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:true});}
return this.options_index+=1;}};return SelectParser;})();SelectParser.select_to_array=function(select){var child,parser,_i,_len,_ref;parser=new SelectParser();_ref=select.childNodes;for(_i=0,_len=_ref.length;_i<_len;_i++){child=_ref[_i];parser.add_node(child);}
return parser.parsed;};this.SelectParser=SelectParser;}).call(this);(function(){var AbstractChosen,root;var __bind=function(fn,me){return function(){return fn.apply(me,arguments);};};root=this;AbstractChosen=(function(){function AbstractChosen(form_field,options){this.form_field=form_field;this.options=options!=null?options:{};this.set_default_values();this.is_multiple=this.form_field.multiple;this.default_text_default=this.is_multiple?"Select Some Options":"Select an Option";this.setup();this.set_up_html();this.register_observers();this.finish_setup();}
AbstractChosen.prototype.set_default_values=function(){this.click_test_action=__bind(function(evt){return this.test_active_click(evt);},this);this.activate_action=__bind(function(evt){return this.activate_field(evt);},this);this.active_field=false;this.mouse_on_container=false;this.results_showing=false;this.result_highlighted=null;this.result_single_selected=null;this.allow_single_deselect=(this.options.allow_single_deselect!=null)&&this.form_field.options[0].text===""?this.options.allow_single_deselect:false;this.disable_search_threshold=this.options.disable_search_threshold||0;this.choices=0;return this.results_none_found=this.options.no_results_text||"No results match";};AbstractChosen.prototype.mouse_enter=function(){return this.mouse_on_container=true;};AbstractChosen.prototype.mouse_leave=function(){return this.mouse_on_container=false;};AbstractChosen.prototype.input_focus=function(evt){if(!this.active_field){return setTimeout((__bind(function(){return this.container_mousedown();},this)),50);}};AbstractChosen.prototype.input_blur=function(evt){if(!this.mouse_on_container){this.active_field=false;return setTimeout((__bind(function(){return this.blur_test();},this)),100);}};AbstractChosen.prototype.result_add_option=function(option){var classes,style;if(!option.disabled){option.dom_id=this.container_id+"_o_"+option.array_index;classes=option.selected&&this.is_multiple?[]:["active-result"];if(option.selected){classes.push("result-selected");}
if(option.group_array_index!=null){classes.push("group-option");}
if(option.classes!==""){classes.push(option.classes);}
style=option.style.cssText!==""?" style=\""+option.style+"\"":"";return'<li id="'+option.dom_id+'" class="'+classes.join(' ')+'"'+style+'>'+option.html+'</li>';}else{return"";}};AbstractChosen.prototype.results_update_field=function(){this.result_clear_highlight();this.result_single_selected=null;return this.results_build();};AbstractChosen.prototype.results_toggle=function(){if(this.results_showing){return this.results_hide();}else{return this.results_show();}};AbstractChosen.prototype.results_search=function(evt){if(this.results_showing){return this.winnow_results();}else{return this.results_show();}};AbstractChosen.prototype.keyup_checker=function(evt){var stroke,_ref;stroke=(_ref=evt.which)!=null?_ref:evt.keyCode;this.search_field_scale();switch(stroke){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices>0){return this.keydown_backstroke();}else if(!this.pending_backstroke){this.result_clear_highlight();return this.results_search();}
break;case 13:evt.preventDefault();if(this.results_showing){return this.result_select(evt);}
break;case 27:if(this.results_showing){return this.results_hide();}
break;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search();}};AbstractChosen.prototype.generate_field_id=function(){var new_id;new_id=this.generate_random_id();this.form_field.id=new_id;return new_id;};AbstractChosen.prototype.generate_random_char=function(){var chars,newchar,rand;chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZ";rand=Math.floor(Math.random()*chars.length);return newchar=chars.substring(rand,rand+1);};return AbstractChosen;})();root.AbstractChosen=AbstractChosen;}).call(this);(function(){var Chosen,get_side_border_padding,root;var __hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key];}
function ctor(){this.constructor=child;}
ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child;},__bind=function(fn,me){return function(){return fn.apply(me,arguments);};};root=this;Chosen=(function(){__extends(Chosen,AbstractChosen);function Chosen(){Chosen.__super__.constructor.apply(this,arguments);}
Chosen.prototype.setup=function(){return this.is_rtl=this.form_field.hasClassName("chzn-rtl");};Chosen.prototype.finish_setup=function(){return this.form_field.addClassName("chzn-done");};Chosen.prototype.set_default_values=function(){Chosen.__super__.set_default_values.call(this);this.single_temp=new Template('<a href="javascript:void(0)" class="chzn-single"><span>#{default}</span><div><b></b></div></a><div class="chzn-drop" style="left:-9000px;"><div class="chzn-search"><input type="text" autocomplete="off" /></div><ul class="chzn-results"></ul></div>');this.multi_temp=new Template('<ul class="chzn-choices"><li class="search-field"><input type="text" value="#{default}" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chzn-drop" style="left:-9000px;"><ul class="chzn-results"></ul></div>');this.choice_temp=new Template('<li class="search-choice" id="#{id}"><span>#{choice}</span><a href="javascript:void(0)" class="search-choice-close" rel="#{position}"></a></li>');return this.no_results_temp=new Template('<li class="no-results">'+this.results_none_found+' "<span>#{terms}</span>"</li>');};Chosen.prototype.set_up_html=function(){var base_template,container_props,dd_top,dd_width,sf_width;this.container_id=this.form_field.identify().replace(/(:|\.)/g,'_')+"_chzn";this.f_width=this.form_field.getStyle("width")?parseInt(this.form_field.getStyle("width"),10):this.form_field.getWidth();container_props={'id':this.container_id,'class':"chzn-container"+(this.is_rtl?' chzn-rtl':''),'style':'width: '+this.f_width+'px'};this.default_text=this.form_field.readAttribute('data-placeholder')?this.form_field.readAttribute('data-placeholder'):this.default_text_default;base_template=this.is_multiple?new Element('div',container_props).update(this.multi_temp.evaluate({"default":this.default_text})):new Element('div',container_props).update(this.single_temp.evaluate({"default":this.default_text}));this.form_field.hide().insert({after:base_template});this.container=$(this.container_id);this.container.addClassName("chzn-container-"+(this.is_multiple?"multi":"single"));if(!this.is_multiple&&this.form_field.options.length<=this.disable_search_threshold){this.container.addClassName("chzn-container-single-nosearch");}
this.dropdown=this.container.down('div.chzn-drop');dd_top=this.container.getHeight();dd_width=this.f_width-get_side_border_padding(this.dropdown);this.dropdown.setStyle({"width":dd_width+"px","top":dd_top+"px"});this.search_field=this.container.down('input');this.search_results=this.container.down('ul.chzn-results');this.search_field_scale();this.search_no_results=this.container.down('li.no-results');if(this.is_multiple){this.search_choices=this.container.down('ul.chzn-choices');this.search_container=this.container.down('li.search-field');}else{this.search_container=this.container.down('div.chzn-search');this.selected_item=this.container.down('.chzn-single');sf_width=dd_width-get_side_border_padding(this.search_container)-get_side_border_padding(this.search_field);this.search_field.setStyle({"width":sf_width+"px"});}
this.results_build();return this.set_tab_index();};Chosen.prototype.register_observers=function(){this.container.observe("mousedown",__bind(function(evt){return this.container_mousedown(evt);},this));this.container.observe("mouseup",__bind(function(evt){return this.container_mouseup(evt);},this));this.container.observe("mouseenter",__bind(function(evt){return this.mouse_enter(evt);},this));this.container.observe("mouseleave",__bind(function(evt){return this.mouse_leave(evt);},this));this.search_results.observe("mouseup",__bind(function(evt){return this.search_results_mouseup(evt);},this));this.search_results.observe("mouseover",__bind(function(evt){return this.search_results_mouseover(evt);},this));this.search_results.observe("mouseout",__bind(function(evt){return this.search_results_mouseout(evt);},this));this.form_field.observe("liszt:updated",__bind(function(evt){return this.results_update_field(evt);},this));this.search_field.observe("blur",__bind(function(evt){return this.input_blur(evt);},this));this.search_field.observe("keyup",__bind(function(evt){return this.keyup_checker(evt);},this));this.search_field.observe("keydown",__bind(function(evt){return this.keydown_checker(evt);},this));if(this.is_multiple){this.search_choices.observe("click",__bind(function(evt){return this.choices_click(evt);},this));return this.search_field.observe("focus",__bind(function(evt){return this.input_focus(evt);},this));}};Chosen.prototype.search_field_disabled=function(){this.is_disabled=this.form_field.disabled;if(this.is_disabled){this.container.addClassName('chzn-disabled');this.search_field.disabled=true;if(!this.is_multiple){this.selected_item.stopObserving("focus",this.activate_action);}
return this.close_field();}else{this.container.removeClassName('chzn-disabled');this.search_field.disabled=false;if(!this.is_multiple){return this.selected_item.observe("focus",this.activate_action);}}};Chosen.prototype.container_mousedown=function(evt){var target_closelink;if(!this.is_disabled){target_closelink=evt!=null?evt.target.hasClassName("search-choice-close"):false;if(evt&&evt.type==="mousedown"){evt.stop();}
if(!this.pending_destroy_click&&!target_closelink){if(!this.active_field){if(this.is_multiple){this.search_field.clear();}
document.observe("click",this.click_test_action);this.results_show();}else if(!this.is_multiple&&evt&&(evt.target===this.selected_item||evt.target.up("a.chzn-single"))){this.results_toggle();}
return this.activate_field();}else{return this.pending_destroy_click=false;}}};Chosen.prototype.container_mouseup=function(evt){if(evt.target.nodeName==="ABBR"){return this.results_reset(evt);}};Chosen.prototype.blur_test=function(evt){if(!this.active_field&&this.container.hasClassName("chzn-container-active")){return this.close_field();}};Chosen.prototype.close_field=function(){document.stopObserving("click",this.click_test_action);if(!this.is_multiple){this.selected_item.tabIndex=this.search_field.tabIndex;this.search_field.tabIndex=-1;}
this.active_field=false;this.results_hide();this.container.removeClassName("chzn-container-active");this.winnow_results_clear();this.clear_backstroke();this.show_search_field_default();return this.search_field_scale();};Chosen.prototype.activate_field=function(){if(!this.is_multiple&&!this.active_field){this.search_field.tabIndex=this.selected_item.tabIndex;this.selected_item.tabIndex=-1;}
this.container.addClassName("chzn-container-active");this.active_field=true;this.search_field.value=this.search_field.value;return this.search_field.focus();};Chosen.prototype.test_active_click=function(evt){if(evt.target.up('#'+this.container_id)){return this.active_field=true;}else{return this.close_field();}};Chosen.prototype.results_build=function(){var content,data,startTime,_i,_len,_ref;startTime=new Date();this.parsing=true;this.results_data=root.SelectParser.select_to_array(this.form_field);if(this.is_multiple&&this.choices>0){this.search_choices.select("li.search-choice").invoke("remove");this.choices=0;}else if(!this.is_multiple){this.selected_item.down("span").update(this.default_text);}
content='';_ref=this.results_data;for(_i=0,_len=_ref.length;_i<_len;_i++){data=_ref[_i];if(data.group){content+=this.result_add_group(data);}else if(!data.empty){content+=this.result_add_option(data);if(data.selected&&this.is_multiple){this.choice_build(data);}else if(data.selected&&!this.is_multiple){this.selected_item.down("span").update(data.html);if(this.allow_single_deselect){this.single_deselect_control_build();}}}}
this.search_field_disabled();this.show_search_field_default();this.search_field_scale();this.search_results.update(content);return this.parsing=false;};Chosen.prototype.result_add_group=function(group){if(!group.disabled){group.dom_id=this.container_id+"_g_"+group.array_index;return'<li id="'+group.dom_id+'" class="group-result">'+group.label.escapeHTML()+'</li>';}else{return"";}};Chosen.prototype.result_do_highlight=function(el){var high_bottom,high_top,maxHeight,visible_bottom,visible_top;this.result_clear_highlight();this.result_highlight=el;this.result_highlight.addClassName("highlighted");maxHeight=parseInt(this.search_results.getStyle('maxHeight'),10);visible_top=this.search_results.scrollTop;visible_bottom=maxHeight+visible_top;high_top=this.result_highlight.positionedOffset().top;high_bottom=high_top+this.result_highlight.getHeight();if(high_bottom>=visible_bottom){return this.search_results.scrollTop=(high_bottom-maxHeight)>0?high_bottom-maxHeight:0;}else if(high_top<visible_top){return this.search_results.scrollTop=high_top;}};Chosen.prototype.result_clear_highlight=function(){if(this.result_highlight){this.result_highlight.removeClassName('highlighted');}
return this.result_highlight=null;};Chosen.prototype.results_show=function(){var dd_top;if(!this.is_multiple){this.selected_item.addClassName('chzn-single-with-drop');if(this.result_single_selected){this.result_do_highlight(this.result_single_selected);}}
dd_top=this.is_multiple?this.container.getHeight():this.container.getHeight()-1;this.dropdown.setStyle({"top":dd_top+"px","left":0});this.results_showing=true;this.search_field.focus();this.search_field.value=this.search_field.value;return this.winnow_results();};Chosen.prototype.results_hide=function(){if(!this.is_multiple){this.selected_item.removeClassName('chzn-single-with-drop');}
this.result_clear_highlight();this.dropdown.setStyle({"left":"-9000px"});return this.results_showing=false;};Chosen.prototype.set_tab_index=function(el){var ti;if(this.form_field.tabIndex){ti=this.form_field.tabIndex;this.form_field.tabIndex=-1;if(this.is_multiple){return this.search_field.tabIndex=ti;}else{this.selected_item.tabIndex=ti;return this.search_field.tabIndex=-1;}}};Chosen.prototype.show_search_field_default=function(){if(this.is_multiple&&this.choices<1&&!this.active_field){this.search_field.value=this.default_text;return this.search_field.addClassName("default");}else{this.search_field.value="";return this.search_field.removeClassName("default");}};Chosen.prototype.search_results_mouseup=function(evt){var target;target=evt.target.hasClassName("active-result")?evt.target:evt.target.up(".active-result");if(target){this.result_highlight=target;return this.result_select(evt);}};Chosen.prototype.search_results_mouseover=function(evt){var target;target=evt.target.hasClassName("active-result")?evt.target:evt.target.up(".active-result");if(target){return this.result_do_highlight(target);}};Chosen.prototype.search_results_mouseout=function(evt){if(evt.target.hasClassName('active-result')||evt.target.up('.active-result')){return this.result_clear_highlight();}};Chosen.prototype.choices_click=function(evt){evt.preventDefault();if(this.active_field&&!(evt.target.hasClassName('search-choice')||evt.target.up('.search-choice'))&&!this.results_showing){return this.results_show();}};Chosen.prototype.choice_build=function(item){var choice_id,link;choice_id=this.container_id+"_c_"+item.array_index;this.choices+=1;this.search_container.insert({before:this.choice_temp.evaluate({id:choice_id,choice:item.html,position:item.array_index})});link=$(choice_id).down('a');return link.observe("click",__bind(function(evt){return this.choice_destroy_link_click(evt);},this));};Chosen.prototype.choice_destroy_link_click=function(evt){evt.preventDefault();if(!this.is_disabled){this.pending_destroy_click=true;return this.choice_destroy(evt.target);}};Chosen.prototype.choice_destroy=function(link){this.choices-=1;this.show_search_field_default();if(this.is_multiple&&this.choices>0&&this.search_field.value.length<1){this.results_hide();}
this.result_deselect(link.readAttribute("rel"));return link.up('li').remove();};Chosen.prototype.results_reset=function(evt){this.form_field.options[0].selected=true;this.selected_item.down("span").update(this.default_text);this.show_search_field_default();evt.target.remove();if(typeof Event.simulate==='function'){this.form_field.simulate("change");}
if(this.active_field){return this.results_hide();}};Chosen.prototype.result_select=function(evt){var high,item,position;if(this.result_highlight){high=this.result_highlight;this.result_clear_highlight();if(this.is_multiple){this.result_deactivate(high);}else{this.search_results.descendants(".result-selected").invoke("removeClassName","result-selected");this.result_single_selected=high;}
high.addClassName("result-selected");position=high.id.substr(high.id.lastIndexOf("_")+1);item=this.results_data[position];item.selected=true;this.form_field.options[item.options_index].selected=true;if(this.is_multiple){this.choice_build(item);}else{this.selected_item.down("span").update(item.html);if(this.allow_single_deselect){this.single_deselect_control_build();}}
if(!(evt.metaKey&&this.is_multiple)){this.results_hide();}
this.search_field.value="";if(typeof Event.simulate==='function'){this.form_field.simulate("change");}
return this.search_field_scale();}};Chosen.prototype.result_activate=function(el){return el.addClassName("active-result");};Chosen.prototype.result_deactivate=function(el){return el.removeClassName("active-result");};Chosen.prototype.result_deselect=function(pos){var result,result_data;result_data=this.results_data[pos];result_data.selected=false;this.form_field.options[result_data.options_index].selected=false;result=$(this.container_id+"_o_"+pos);result.removeClassName("result-selected").addClassName("active-result").show();this.result_clear_highlight();this.winnow_results();if(typeof Event.simulate==='function'){this.form_field.simulate("change");}
return this.search_field_scale();};Chosen.prototype.single_deselect_control_build=function(){if(this.allow_single_deselect&&!this.selected_item.down("abbr")){return this.selected_item.down("span").insert({after:"<abbr class=\"search-choice-close\"></abbr>"});}};Chosen.prototype.winnow_results=function(){var found,option,part,parts,regex,result_id,results,searchText,startTime,startpos,text,zregex,_i,_j,_len,_len2,_ref;startTime=new Date();this.no_results_clear();results=0;searchText=this.search_field.value===this.default_text?"":this.search_field.value.strip().escapeHTML();regex=new RegExp('^'+searchText.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),'i');zregex=new RegExp(searchText.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),'i');_ref=this.results_data;for(_i=0,_len=_ref.length;_i<_len;_i++){option=_ref[_i];if(!option.disabled&&!option.empty){if(option.group){$(option.dom_id).hide();}else if(!(this.is_multiple&&option.selected)){found=false;result_id=option.dom_id;if(regex.test(option.html)){found=true;results+=1;}else if(option.html.indexOf(" ")>=0||option.html.indexOf("[")===0){parts=option.html.replace(/\[|\]/g,"").split(" ");if(parts.length){for(_j=0,_len2=parts.length;_j<_len2;_j++){part=parts[_j];if(regex.test(part)){found=true;results+=1;}}}}
if(found){if(searchText.length){startpos=option.html.search(zregex);text=option.html.substr(0,startpos+searchText.length)+'</em>'+option.html.substr(startpos+searchText.length);text=text.substr(0,startpos)+'<em>'+text.substr(startpos);}else{text=option.html;}
if($(result_id).innerHTML!==text){$(result_id).update(text);}
this.result_activate($(result_id));if(option.group_array_index!=null){$(this.results_data[option.group_array_index].dom_id).show();}}else{if($(result_id)===this.result_highlight){this.result_clear_highlight();}
this.result_deactivate($(result_id));}}}}
if(results<1&&searchText.length){return this.no_results(searchText);}else{return this.winnow_results_set_highlight();}};Chosen.prototype.winnow_results_clear=function(){var li,lis,_i,_len,_results;this.search_field.clear();lis=this.search_results.select("li");_results=[];for(_i=0,_len=lis.length;_i<_len;_i++){li=lis[_i];_results.push(li.hasClassName("group-result")?li.show():!this.is_multiple||!li.hasClassName("result-selected")?this.result_activate(li):void 0);}
return _results;};Chosen.prototype.winnow_results_set_highlight=function(){var do_high;if(!this.result_highlight){if(!this.is_multiple){do_high=this.search_results.down(".result-selected.active-result");}
if(!(do_high!=null)){do_high=this.search_results.down(".active-result");}
if(do_high!=null){return this.result_do_highlight(do_high);}}};Chosen.prototype.no_results=function(terms){return this.search_results.insert(this.no_results_temp.evaluate({terms:terms}));};Chosen.prototype.no_results_clear=function(){var nr,_results;nr=null;_results=[];while(nr=this.search_results.down(".no-results")){_results.push(nr.remove());}
return _results;};Chosen.prototype.keydown_arrow=function(){var actives,nexts,sibs;actives=this.search_results.select("li.active-result");if(actives.length){if(!this.result_highlight){this.result_do_highlight(actives.first());}else if(this.results_showing){sibs=this.result_highlight.nextSiblings();nexts=sibs.intersect(actives);if(nexts.length){this.result_do_highlight(nexts.first());}}
if(!this.results_showing){return this.results_show();}}};Chosen.prototype.keyup_arrow=function(){var actives,prevs,sibs;if(!this.results_showing&&!this.is_multiple){return this.results_show();}else if(this.result_highlight){sibs=this.result_highlight.previousSiblings();actives=this.search_results.select("li.active-result");prevs=sibs.intersect(actives);if(prevs.length){return this.result_do_highlight(prevs.first());}else{if(this.choices>0){this.results_hide();}
return this.result_clear_highlight();}}};Chosen.prototype.keydown_backstroke=function(){if(this.pending_backstroke){this.choice_destroy(this.pending_backstroke.down("a"));return this.clear_backstroke();}else{this.pending_backstroke=this.search_container.siblings("li.search-choice").last();return this.pending_backstroke.addClassName("search-choice-focus");}};Chosen.prototype.clear_backstroke=function(){if(this.pending_backstroke){this.pending_backstroke.removeClassName("search-choice-focus");}
return this.pending_backstroke=null;};Chosen.prototype.keydown_checker=function(evt){var stroke,_ref;stroke=(_ref=evt.which)!=null?_ref:evt.keyCode;this.search_field_scale();if(stroke!==8&&this.pending_backstroke){this.clear_backstroke();}
switch(stroke){case 8:return this.backstroke_length=this.search_field.value.length;case 9:return this.mouse_on_container=false;case 13:return evt.preventDefault();case 38:evt.preventDefault();return this.keyup_arrow();case 40:return this.keydown_arrow();}};Chosen.prototype.search_field_scale=function(){var dd_top,div,h,style,style_block,styles,w,_i,_len;if(this.is_multiple){h=0;w=0;style_block="position:absolute; left: -1000px; top: -1000px; display:none;";styles=['font-size','font-style','font-weight','font-family','line-height','text-transform','letter-spacing'];for(_i=0,_len=styles.length;_i<_len;_i++){style=styles[_i];style_block+=style+":"+this.search_field.getStyle(style)+";";}
div=new Element('div',{'style':style_block}).update(this.search_field.value.escapeHTML());document.body.appendChild(div);w=Element.measure(div,'width')+25;div.remove();if(w>this.f_width-10){w=this.f_width-10;}
this.search_field.setStyle({'width':w+'px'});dd_top=this.container.getHeight();return this.dropdown.setStyle({"top":dd_top+"px"});}};return Chosen;})();root.Chosen=Chosen;if(Prototype.Browser.IE){if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){Prototype.BrowserFeatures['Version']=new Number(RegExp.$1);}}
get_side_border_padding=function(elmt){var layout,side_border_padding;layout=new Element.Layout(elmt);return side_border_padding=layout.get("border-left")+layout.get("border-right")+layout.get("padding-left")+layout.get("padding-right");};root.get_side_border_padding=get_side_border_padding;}).call(this);